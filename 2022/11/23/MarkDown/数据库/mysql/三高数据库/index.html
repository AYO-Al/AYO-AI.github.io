<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>三高MySQL | AYO</title><meta name="keywords" content="Database,MySQL,三高MySQL"><meta name="author" content="AYO,2609320892@qq.com"><meta name="copyright" content="AYO"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="三高MySQL"><meta name="application-name" content="三高MySQL"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="三高MySQL"><meta property="og:url" content="https://ayo-al.github.io/2022/11/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E4%B8%89%E9%AB%98%E6%95%B0%E6%8D%AE%E5%BA%93/index.html"><meta property="og:site_name" content="AYO"><meta property="og:description" content="本文介绍了三高MySQL的相关知识。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://th.bing.com/th/id/OIP.IV7LvR2MoBb3y-EKG9uAJAHaEK?rs=1&amp;pid=ImgDetMain&amp;_r_=f928203e-103d-7086-6e45-a5d8e527fe19"><meta property="article:author" content="AYO"><meta property="article:tag" content=""><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://th.bing.com/th/id/OIP.IV7LvR2MoBb3y-EKG9uAJAHaEK?rs=1&amp;pid=ImgDetMain&amp;_r_=f928203e-103d-7086-6e45-a5d8e527fe19"><meta name="description" content="本文介绍了三高MySQL的相关知识。"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://ayo-al.github.io/2022/11/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E4%B8%89%E9%AB%98%E6%95%B0%E6%8D%AE%E5%BA%93/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.yuki.love',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: undefined,
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: {"appId":"XMRZIUY8NL","apiKey":"187af2610e1cc500c95dc8b8f3a53d0e","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: AYO","link":"链接: ","source":"来源: AYO","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'AYO',
  title: '三高MySQL',
  postAI: '',
  pageFillDescription: '第一章：介绍, 1.概述, 第二章：SQL语句是这样执行的, 1.软件经典架构, 2.MYSQL软件架构, 3.客户端与mysql的连接方式, 4.一个SQL语句时怎么执行的, 5.MYSQL存储引擎, 第三章：如何建表更符合业务, 1.索引组织表, 2.索引所使用的的算法, 3.InnoDB索引, 4.InnoDB数据存储, 5.InnoDB的数据行, 6.InnoDB行记录格式, 7.索引有哪些左侧用法, 8.如何约束数据, 9.如何使用不存在的数据表, 第四章：这么查询速度更快, 1.where查询太慢怎么办, 1.1.覆盖索引, *索引解释详情, 2.有更合适的索引不走怎么办？, 2.1.如何确定用那条索引, 2.2.强制使用索引, 2.3.优化索引, 3.Count这么慢怎么办, 4.ORDER BY这么慢怎么办, 5.随机选取这么慢怎么办, 6.带头大哥丢了怎么办, 6.1.索引下推, 6.2.松散索引扫描, 7.明明有索引就是不走怎么办, 7.1.字符串与数字比较, 7.2.隐式字符编码转换, 8.分页查询这么慢这么办, 9.总结, 第五章：如何处理数据更新, 1. 数据库动起来之后会发生什么, 2.什么日志不是给人看的, 2.1.binlog 归档日志, 2.2.undo log 回滚日志, 2.3.redo log 重做日志, 3.数据更新流程, 3.1.redo log 刷盘, 3.2.binlog 刷盘, 3.3.持久化分析, 4.锁：怎样平衡功能与性能, 5.事务：InnoDB的杀手锏, 6.隔离级别, 7.MVCC是怎样做到千人千面的, 7.1.快照读(一致性非锁定读), 7.2.当前读(一致性锁定读), 8.隔离问题, 8.1.如何解决幻读问题, 9.间隙锁把全表都锁住了怎么办, 10.MySQL也有垃圾回收嘛, 10.1.脏页, 11.长事务有哪些危害, 第六章：ORM框架原理, 1.ORM基础, 2.ORM框架是怎么设计的, 3.ORM框架有哪些常见问题, 第七章：怎么给数据上保险, 1.数据库有哪些种类的备份？, 2.使用OUTFILE命令备份, 3.使用mysqldump进行备份, 4.如何使用mysqldump增量备份, 5.使用XtraBackup物理备份, 6.ibbackup与XtraBackup, 7.MySQL备份工具如何指导我们的创新, 8.如何防患于未然, 第八章：三高框架基础, 1.复制有哪些类型？, 2.主从复制, 3.为什么binlog格式会影响复制？, 4.备库延迟太大怎么办？, 5.如何在备库读到最新数据, 6.怎样实现最简单的高可用架构, 第九章：如何解决容量不够的问题, 1.怎样最简单的扩展容量？, 2.为什么要分库分表？, 3.dble比MyCat强在哪？, 4.安装使用dble, 5.怎样提高分库分表架构的可靠性, 6.分库分表之后性能反而下降怎么办？, 第十章：如何解决数据库经常宕机问题, 1.切换：保业务还是保数据, 2.数据库切换了业务怎么办？, 3.如何实现自动主从切换？, 4.MHA自动主从切换实战, 5.高可用了集群为什么还会挂？, 第十一章：未来的数据库怎么样, 1.MySQL 8.0体验什么新特性？, 2.数据库有哪些分类, 3.谁是单体数据库之王？, 4.MySQL能魔改成什么样？, 5.国产数据库第一章介绍概述什么是三高数据库高并发同时处理的事物数高高性能事物的执行速度高高可用系统可用时间高实现三高的手段复制目的数据冗余手段传送收获并发量提升可用性提高问题占用更多硬件资源扩展目的扩展数据库容量手段数据库分片分库分表收获性能并发量的提升问题可能减低可用性切换目的提高可用性手段主从身份切换收获并发量的提升问题丢失切换时期数据三高实现高并发通过复制和扩展将数据分散至多节点高性能复制提升速度扩展提升容量高可用节点间身份切换保证随时可用如何提升单点性能建表表结构合理索引高效查询优化语句选择正确索引更新正确使用锁合理优化事务为什么有了表格还需要数据库数据库理论上没有行数上限单机数据库若行数太多遇到性能问题可以通过分库分表等技术解决数据库有结构化查询语言是文件级别的直接面向终端用户而数据库面向软件提供软件接口没有事务无法做到不同人的工作同时进行数据库事务是关系型数据库的核心优势是单体的面向文件的数据库具有主备复制高可用分布式等形态第二章语句是这样执行的软件经典架构分层架构事件驱动架构管道过滤器架构微核架构软件架构软件工程当中有很多经典的架构设计大型软件往往不是使用单一的架构设计而是多种混合研究问题要有清晰的视野分清微观和宏观客户端与的连接方式连接命名管道同一台服务器通讯共享内存客户端和服务端通过一片内存交互域套接字连接连接是在任何平台上都提供的连接方法三次握手建立连接认证连接认证通过之后客户端开始与服务端之间交互四次挥手断开连接通讯协议认证连接服务端客户端发送握手初始化包客户端服务端发送验证服务端客户端认证结果消息报文格式消息头字节报文长度字节序号消息体字节指令其余为参数一个语句时怎么执行的连接器监听客户端的请求查询缓存之前执行过的语句会的形式缓存在内存中查询之前先查找之前执行过的相同语句不推荐使用缓存数据表修改后会删除所有相关缓存分析器分析器的作用是知道你要干什么先做词法分析识别语句中的关键字再做句法分析判断语句是否符合语法优化器优化器的作用是要知道怎么做优化器的主要工作时决定如何使用索引执行器执行器的主要工作是校验权限调用存储引擎执行器首先校验从用户对目标数据有无权限执行器会以行为粒度调用存储引擎执行在没有索引情况下执行器会循环查询所有行存储引擎任务时将执行器的指令落实在数据文件上不同存储引擎原理和执行方法有很大不同语句执行的过程涉及到了几乎所有的模块一个语句是按照分析优化执行落盘的步骤执行的之后已经停用了缓存功能存储引擎之前的默认存储引擎插入数据快空间利用率高不支持事物之后的默认存储引擎支持事物外键支持崩溃修复能力和并发控制所有的数据都在内存中速度快数据安全性差数据压缩空间利用率高插入速度快不支持索引查询性能差是目前最流行的存储引擎适合各种互联网业务查询效率要求非常高可以考虑日志信息归档可以考虑临时表可以考虑第三章如何建表更符合业务索引组织表索引组织表不是一种组织表索引组织表是由索引组织起来的表中表都是根据主键顺序组织存放的索引索引是数据库中对某一列或多个列的值进行预排序的数据结构索引可以理解为数据的目录中主键是一个特殊索引字段主键存储引擎表中每张表都有一个主键若表中有一个非空唯一索引即为主键若有多个非空唯一索引选择第一个定义的索引若无自动创建一个字节的指针作为主键索引所使用的的算法主流索引查找算法线性查找二分查找二叉查找树平衡二叉树树树线性查找时间复杂度从第一个数据开始逐个匹配二分查找时间复杂度拿出有序数列中点位置作为比较对象根据中点数据大小选取一半数据作为新的数列每次可以将数据量减少一半二叉查找树时间复杂度使用经典的二叉树数据结构由根节点开始查找可能会退化为线性查找平衡二叉树时间复杂度查找时跟二叉搜索树相同增删改时通过旋转操作维护树的平衡可以保证不会退化成线性查找树树是线性数据结构和树的结合树通过多数据节点大大降低了树的高度数不需要旋转就可以保证树的平衡树是由树发展而来的树的所有数据均在叶子节点数的所有数据形成了一个线性表树是目前最主流的数据库索引算法法由线性表二叉树树发展而来树集成了线性表平衡二叉树的优势索引树索引使用树作为索引的数据结构树的高度一般为层查找速度非常快索引分为聚簇索引主索引和辅助索引聚簇索引根据表的主键构造一个树叶子节点直接存放数据而不是指针索引组织表中数据也是树的一部分辅助索引每张表可以有多个辅助索引叶子节点并不包含行数据叶子节点记录了行数据的主键用来指示数据位置采用辅助索引只能查到主键数据然后通过主键再次进行查找这种行为称为回表索引分为聚簇索引和辅助索引在同层树节点之间为双向链表在树节点之内数据条目之间为单向链表所谓索引即数据是把数据直接记录在主索引中数据存储逻辑存储结构表空间表空间指的是数据表在硬盘上的存储空间默认所有表的数据都存在共享表空间每个表的数据也可以放在独占表空间文件段数据段树的叶子节点索引段树的非叶子节点中段由存储引擎自动管理区区是由连续页组成的空间大小为一次从磁盘申请个区一般含有个页页页是中磁盘读写的最小逻辑单位默认是一个数据页就是一个数节点页的大小充分考虑了机械硬盘和的最小单元和的逻辑存储结构为表空间段区页行的逻辑存储结构充分考虑了以基于树的表结构的页是自身的概念逻辑与硬件的页无关为什么页不能太大因为页是读写的最小逻辑单位读取太大对硬盘的压力过大一次读取的数据可能很小所以如果页过大就会导致取出太多垃圾数据增加内存负担页结构里是一个链表页的内存太大会导致页中数据过多导致查询困难为什么页不能太小因为要考虑机械硬盘和的最小单元的数据行中的变长列长度不固定的数据类型占用空间大于的类型变长编码下的行溢出数据由于每个数据页容量有限导致数据字段也是有限的当数据字段过大时会使用行溢出机制行溢出机制会把超长字段放入单独开辟的数据页行记录格式行记录格式主要分为两个时代文件格式文件格式之前的默认之前的默认之后默认变长字段长度表标志位每个变长字段的长度按照列的顺序逆序放置指示行记录中的值每个代表一个字段列数量下一行记录的指针等信息没有可用主键时使用作为隐藏主键事务回滚指针未溢出的数据小于数据长度大于则只记录一个指针在基础上对表的数据行使用算法进行了压缩存储可以节约左右空间但对的压力较大行记录格式经历了两个时代四种类型行记录格式化的核心需求是节约行记录空间节约行记录空间从而增加每个页的数据行数提高查询效率索引有哪些左侧用法联合索引使用两个或以上字段生成的索引联合索引可以加速最左前缀的查询联合索引可以代替最左侧字段的单独索引带头大哥不能死中间兄弟不能丢联合索引的树结构上述树数据字符串的前缀索引如果字符串过长可以考虑使用前缀索引节约空间如果前缀区分度太小可以考虑两种变通方法如果前缀相同倒叙存储如果前后缀都相同新建字段新增前缀索引语句字符串关键字关键字会使索引失效关键字左模糊才可以使用索引有很多左侧用法联合索引可以代替最左侧字段的单独索引字符串的前缀索引可以节约磁盘空间字符串左模糊可以有效利用索引如何约束数据约束数据的方法触发器唯一不为空唯一唯一约束插入时的性能开销较大外键可以对数据的正确性实现约束数据默认值数据不为空触发器插入修改数据时使用触发器校验数据容易干扰业务使用很少有多重约束数据方法将数据设置为索引字段快银约束数据的唯一性但开销较大外键可以对数据有效性进行校验的行为可能收到参数的影响如何使用不存在的数据表视图使用视图可以创建不存在的虚拟表视图的原理是预设一个语句语句的查询结构作为虚拟表的数据视图算法的选择将视图合并到主查询中将视图作临时表中间结果来处理一般来讲的性能优于无法使用的聚集函数子查询视图可以在不改变原有数据的情况下创建虚拟表尽量使用视图算法尽量不使用无法使用的语句第四章这么查询速度更快查询太慢怎么办覆盖索引查询语句从执行到返回结果均使用同一个索引覆盖索引可以有效减少回表索引解释详情使用了覆盖索引覆盖索引通过取消回表操作提升查询效率如数据的查询不只使用了一个索引则不是覆盖索引可以通过优化语句或优化联合索引来使用覆盖索引有更合适的索引不走怎么办如何确定用那条索引在选取索引时会考虑索引的基数查看各个索引的基数基数是估算的反映这个字段有多少种取值怎么估算的选取几个页算出取值的平均值再乘以页数即为基数当在选择索引的时候会选择基数更大的那一条索引强制使用索引的基数估算是有可能出错的这个时候我们可以强制指定要使用的索引索引名优化索引当基数估计出错的时候也不想使用强制索引这个时候可以让重新估计基数表名可以重新统计索引信息重新统计索引信息时会重新计算索引的基数根据索引基数可以判断索引性能的好坏使用可以强制使用索引可以重新统计索引信息修复基数信息这么慢怎么办函数用来统计结果集中不为的数据个数步骤首先存储引擎查询出结果集层逐个判断是否为不为则加一非索引字段时层需要判断每个数据是否为而且查询本身无法使用覆盖索引理论上最慢索引字段时可以使用覆盖索引依然需要每次判断字段是否为主键时同理时只扫描了索引树没有解析数据行的过程理论更快但层依然每次需要判断是否为空一般用来返回数据表行数的直接返回数据库中记录的数据表行数由于支持事物数据库中不记录数据表行数专门优化了函数直接返回索引树中数据的个数非索引字段无法使用覆盖索引最慢索引字段可以使用覆盖索引但依然要去除数据判空不需要去除数据但要判断是否为空经过专门优化不需要判空理论最快这么慢怎么办步骤原理例如根据等条件查询将查询结果放入专门用于排序的缓存对中间结果集按照字段排序回表生成完整结果集若需要优化步骤条件查询给查询字段加索引改善条件查询速度中间结果集中间表比较小时直接放在内存中比较大与时会放在硬盘中若需要优化内存占用减少若需要优化排序查询时间增加回表生成完整结果集当行小于时生成全字段结果集当行大于时只生成排序字段主键中间表需要回表调大阈值并不一定改善效率因为太大的结果集排序效率低最高效索引覆盖索引覆盖可以跳过生成中间结果集直接输出查询结果字段需要有索引或在联合索引左侧和查询条件索引一致其他相关字段条件输出均在上述的索引中满足以上条件即可使用索引覆盖中间结果集是一个临时表不存在任何索引但是满足条件可以使用索引覆盖一般需要生成中间结果集排序回表的过程索引覆盖式最高效的处理排序的方式随机选取这么慢怎么办输出一个的随机值原理例如创建一个临时表临时表的字段为从表中取出一行调用将结果和数据放入临时表依次类推针对临时表将字段行位置主键放入如果临时表为内存表则有行位置如果为磁盘表则有主键临时表对排序取出第一个的行位置主键查询临时表为什么会慢执行过程中出现了两次中间结果都是全长度的仅需要一个随机结果却经历了不必要的排序虽然优化过调用了很多次优化临时方案设置的最大值和最小值的变量给最大值和最小值中间随机取出的数赋给变量在大于随机值中取出第一个因为可能中间数据不连续业务方案查询数据表总数范围内随机选取一个数字执行一下是效率很低的随机查询方式原因主要是上述方法有两次中间结果还有排序过程可以通过修改选取随机主键方式提升性能最好还是在业务中处理尽量减少复杂带头大哥丢了怎么办索引下推建表语句与插入语句查询语句之前需要先使用索引查询再全部回表验证在之后如果索引中可以判断直接使用索引过滤松散索引扫描查询语句丢失带头大哥不能走联合索引松散扫描新特性在中使用上述查询语句可以使用松散索引扫描大大减少扫描行数松散索引扫描在松散索引扫描中也是走联合索引例如上述表中使用松散索引扫描先在确定例如在中扫描字段因为这两个字段是联合索引所以只要带头大哥确认字段就能有序更好查找能有效减少扫描行数联合索引可以加速一些特殊查询场景索引下推可以大大减少回表次数松散索引扫描可以打破左侧原则解决带头大哥丢失问题明明有索引就是不走怎么办不会走索引全表扫描对函数字段做函数操作优化器会放弃索引使用函数后无法使用索引如果需要查询时间需要去掉字符串与数字比较中若出现字符串与数字比较会将字符串转换为数字如果表中字段为类型则此相当于强制转换为类型把数字强转为字符串解决方案把换成隐式字符编码转换建表建表注意字符集不一样插入相关数据进行查询结果按说确认表行数据后再对表数据查询字段会进行索引查询为什么会按照全表查询中与字段比较时会把转为相当于解决方案将查询条件转换为索引字段的编码结果中对索引字段做函数操作优化器会放弃索引这种情况可能包括时间函数字符串转数字字符编码转换解决方案时间函数转区间数字强转字符串高级编码转低级分页查询这么慢这么办偏移量大时效率低例如执行前面的语句在执行操作丢弃很多无用数据效率低下优化策略先想办法走索引覆盖得到所需数据的根据所需数据的得到最终结果集优化语句得到所需数据的主键原表与上面的结果链表获取最终结果排序偏移量大时会丢弃大量无用数据导致效率低下当索引不可随便改动时可以采用先索引覆盖再用最终回表的方法优化效率总结慢查询的怀疑方向索引设计有问题语句有问题数据库选错索引第五章如何处理数据更新数据库动起来之后会发生什么产生日志数据数据库在更新时会产生层产生的逻辑日志产生的物理日志保证持久化产生的逻辑日志保证隔离性原子性客户端之间因为锁而相互影响客户端执行时会产生各种行锁表锁原数据锁一个客户端产生的锁会干扰其他客户端的执行两个客户端之间可能产生死锁事务造成查询到的数据与磁盘上不一致客户顿可能暂时看不到已经更新的数据事务可能产生隐式锁造成性能问题数据库动起来之后会产生一系列性能问题需要理解日志锁事务的底层原理才能应对问题什么日志不是给人看的日志体系为了满足主从复制事务等有复杂的日志体系层产生用来进行数据复制产生用来实现事务归档日志是层产生的逻辑日志用来进行数据复制和数据传送完整记录了数据库每次的数据操作可作为数据闪回手段回滚日志自身产生的逻辑日志用于事务回滚和展示旧版本对任何数据缓存的更新都先写位于表空间的中记录相反的数据变化情况重做日志自身产生的物理日志记录数据页的变化日志优先于数据记录视为数据已经更新内存中的数据更新后写数据被写入硬盘后删除存储在个文件中并且循环写入数据更新流程刷盘参数控制刷盘异步每秒刷盘每一个事务刷盘没个事务刷盘建议设置为保证数据安全刷盘参数控制刷盘异步每秒刷盘每一个事务刷盘没个事务刷盘建议设置为保证数据安全持久化分析刷盘前系统崩溃数据丢失刷盘后系统崩溃重启时会对进行重写重写内存中数据页重写为什么在之前是系统关键节点相当于决断点一旦写入无法撤回因为可能已经被传送至备库日志主要由实行日志优先的策略日志刷盘数据就不会丢失锁怎样平衡功能与性能锁的种类按照粒度锁可以分为全局锁表级锁行锁全局锁会锁住整个库整个库无法修改表级锁分为表锁数据锁和元数据锁行锁会锁住数据行分为共享锁和独占锁全局锁此命令使整个库处于只读状态主要用途是保证备份的一致性不要随意使用杀伤性极大要在备库中使用表级锁数据锁命令表名表锁是非常重的表在中使用很少元数据锁元数据指的是表的结构字段数据类型索引等事务访问数据时会自动给表加读锁事务修改元数据时会自动给表加写锁修改完会自动释放行锁行锁也有两种类型有很多其他叫法读锁写锁共享锁排它锁共享锁独占锁锁锁锁不是不让读而是自己要读不让别人写锁不只是不让写而是自己要写不让别人读写只有锁和锁之间可以兼容其他均不兼容锁是高效率执行事务的必备基础锁会引发很多的性能问题可能造成等待和死锁锁还会引发很多的功能问题如脏读和不可重复读等事务的杀手锏事务的特性原子性一致性隔离性持久性原子性事务要么全部成功要么全部失败的两阶段提交保证了事务的原子性用来回滚事务的更改一致性事务必须使数据库从一个一致性状态变换到另一个一致性状态锁和两阶段提交保证了一致性隔离性事务不能被其他事物的操作数据所干扰多个并发事务之间要相互隔离锁和实现了事务的隔离性持久性一个事物一旦被提交它对数据库中数据的改变就是永久的实现了事务的持久性隔离级别查看隔离级别设置全局的隔离级别隔离级别名称设置会话级别隔离隔离级别设置一次操作的级别隔离级别隔离级别读未提交读提交可重复度串行化读未提交读写都不加锁不隔离每次查询都查询到数据的最新版本性能最好但是等于没有事务很少采用读提交一般读取时读取此时已经提交的数据写数据时加锁提交时释放默认隔离级别可重复度一般读取时读取本事务开始时的数据状态写数据时加锁提交时释放默认的隔离级别串行化读加锁写加锁提交时释放对于一条数据同时只能有一个事物进行写操作事物隔离性最高性能太差很少采用事物是最核心的功能点事物也是引发性能问题最多的点读提交和可重复读是如何查询到历史版本的需要提交是怎样做到千人千面的是多版本并发控制的缩写它是一种并发控制的方法一般在数据库管理系统中实现对数据库的并发访问行记录的版本控制由于的存在可以从最新版本推算之前版本快照读一致性非锁定读不锁定数据的情况下读取数据的特定历史版本版本由事务的具体需求确定读已提交根据每次时其他事物的提交情况可持续读根据事务开始时其他事物的提交情况当前读一致性锁定读读取数据的当前版本并加锁串行化都是当前读若当前版本已经被加锁且不兼容则阻塞等待锁锁隔离问题脏读读到了其他事物未提交的数据不可重复读同样的查询读到的数据内容不一样幻读同样的查询读到了更多的数据不同隔离级别的问题如何解决幻读问题在可重复读级别时通过锁解决了幻读问题锁是行锁间隙锁间隙锁的功能与行锁相同只是针对间隙加锁间隙锁不分读写也可以认为是读锁不允许在间隙插入可重复读加锁时将同时锁住数据及其左右间隙使用实现了行记录历史查询快照读不需加锁属于乐观锁的一种思路当前读需加行锁为了并发控制锁解决了可重复读下的幻读问题间隙锁把全表都锁住了怎么办的加锁逻辑加锁时以为基本单位查找过程中扫描过的范围才加锁唯一索引等值查询没有间隙锁只加行锁索引等值查询最右一个扫描到的不满足条件值不加行锁索引覆盖且只加锁时不锁主键索引目的在可重复读的隔离级别下部分预防幻读手段行锁间隙锁特点规则复杂注意当前读时不要查询没有索引的项目也有垃圾回收嘛的垃圾回收并没有所谓的垃圾回收但是会发现数据卡几秒磁盘很高此时正在刷脏页脏页更新数据时只更新了内存中的数据页没有更新磁盘内存中数据页与磁盘中数据页不一致称为脏页什么是刷脏将内存中数据页保存至磁盘同时删除与此页相关的推进为什么要刷脏内存中的脏页太多内存不足文件写满需要推进系统空闲提前刷脏预防上述情况关闭前保存数据前两种会产生性能问题导致卡住如何避免被迫刷脏正确告知服务器的硬盘性能配置合理的脏页比例上限控制顺便刷脏策略服务器配置配置项用来告知服务器的硬盘性能可以使用工具测试服务器磁盘性能常见每秒配置合理的脏页比例上限配置脏页与磁盘中数据的比例当脏页比例接近此值会加速刷脏页最好为控制顺便刷脏策略配置传统的磁盘连续写性能最好尽量刷连续的页建议设为刷脏可能会导致卡住造成性能问题通过告知服务器性能可以控制合理刷脏合理的脏页比例上限建议保存默认顺便刷脏功能需在下关闭长事务有哪些危害主要危害锁无法释放行级锁长时间无法释放导致其他事物等待容易产生死锁锁住大量事务造成崩溃行级锁长时间无法释放当前读会对数据加锁事务提交前无法释放其他事物更新相同数据时会等待锁造成更新性能差解决方案调整参数默认为即等待秒还未获取锁当前语句报错如果等待时间过长可以适当缩短此参数容易产生死锁长事务的锁长时间不释放任意与其他事物产生死锁死锁指的是两个事务都依赖对方的锁释放解决方案主动死锁检测发现死锁时会回滚代价较小的事物默认开启锁事务访问数据时会自动给表加锁事务修改元数据时会自动给表加写锁遇到锁不兼容时申请锁的事物形成一个队列解决方案之前查看是否有长事务还未提交查看长事务库表如何查看影响性能的锁查看长事务库表查看锁库表查看阻塞上的事务库表查看锁查看锁等待查看锁业务建议控制长事务没有必要的情况下不开启事务数据修改当前读尽量放在事务后部降低锁时间长事务可能会造成行锁死锁锁等待可以通过参数调整减低锁影响可以通过系统表识别长事务和锁业务上尽量将加锁的操作后移降低锁时间第六章框架原理基础什么是对象关系映射对象与关系型数据库的映射关系著名的框架框架的意义将数据库操作与程序员编码解耦提高开发效率自动拼装生成语句避免注入风险自动管理数据库连接自动重试自动回滚等操作自动管理事务框架是怎么设计的框架架构层次接口层向上支持程序调用处理层参数映射生成执行结果处理支撑层事务管理连接池隔离连接层数据库连接驱动框架有哪些常见问题与是什么关系这个概念在中比较常见一般是生成的是框架的接口层如何定位出问题的业务应用根据代码推断查看相关日志数据库查看慢日志网络监听数据库端口解析报文第七章怎么给数据上保险数据库有哪些种类的备份备份的分类纬度备份时数据库的状态备份文件的格式备份的内容备份时数据库的状态热备正常运行中直接备份冷备完全停止后备份温备数据库只读备份文件的格式逻辑备份输出文本或语句物理备份裸文件备份数据库底层文件备份的内容完全备份备份完全数据增量备份备份数据差异日志备份备份备份工具逻辑热全量备份物理热全量增量备份使用命令备份原生的指令最原始的逻辑备份方式备份的功能和效果却绝育如何写语句的使用方式首先查找的导出路径使用指令将查询结果导出至文件的注意事项在事务下可以做到一致性视图修改分隔符修改换行符缺陷输出的文本比较简略很难进行还原现在往往用来简单导出数据总结时最简单且原生的数据备份工具使用简单灵活性高不适合数据还原场景基本用来导出数据使用进行备份如何改进自动发语句不需要手动发送自动开始事务输出语句可以直接用于还原非常常用的逻辑备份工具自带输出的备份内容为语句平衡了阅读和还原语句占空间较小原理使用以下语句对数据进行备份查询出的数据不会进入缓存使用方法使用以下语句对数据进行备份直接执行导出的文件即可进行还原注意事项在级别下进行使用锁所有表使用锁当前库的表备份所有库缺点导出逻辑数据备份较慢还原需要执行速度也比较慢如何使用增量备份增量备份思路忠实记录了数据的变化全量备份后可以用作为增量全量备份时切换新的文件从零还原时采用全量还原增量备份使用以下语句对数据进行全量备份备份后切换文件记录切换后的文件名需要增量备份时切换文件将所有新增的文件备份还原首先恢复旧的全量备份然后将增量还原至数据库使用物理备份为什么需要物理备份直接备份底层数据文件导出不需要转换速度快工作时对数据库的压力较小更容易实现增量备份直接裸拷贝可行嘛理论上可行但有很多问题要同时备份文件文件文件文件等在不同版本的数据库和操作系统上还原可能有兼容问题必须冷备份影响业务如何实现物理热全量备份思路利用备份文件备份期间的启动监听线程开始收集拷贝数据文件停止收集加锁拷贝元数据如何实现物理热增量备份思路与全量级别相同如何确认增量根据每个页的号确认变化的页如何实现物理还原思路奔溃恢复流程相似还原文件重放与现名官方出品实现了上述的功能性能优秀公司开发的开源版本实现所有功能参数备份的时候只执行阶段用于增量备份创建备份并且放入目录中不保持文件打开状态打开表空间的时候通常不会关闭文件句柄目的是为了正确处理操作如果表空间数量非常巨大并且不适合任何限制一旦文件不在被访问的时候这个选项可以关闭文件句柄打开这个选项会产生不一致的备份创建一份没有辅助索引的紧凑备份压缩所有输出数据包括事务日志文件和元数据文件通过指定的压缩算法目前唯一支持的算法是结果文件是归档格式每个创建的文件都可以通过程序提取或者解压缩压缩线程工作的字节大小默认是进行并行数据压缩时的线程的数量该选项默认值是并行压缩可以和并行文件拷贝一起使用例如会创建个线程读取数据并通过管道传送给个压缩线程这个选项目前还没有实现目前创建事务日志你还是需要两次的源目录实例的数据目录从中读取或者命令行指定在文件之后读取必须在命令行的第一选项位置指定唯一从给定文件读取默认选项必须是个真实文件必须在命令行第一个选项位置指定从配置文件读取的组多个实例部署时使用为导出的表创建必要的文件在指定目录创建一份文件的额外的备份创建一份增量备份时这个目录是增量别分的一份包含了的数据集增量备份的时候增量备份在结合创建出一份新的创建一份增量备份时强制扫描所有增在备份中的数据页即使完全改变的数据可用创建增量备份的时候指定指定包含归档日志的目录只能和选项一起使用从文件读取的一组选项以便以同样的配置启动内置的通常不需要显示指定这个选项指定了拷贝线程的时间间隔默认秒不拷贝数据文件将事务日志内容重定向到标准输出直到文件被删除这个选项自动开启不从任何选项文件中读取任何默认选项必须在命令行第一个选项指定了需要备份的数据库和表指定包含数据库和表的文件格式为为一个元素一个元素一行指定备份时拷贝多个数据文件并发的进程数默认值为在一份通过生成的备份执行还原操作以便准备使用打印程序参数列表并退出必须放在命令行首位使打印参数用来将数据文件拷贝到并还原它们在事务日志之后重建辅助索引只有和一起才生效在紧凑备份重建辅助索引的线程数只有和和一起才生效扫描指定数据文件并打印出索引统计将所有备份文件以指定格式流向标准输出目前支持的格式有和使在目录中生成文件在拷贝数据文件之后不是退出而是继续拷贝日志文件并且等待知道文件被删除这项可以使和其他程序协同工作正则表达式匹配备份匹配的表指定文件一个表名一行指定的目的地如果目录不存在会创建如果目录存在且为空则成功不会覆盖已存在的文件指定每秒操作读写对的数量当使用指定的时候打印出正确的参数指定备份时事务日志的只能和选项一起用通过备份时候分配多大内存目的像默认值如果你有足够大的内存是推荐值支持各种单位打印版本并退出支持同时压缩和流式化需要客服传统归档和其他不允许动态生成的文件的限制例如动态压缩文件超越其他传统流式归档格式的的优点是并发多个文件并且更紧凑的数据存储所以可以和选项选项一起使用格式进行全量使用方法备份还原停掉准备增量使用方法增量备份增量备份合并至全量备份使用场景备份指定用取代还原关闭先再改权限启动备份这里指定几个库和表也可以是所有库库全量备份增量备份注意要是有多个增量备份第个增量需要指定第一个增量的目录和一样还原先全备再增量备份最后全备最后改权限另外说一个指定表的备份和一样用和也可以用支持正则如备份开头的数据库下的所有表总结物理备份是一种高效的备份方式采用了备份备份期间方式时醉常用的物理备份工具物理备份的缺点是备份文件无法直接阅读备份工具如何指导我们的创新物理温备利用逻辑卷管理器直接备份磁盘数据跟类似的工具实现了多线程并发的备份还原速度更快功能强大的备份恢复管理工具集成了多种备份工具集成分析功能如何防患于未然权限隔离给业务应用分配的账户只给权限开发只使用只读账号破事使用时使用只读账号特殊操作时切换账号审计在开发环境审计即将上线的语句开发修改在线数据提交给执行自动审核工具伪删表删表之前将表改名观察业务是否受影响不直接删表给表名加特殊后缀用脚本删除完备流程上线之前备份数据准备生产环境事故预案第八章三高框架基础什么是三高高并发同时处理的事物数高高性能事物的执行速度快高可用系统可用时间高为什么不直接讲三高三高只是目的并不是手段手段有复制目的数据冗余手段传送收获并发量提升可用性提升问题占用更多硬件资源扩展目的扩展数据库容量手段数据库分片分库分表收获性能并发量的提升问题可能减低可用性切换目的提高可用性手段主从身份切换收获并发量的提升问题丢失切换时期数据三高的实现高并发通过复制和扩展将数据分散至多节点高性能复制提升速度扩展提升容量高可用节点间身份切换保证随时可用复制有哪些类型根据复制同步的类型可以分为异步复制半同步复制组复制异步复制原理简单对网络延迟要求较小不能保证日志被传送到了备库可能丢失数据半同步复制原理简单对网络延迟有一定要求最好在同一机房可以保证日志被传送到了备库不易丢失数据参数可以调整脱扣时间默认为组复制原理比较复杂需要依赖共识算法实际应用较少时数据库走向原生分布式的示范主从复制进入配置文件日志所在目录在同一个集群中不一样即可配置半同步插件配置只读在配置时要先给上全局锁备份数据给使用查看执行情况配置配置完成开启查看状态若不想设置就要给每个事务配一个唯一开启功能增强的一致性配置版本引入了节点的事务流水号回滚会收回可以给事务分配全局唯一方便了主从复制的配置推荐打开对主从切换故障恢复也有很大意义为什么格式会影响复制格式格式之前的默认使用的格式记录的是语句原文由于主备库对于的执行不一致可能有数据安全风险格式不记录语句原文记录数据行的变化不是物理日志还是逻辑日志占用空间较大格式两种格式混合使用有数据风险的语句使用无风险的使用基于语句的复制基于行的复制推荐使用格式备库延迟太大怎么办备库延迟的原因传送开销较小主要是消费耗时备库性能不如主库备库承担了很多分析主库长事务未提交处理方法主备使用相同配置的机器备库关闭实时刷盘增加从库数量应对分析传送至大数据库系统供分析大事务一分多依然存在的问题备库对硬件资源利用天然不如主库备库单线程执行主库多线程执行并行复制的思路按表分发按行分发并行复制按库并行策略优点分发快支持各种格式缺点库粒度太大很难负载平衡配置按事务组并行策略刷盘其实是两步动作先把从中写道内存的文件调用持久化至磁盘设置事务组延迟多少微秒后才调用积累多少次以后才调用两个参数是或的关系配置同时处于状态的事物在备库执行时是可以并行的推荐使用并行复制参数按事务组并行没有修改相同行的事物可以并行同一个线程先后执行的两个事务不能并行如何在备库读到最新数据如何判断备库已经追上强制延时当为时对比执行位点对比执行情况备库延迟理论上无法消灭传送中继日志重放需要时间理论上备库延迟只能减小无法消灭在备库读取数据时永远面临数据延迟问题判断具体事务是否已经重放等待位点如果已经重放到位点了就会返回值等待之后可以返回每次的拿返回的执行命令从库会阻塞到执行怎样实现最简单的高可用架构主主复制架构两个结点均为两个结点互为一个结点出现故障时无需身份切换主主架构问题数据冲突问题两边插入相同时可能出现冲突两边约定好插入不同只写一个主另一个只读有切换过快的数据丢失问题客户端切换应用自己切换比较麻烦使用等手段可以完成自动切换循环复制未开使用过滤天然避免第九章如何解决容量不够的问题怎样最简单的扩展容量什么是分区表将的一个表分为多个表层依然看做一个表分区表可以优化单节点容量增强分区之间隔离可以通过存储在不同的磁盘上提高容量分区方式范围分区分区分区分区表的优势减低树的层级搜索加速将一个数据表物理上分为多个文件方便处理分区表的缺陷第一次需要访问所有分区可能达到上限共用锁分区之后所有的分区依然位于同一节点为什么要分库分表分表垂直按照字段分表一般分为冷热水平按照行分表常用范围切分水平分表类似于分区表但层也分了分库垂直将数据表分散在多个数据库或者多个节点中水平将所有表水平拆分每个数据库结构相同分库分表的优缺点优点增加隔离性提升容量与并发性能缺点部分失效可能性成倍增加无法使用单点事务垂直切分后无法范围查询困难分库分表后的使用方式业务特殊处理业务应用使用中间层使用分库分表中间件总结分库分表可以提升数据库性能分库分表使得数据的使用方法更加复杂数据丢失的可能性增加使用分库分表中间件可以最大程度方便客户端的使用比强在哪分库分表中间件的原理分析语句根据语义将拆分成多个发送至数据节点将多个数据节点的结果聚集返回客户端高性能高可用的分库分表中间件完全开源基于开源项目在功能上以水平分表为主的基础概念虚拟数据库不同于传统的虚拟表被拆分的表虚拟节点实际的集群实际的表的类型全局表每个节点上有保存表的完整数据拆分表被拆分的表存入不同节点非拆分表不拆分的表存在单一节点安装使用安装解压先在上安装配置变量安装解压压缩包名字配置启动配置文件需全部去除集群配置文件启动参数连接用户配置配置管理员用于管理元数据配置用户用于管理数据设置数据分片配置实际处理数据分片的地址设置一个数据分片设置一个用于分片的如果有从节点可以设置从节点的使用开启用连接若成功连接则正常启动创建虚拟数据库怎样提高分库分表架构的可靠性使用进行读写分离分析语义将写语句发送给主节点将读语句发送给从节点读写分离参数在中配置直接分发到主实例读操作必须在所有从实例中均衡读操作在所有实例中均衡读操作尽量在所有从实例中均衡从节点中的参数改成意思为从节点不废弃在中设置日志分库分表之后性能反而下降怎么办查询语句中尽可能带有拆分字段根据拆分字段判断数据在哪个节点若无法判断数据节点只能遍历全部节点数据插入语句必须带有拆分字段新数据若无拆分字段无法插入拆分字段尽量等值范围拆分字段会扫描过多节点若使用字句缩减字句值的数量减少表的搜索遍历不带拆分字段时尽量少出现不要大于一种减少结果集分布式系统中节点间有大量的数据交互数据交互会影响查询性能过大的结果集会增大数据汇集的网络交互量跨节点连表经常的表使用相同的拆分规则使用拆分字段作为条件尽量对驱动表添加更多的过滤条件尽量少使用跨节点排序分页等功能复杂语句拆分成多条语句第十章如何解决数据库经常宕机问题切换保业务还是保数据如何进行身份切换停止备库同步配置主库复制从库可靠性优先策略检查库不能过大库只读检查库关只读库停止复制库库开始复制库数据无丢失有几秒的世界两个数据库均不可写若一开始未检查那么不可用时间无法控制可用性优先策略取消等待数据一致的过程库只读库关只读库停止复制库库开始复制库系统没有不可写的时间若切换时还有未重放的可能造成数据不一致总结普通业务执行时尽量用可靠性优先策略日志流水等不太需要数据可靠性的用可用性优先策略数据库切换了业务怎么办业务切换至新地址业务预留接口通知新的数据库地址使用微服务框架通知业务总结业务切换至新地址不影响性能业务可能不支持使用内部方便需要多余的硬件资源漂移自动漂移需要多余的资源使用代理自动更新需要多余的资源客户端无感知需要被动通知如何实现自动主从切换常见的高可用组件可以检测节点状态自动执行切换脚本还有漂移功能常用的高可用组件支持来不及传送时会尝试登录库传送不能自动漂移从宕机奔溃的抢救未传送的等待执行中继日志追赶在执行从抢救除的提升一个为使用其他的连接新的进行连接自研高可用组件完全自主控制研发代价高总结可以自动切换身份但是并不完善是较为完善的自动身份切换工具若有更高级的管理需求可以二次开发或者自己开发高可用中间件自动主从切换实战下载在下载全部装从节点装先安装依赖之后就可以安装了配置免密配置可以使用秘钥登录允许账户在远程登录在目录下执行后生成了两个文件公钥和私钥生成秘钥从节点发送秘钥给其他主机编写配置文件随便写文件内容主机检查免密登录检查主从复制检查运行状态开启从官方下载联动脚本配置到上即可高可用了集群为什么还会挂第十一章未来的数据库怎么样体验什么新特性窗口函数以某个列为分隔分为多个窗口在窗口内执行特定函数隐藏索引暂时隐藏某个索引可以通过隐藏和显示索引来测试索引的作用降序排序之前只有升序索引对于很多本来能走索引覆盖的语句升序索引无法覆盖降序索引解决了此问题通用表表达式使用表达式预先定义可以复杂语句中反复使用的中间结果可以认为是一个临时视图编码作为的默认字符集事务支持事务元数据操作可以回滚数据库有哪些分类按用途分在线事务处理处理语句不复杂大都处于事务中并发量大对可用性要求高在线分析处理系统语句复杂数据量大一般以单个事务为单位混合事务分析处理混合了两种数据库的特点实现一种架构多功能按存储形式分类行存列存按架构分类谁是单体数据库之王与类似的功能性能更好更稳定代码质量更高有超赶的趋势自带分库分表中间件管理每个事务的执行解析制定执行计划然后分发返回执行结果到高性能优化器执行模式总结是一个开源完全代替的高性能数据库时基于的分布式事务集群时基于的分布式分析集群能魔改成什么样总结对进行了魔改采用了共享存储的架构将三种简化为一种国产数据库一键水平扩容或者缩容金融级高可用实时云原生的分布式数据库兼容协议和生态',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-15 00:00:00',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="AYO" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://git.yuki.love/" title="AYO网站"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="AYO网站"/><span class="back-menu-item-text">AYO网站</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3708003152300183" title="AYO博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="AYO博客"/><span class="back-menu-item-text">AYO博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/AYO-Al" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">AYO</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Ansible/" style="font-size: 1.05rem;">Ansible<sup>1</sup></a><a href="/tags/CDN/" style="font-size: 1.05rem;">CDN<sup>1</sup></a><a href="/tags/DNS/" style="font-size: 1.05rem;">DNS<sup>1</sup></a><a href="/tags/Database/" style="font-size: 1.05rem;">Database<sup>8</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>1</sup></a><a href="/tags/ELK/" style="font-size: 1.05rem;">ELK<sup>1</sup></a><a href="/tags/Flask/" style="font-size: 1.05rem;">Flask<sup>1</sup></a><a href="/tags/Httpd/" style="font-size: 1.05rem;">Httpd<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>1</sup></a><a href="/tags/Keepalived/" style="font-size: 1.05rem;">Keepalived<sup>1</sup></a><a href="/tags/LVS/" style="font-size: 1.05rem;">LVS<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>22</sup></a><a href="/tags/MLinux/" style="font-size: 1.05rem;">MLinux<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>6</sup></a><a href="/tags/Nginx/" style="font-size: 1.05rem;">Nginx<sup>3</sup></a><a href="/tags/Prometheus/" style="font-size: 1.05rem;">Prometheus<sup>1</sup></a><a href="/tags/Python/" style="font-size: 1.05rem;">Python<sup>8</sup></a><a href="/tags/Rabbit/" style="font-size: 1.05rem;">Rabbit<sup>1</sup></a><a href="/tags/Shell/" style="font-size: 1.05rem;">Shell<sup>3</sup></a><a href="/tags/Web/" style="font-size: 1.05rem;">Web<sup>2</sup></a><a href="/tags/Zabbix/" style="font-size: 1.05rem;">Zabbix<sup>2</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 1.05rem;">中间件<sup>1</sup></a><a href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" style="font-size: 1.05rem;">主从复制<sup>1</sup></a><a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" style="font-size: 1.05rem;">云计算<sup>7</sup></a><a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 1.05rem;">反向代理<sup>1</sup></a><a href="/tags/%E5%9B%9B%E5%A4%A7%E4%BB%B6/" style="font-size: 1.05rem;">四大件<sup>2</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">开发<sup>7</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/" style="font-size: 1.05rem;">文件共享服务<sup>1</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">文件系统<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">日志管理<sup>1</sup></a><a href="/tags/%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/" style="font-size: 1.05rem;">时间同步<sup>1</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">服务管理<sup>1</sup></a><a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 1.05rem;">爬虫<sup>4</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 1.05rem;">监控<sup>3</sup></a><a href="/tags/%E7%A3%81%E7%9B%98/" style="font-size: 1.05rem;">磁盘<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" style="font-size: 1.05rem;">网络架构<sup>1</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/" style="font-size: 1.05rem;">自动化运维<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">软件管理<sup>1</sup></a><a href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 1.05rem;">防火墙<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">九月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Database/" itemprop="url">Database</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Database/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Database</span></a><a class="article-meta__tags" href="/tags/MySQL/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>MySQL</span></a><a class="article-meta__tags" href="/tags/%E4%B8%89%E9%AB%98MySQL/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>三高MySQL</span></a></span></div></div><h1 class="post-title" itemprop="name headline">三高MySQL</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2022-11-22T16:00:00.000Z" title="发表于 2022-11-23 00:00:00">2022-11-23</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-01-14T16:00:00.000Z" title="更新于 2023-01-15 00:00:00">2023-01-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">19k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>69分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://th.bing.com/th/id/OIP.IV7LvR2MoBb3y-EKG9uAJAHaEK?rs=1&amp;pid=ImgDetMain&amp;_r_=f928203e-103d-7086-6e45-a5d8e527fe19"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://ayo-al.github.io/2022/11/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E4%B8%89%E9%AB%98%E6%95%B0%E6%8D%AE%E5%BA%93/"><header><a class="post-meta-categories" href="/categories/Database/" itemprop="url">Database</a><a href="/tags/Database/" tabindex="-1" itemprop="url">Database</a><a href="/tags/MySQL/" tabindex="-1" itemprop="url">MySQL</a><a href="/tags/%E4%B8%89%E9%AB%98MySQL/" tabindex="-1" itemprop="url">三高MySQL</a><h1 id="CrawlerTitle" itemprop="name headline">三高MySQL</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">AYO</span><time itemprop="dateCreated datePublished" datetime="2022-11-22T16:00:00.000Z" title="发表于 2022-11-23 00:00:00">2022-11-23</time><time itemprop="dateCreated datePublished" datetime="2023-01-14T16:00:00.000Z" title="更新于 2023-01-15 00:00:00">2023-01-15</time></header><h1 id="第一章：介绍"><a href="#第一章：介绍" class="headerlink" title="第一章：介绍"></a>第一章：介绍</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h2><blockquote>
<p>什么是三高数据库？</p>
</blockquote>
<ul>
<li>高并发：同时处理的事物数高</li>
<li>高性能：事物&#x2F;SQL的执行速度高</li>
<li>高可用：系统可用时间高</li>
</ul>
<blockquote>
<p>实现三高的手段</p>
</blockquote>
<ul>
<li>复制<ul>
<li>目的：数据冗余</li>
<li>手段：binlog传送</li>
<li>收获：并发量提升、可用性提高</li>
<li>问题：占用更多硬件资源</li>
</ul>
</li>
<li>扩展<ul>
<li>目的：扩展数据库容量</li>
<li>手段：数据库分片分库、分表</li>
<li>收获：性能、并发量的提升</li>
<li>问题：可能减低可用性</li>
</ul>
</li>
<li>切换<ul>
<li>目的：提高可用性</li>
<li>手段：主从身份切换</li>
<li>收获：并发量的提升</li>
<li>问题：丢失切换时期数据</li>
</ul>
</li>
<li>三高实现<ul>
<li>高并发：通过复制和扩展，将数据分散至多节点</li>
<li>高性能：复制提升速度，扩展提升容量</li>
<li>高可用：节点间身份切换保证随时可用</li>
</ul>
</li>
</ul>
<blockquote>
<p>如何提升单点性能</p>
</blockquote>
<ul>
<li>建表：表结构合理，索引高效</li>
<li>查询：优化SQL语句，选择正确索引</li>
<li>更新：正确使用锁，合理优化事务</li>
</ul>
<blockquote>
<p>为什么有了Excel表格还需要数据库？</p>
</blockquote>
<ul>
<li>数据库理论上没有行数上限</li>
<li>单机数据库若行数太多遇到性能问题，可以通过分库分表等技术解决、</li>
<li>数据库有结构化查询语言</li>
<li>Excel是文件级别的，直接面向终端用户。而数据库面向软件，提供软件接口。</li>
<li>Excel没有事务，无法做到不同人的工作同时进行。数据库事务是关系型数据库的核心优势</li>
<li>Excel是单体的，面向文件的。数据库具有主备复制、高可用、分布式等形态</li>
</ul>
<h1 id="第二章：SQL语句是这样执行的"><a href="#第二章：SQL语句是这样执行的" class="headerlink" title="第二章：SQL语句是这样执行的"></a>第二章：SQL语句是这样执行的</h1><h2 id="1-软件经典架构"><a href="#1-软件经典架构" class="headerlink" title="1.软件经典架构"></a>1.软件经典架构</h2><blockquote>
<p>分层架构</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6s4g6.png" alt="image-20221108121601871"></p>
<blockquote>
<p>事件驱动架构</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6s4zj.png" alt="image-20221108121821300"></p>
<blockquote>
<p>管道-过滤器架构</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6s9t6.png" alt="image-20221108122035659"></p>
<blockquote>
<p>微核架构</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6s93q.png" alt="image-20221108122235613"></p>
<h2 id="2-MYSQL软件架构"><a href="#2-MYSQL软件架构" class="headerlink" title="2.MYSQL软件架构"></a>2.MYSQL软件架构</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6si23.png" alt="image-20221108125701515"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6s7pq.png" alt="image-20221108123042046"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6sc0j.png" alt="image-20221108123148601"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6shnk.png" alt="image-20221108123209934"></p>
<blockquote>
<p>软件工程当中有很多经典的架构设计</p>
<p>大型软件往往不是使用单一的架构设计，而是多种混合</p>
<p>研究问题要有清晰的视野，分清微观和宏观</p>
</blockquote>
<h2 id="3-客户端与mysql的连接方式"><a href="#3-客户端与mysql的连接方式" class="headerlink" title="3.客户端与mysql的连接方式"></a>3.客户端与mysql的连接方式</h2><ol>
<li><p>TCP&#x2F;IP连接</p>
</li>
<li><p>命名管道</p>
<ul>
<li>同一台服务器通讯</li>
</ul>
</li>
<li><p>共享内存</p>
<ul>
<li>客户端和服务端通过一片内存交互</li>
</ul>
</li>
<li><p>UNIX域套接字</p>
</li>
</ol>
<blockquote>
<p>TCP&#x2F;IP连接</p>
</blockquote>
<p>TCP&#x2F;IP连接是MYSQL在任何平台上都提供的连接方法</p>
<ul>
<li>三次握手建立TCP连接</li>
<li>认证连接</li>
<li>认证通过之后，客户端开始与服务端之间交互</li>
<li>四次挥手断开TCP连接</li>
</ul>
<blockquote>
<p>TCP通讯协议 - 认证连接</p>
</blockquote>
<ol>
<li><p>服务端—-&gt;客户端：发送握手初始化包</p>
</li>
<li><p>客户端—-&gt;服务端：发送验证</p>
</li>
<li><p>服务端—-&gt;客户端：认证结果消息</p>
</li>
</ol>
<blockquote>
<p>TCP报文格式</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6shwf.png" alt="image-20221108124216717"></p>
<ul>
<li>消息头：3字节报文长度，1字节序号</li>
<li>消息体：1字节指令，其余为参数</li>
</ul>
<h2 id="4-一个SQL语句时怎么执行的"><a href="#4-一个SQL语句时怎么执行的" class="headerlink" title="4.一个SQL语句时怎么执行的"></a>4.一个SQL语句时怎么执行的</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6si23.png"></p>
<blockquote>
<p>连接器</p>
</blockquote>
<p>监听客户端的请求</p>
<blockquote>
<p>查询缓存</p>
</blockquote>
<p>之前执行过的语句会KV的形式缓存在内存中。查询之前先查找之前执行过的相同语句</p>
<p>不推荐使用缓存：数据表修改后，会删除所有相关缓存</p>
<blockquote>
<p>分析器</p>
</blockquote>
<p>分析器的作用是知道你要干什么</p>
<p>先做词法分析，识别SQL语句中的关键字</p>
<p>再做句法分析，判断SQL语句是否符合语法</p>
<blockquote>
<p>优化器</p>
</blockquote>
<p>优化器的作用是要知道怎么做</p>
<p>优化器的主要工作时决定如何使用索引</p>
<blockquote>
<p>执行器</p>
</blockquote>
<p>执行器的主要工作是校验权限、调用存储引擎</p>
<p>执行器首先校验从用户对目标数据有无权限</p>
<p>执行器会以行为粒度，调用存储引擎。执行SQL</p>
<p>在没有索引情况下，执行器会循环查询所有行</p>
<blockquote>
<p>存储引擎</p>
</blockquote>
<p>任务时将执行器的指令落实在数据文件上</p>
<p>不同存储引擎原理和执行方法有很大不同</p>
<blockquote>
<p>SQL语句执行的过程涉及到了MYSQL几乎所有的模块</p>
<p>一个SQL语句是按照分析-优化-执行-落盘的步骤执行的</p>
<p>MYSQL8.0之后已经停用了缓存功能</p>
</blockquote>
<h2 id="5-MYSQL存储引擎"><a href="#5-MYSQL存储引擎" class="headerlink" title="5.MYSQL存储引擎"></a>5.MYSQL存储引擎</h2><ol>
<li>InnoDB</li>
<li>MyISAM</li>
<li>Memory</li>
<li>Archive</li>
</ol>
<blockquote>
<p>MyISAM</p>
</blockquote>
<p>MySQL5.5.5之前的默认存储引擎</p>
<ul>
<li><p>插入数据快</p>
</li>
<li><p>空间利用率高</p>
</li>
<li><p>不支持事物</p>
</li>
</ul>
<blockquote>
<p>InnoDB</p>
</blockquote>
<p>MySQL5.5.5之后的默认存储引擎</p>
<ul>
<li>支持事物、外键</li>
<li>支持崩溃修复能力和并发控制</li>
</ul>
<blockquote>
<p>Memory</p>
</blockquote>
<p>所有的数据都在内存中，速度快</p>
<ul>
<li>数据安全性差</li>
</ul>
<blockquote>
<p>Archive</p>
</blockquote>
<p>数据压缩、空间利用率高</p>
<ul>
<li>插入速度快</li>
<li>不支持索引，查询性能差</li>
</ul>
<blockquote>
<p>InnoDB是目前最流行的存储引擎，适合各种互联网业务</p>
<p>查询效率要求非常高可以考虑MyISAM</p>
<p>日志信息归档可以考虑Archive</p>
<p>临时表可以考虑Memory</p>
</blockquote>
<h1 id="第三章：如何建表更符合业务"><a href="#第三章：如何建表更符合业务" class="headerlink" title="第三章：如何建表更符合业务"></a>第三章：如何建表更符合业务</h1><h2 id="1-索引组织表"><a href="#1-索引组织表" class="headerlink" title="1.索引组织表"></a>1.索引组织表</h2><ul>
<li><p>索引组织表不是一种”组织表“</p>
</li>
<li><p>索引组织表是由索引“组织起来的”表</p>
</li>
<li><p>InnoDB中，表都是根据主键顺序组织存放的</p>
</li>
</ul>
<blockquote>
<p>索引</p>
</blockquote>
<ul>
<li>索引是数据库中对某一列或多个列的值进行预排序的数据结构</li>
<li>索引可以理解为数据的目录</li>
<li>InnoDB中，主键是一个特殊索引字段</li>
</ul>
<blockquote>
<p>主键</p>
</blockquote>
<ul>
<li>InnoDB存储引擎表中，每张表都有一个主键</li>
<li>若表中有一个非空唯一索引，即为主键</li>
<li>若有多个非空唯一索引，选择第一个定义的索引</li>
<li>若无，InnoDB自动创建一个6字节的指针，作为主键</li>
</ul>
<h2 id="2-索引所使用的的算法"><a href="#2-索引所使用的的算法" class="headerlink" title="2.索引所使用的的算法"></a>2.索引所使用的的算法</h2><blockquote>
<p>主流索引查找算法</p>
</blockquote>
<ol>
<li>线性查找</li>
<li>二分查找</li>
<li>二叉查找树</li>
<li>平衡二叉树</li>
<li>B树</li>
<li>B+树</li>
</ol>
<blockquote>
<p>线性查找</p>
</blockquote>
<ul>
<li>时间复杂度O(N)</li>
<li>从第一个数据开始，逐个匹配</li>
</ul>
<blockquote>
<p>二分查找</p>
</blockquote>
<ul>
<li>时间复杂度O(logN)</li>
<li>拿出有序数列中点位置作为比较对象</li>
<li>根据中点数据大小，选取一半数据作为新的数列</li>
<li>每次可以将数据量减少一半</li>
</ul>
<blockquote>
<p>二叉查找树</p>
</blockquote>
<ul>
<li><p>时间复杂度(logN)</p>
</li>
<li><p>使用经典的二叉树数据结构</p>
</li>
<li><p>由根节点开始查找</p>
</li>
<li><p><strong>可能会退化为线性查找</strong></p>
</li>
</ul>
<blockquote>
<p>平衡二叉树</p>
</blockquote>
<ul>
<li>时间复杂度(logN)</li>
<li>查找时跟二叉搜索树相同</li>
<li>增删改时，通过旋转操作，维护树的平衡</li>
<li>可以保证不会退化成线性查找</li>
</ul>
<blockquote>
<p>B树</p>
</blockquote>
<ul>
<li>B树是线性数据结构和树的结合</li>
<li>B树通过多数据节点大大降低了树的高度</li>
<li>B数不需要旋转就可以保证树的平衡</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6shrj.png" alt="image-20221108151918192"></p>
<blockquote>
<p>B+树</p>
</blockquote>
<ul>
<li>是由B树发展而来的</li>
<li>B+树的所有数据均在叶子节点</li>
<li>B+数的所有数据形成了一个线性表</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6sk70.png" alt="image-20221108152716418"></p>
<blockquote>
<p>B+树是目前最主流的数据库索引算法</p>
<p>B+法由线性表、二叉树、B树发展而来</p>
<p>B+树集成了线性表、平衡二叉树的优势</p>
</blockquote>
<h2 id="3-InnoDB索引"><a href="#3-InnoDB索引" class="headerlink" title="3.InnoDB索引"></a>3.InnoDB索引</h2><blockquote>
<p>B+树索引</p>
</blockquote>
<ul>
<li>InnoDB使用B+树作为索引的数据结构</li>
<li>B+树的高度一般为2-4层，查找速度非常快</li>
<li>InnoDB索引分为聚簇索引(主索引)和辅助索引</li>
</ul>
<blockquote>
<p>聚簇索引</p>
</blockquote>
<ul>
<li>根据表的主键构造一个B+树</li>
<li>叶子节点直接存放数据，而不是指针</li>
<li>索引组织表中，数据也是B+树的一部分</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6sgo7.png" alt="image-20221108154003092"></p>
<blockquote>
<p>辅助索引</p>
</blockquote>
<ul>
<li>每张表可以有多个辅助索引</li>
<li>叶子节点并不包含行数据</li>
<li>叶子节点记录了行数据的主键，用来指示数据位置</li>
<li>采用辅助索引只能查到主键数据，然后通过主键再次进行B+查找，这种行为称为<code>回表</code></li>
</ul>
<blockquote>
<p>InnoDB索引分为聚簇索引和辅助索引</p>
<p>在同层B+树节点之间，为双向链表</p>
<p>在b+树节点之内，数据条目之间为单向链表</p>
<p>所谓索引即数据，是把数据直接记录在主索引中</p>
</blockquote>
<h2 id="4-InnoDB数据存储"><a href="#4-InnoDB数据存储" class="headerlink" title="4.InnoDB数据存储"></a>4.InnoDB数据存储</h2><blockquote>
<p>InnoDB逻辑存储结构</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6spwi.png" alt="image-20221108163002070"></p>
<ul>
<li><p>表空间</p>
<ul>
<li>表空间指的是数据表在硬盘上的存储空间</li>
<li>默认所有表的数据都存在共享表空间</li>
<li>每个表的数据也可以放在独占表空间(ibd文件)</li>
</ul>
</li>
<li><p>段</p>
<ul>
<li>数据段(Leaf node segment)：B+树的叶子节点</li>
<li>索引段(Non-Leaf node segment)：B+树的非叶子节点</li>
<li>InnoDB中，段由存储引擎自动管理</li>
</ul>
</li>
<li><p>区</p>
<ul>
<li>区是由连续页组成的空间，大小为1MB</li>
<li>一次从磁盘申请4~5个区</li>
<li>一般含有64个页</li>
</ul>
</li>
<li><p>页</p>
<ul>
<li>页是InnoDB中磁盘读写的最小逻辑单位，默认是16KB</li>
<li>一个数据页就是一个B+数节点</li>
<li>页的大小充分考虑了机械硬盘和SSD的最小单元（512B和4KB）</li>
</ul>
</li>
</ul>
<blockquote>
<p>InnoDB的逻辑存储结构为表空间、段、区、页、行</p>
<p>InnoDB的逻辑存储结构充分考虑了以基于B+树的表结构</p>
<p>InnoDB的页是InnoDB自身的概念逻辑，与硬件的页无关</p>
</blockquote>
<blockquote>
<p>为什么页不能太大</p>
</blockquote>
<ol>
<li>因为页是InnoDB读写的最小逻辑单位，读取太大对硬盘的压力过大</li>
<li>一次读取的数据可能很小，所以如果页过大就会导致取出太多垃圾数据，增加内存负担</li>
<li>页结构里是一个链表，页的内存太大会导致页中数据过多，导致查询困难</li>
</ol>
<blockquote>
<p>为什么页不能太小</p>
</blockquote>
<ol>
<li>因为要考虑机械硬盘和SSD的最小单元</li>
</ol>
<h2 id="5-InnoDB的数据行"><a href="#5-InnoDB的数据行" class="headerlink" title="5.InnoDB的数据行"></a>5.InnoDB的数据行</h2><blockquote>
<p>InnoDB中的变长列</p>
</blockquote>
<ul>
<li>长度不固定的数据类型：<ul>
<li>varchar</li>
<li>varbinary</li>
<li>blob</li>
<li>text </li>
<li>占用空间大于768Byte的char类型</li>
<li>变长编码下的char</li>
</ul>
</li>
</ul>
<blockquote>
<p>行溢出数据</p>
</blockquote>
<ul>
<li>由于InnoDB每个数据页容量有限，导致数据字段也是有限的</li>
<li>当数据字段过大时，InnoDB会使用行溢出机制</li>
<li>行溢出机制会把超长字段放入单独开辟的数据页</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6ssim.png" alt="image-20221108170629543"></p>
<h2 id="6-InnoDB行记录格式"><a href="#6-InnoDB行记录格式" class="headerlink" title="6.InnoDB行记录格式"></a>6.InnoDB行记录格式</h2><ul>
<li>InnoDB行记录格式主要分为两个时代：<ul>
<li>Redundant&#x2F;Compact（Antelope文件格式）</li>
<li>Dynamic&#x2F;Compressed（Barracuda文件格式）</li>
</ul>
</li>
</ul>
<blockquote>
<p>Redundant</p>
</blockquote>
<p>mysql5.0之前的默认Row Format</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6stcf.png" alt="image-20221108215022795"></p>
<blockquote>
<p>Compact</p>
</blockquote>
<p>mysql5.1之前的默认Row Fromat</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6stb8.png" alt="image-20221108215056530"></p>
<blockquote>
<p>Dynamic</p>
</blockquote>
<p>MySQL5.7之后默认Row Fromat</p>
<table>
<thead>
<tr>
<th>变长字段长度表</th>
<th>NULL标志位</th>
<th>Header</th>
<th>RowID</th>
<th>TxID</th>
<th>Roll Pointer</th>
<th>Col 1</th>
<th>Col 2</th>
<th>……</th>
<th>Col n</th>
</tr>
</thead>
<tbody><tr>
<td>每个变长字段的长度                      按照列的顺序逆序放置</td>
<td>指示行记录中的NULL值      每个bit代表一个字段</td>
<td>列数量、下一行记录的指针等信息</td>
<td>没有可用主键时，使用Row ID作为隐藏主键</td>
<td>事务ID</td>
<td>回滚指针</td>
<td>未溢出的数据，小于40Byte</td>
<td>数据长度大于40Byte，则只记录一个BLOB指针</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>Compressed</p>
</blockquote>
<p>在Dynamic基础上，对表的数据行使用zlib算法进行了压缩存储</p>
<p>可以节约40%左右空间但对CPU的压力较大</p>
<blockquote>
<p>InnoDB行记录格式经历了两个时代、四种类型</p>
<p>行记录格式化的核心需求是节约行记录空间</p>
<p>节约行记录空间从而增加每个页的数据行数，提高查询效率</p>
</blockquote>
<h2 id="7-索引有哪些“左侧用法”"><a href="#7-索引有哪些“左侧用法”" class="headerlink" title="7.索引有哪些“左侧用法”"></a>7.索引有哪些“左侧用法”</h2><blockquote>
<p>联合索引</p>
</blockquote>
<ul>
<li><p>使用两个或以上字段生成的索引</p>
</li>
<li><p>联合索引可以加速<code>最左前缀</code>的查询</p>
</li>
<li><p>联合索引可以代替<strong>最左侧字段</strong>的单独索引</p>
</li>
<li><p><code>带头大哥不能死，中间兄弟不能丢</code></p>
</li>
</ul>
<blockquote>
<p>联合索引的B+树结构</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/xuf4np-0.png" alt="img"></p>
<ul>
<li>上述B+树数据</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/xuhdow-0.png" alt="img"></p>
<blockquote>
<p>字符串的前缀索引</p>
</blockquote>
<ul>
<li><p>如果字符串过长，可以考虑使用前缀索引节约空间</p>
</li>
<li><p>如果前缀区分度太小，可以考虑两种变通方法</p>
<ul>
<li>如果前缀相同：倒叙存储</li>
<li>如果前后缀都相同：新建Hash字段</li>
</ul>
</li>
<li><p>新增前缀索引SQL语句</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">add</span> index index2(email(<span class="number">6</span>))</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>字符串like</p>
</blockquote>
<ul>
<li>(like %%关键字)(like %关键字)会使索引失效</li>
<li>(like 关键字%)左模糊才可以使用索引</li>
</ul>
<blockquote>
<p>MySQL有很多<code>左侧用法</code></p>
<p>联合索引可以代替最左侧字段的单独索引</p>
<p>字符串的前缀索引可以节约磁盘空间</p>
<p>字符串左模糊可以有效利用索引</p>
</blockquote>
<h2 id="8-如何约束数据"><a href="#8-如何约束数据" class="headerlink" title="8.如何约束数据"></a>8.如何约束数据</h2><blockquote>
<p>InnoDB约束数据的方法</p>
</blockquote>
<ol>
<li>Primary key&#x2F;Unique key</li>
<li>Foreign key</li>
<li>Default&#x2F;NOT NULL</li>
<li>触发器</li>
</ol>
<blockquote>
<p>Primary key&#x2F;Unique key</p>
</blockquote>
<ul>
<li>Primary key：唯一，不为空</li>
<li>Unique key：唯一</li>
<li>唯一约束插入时的性能开销较大</li>
</ul>
<blockquote>
<p>Foreign key</p>
</blockquote>
<ul>
<li>外键可以对数据的正确性实现约束</li>
</ul>
<blockquote>
<p>Default&#x2F;NOT NULL</p>
</blockquote>
<ul>
<li>Default：数据默认值</li>
<li>NOT NULL：数据不为空</li>
</ul>
<blockquote>
<p>触发器</p>
</blockquote>
<ul>
<li>插入、修改数据时，使用触发器校验数据</li>
<li>容易干扰业务，使用很少</li>
</ul>
<blockquote>
<p>InnoDB有多重约束数据方法</p>
<p>将数据设置为索引字段快银约束数据的唯一性，但开销较大</p>
<p>外键可以对数据有效性进行校验</p>
<p>NOT NULL的行为可能收到<code>sql_mode</code>参数的影响</p>
</blockquote>
<h2 id="9-如何使用不存在的数据表"><a href="#9-如何使用不存在的数据表" class="headerlink" title="9.如何使用不存在的数据表"></a>9.如何使用不存在的数据表</h2><blockquote>
<p>视图View</p>
</blockquote>
<ul>
<li>使用视图可以创建不存在的虚拟表</li>
<li>视图的原理是预设一个SELECT语句</li>
<li>SELECT语句的查询结构作为虚拟表的数据</li>
</ul>
<blockquote>
<p>视图算法的选择</p>
</blockquote>
<ul>
<li>MERGE：将视图SQL合并到主查询SQL中</li>
<li>TEMPTABLE：将视图作临时表(中间结果)来处理</li>
<li>一般来讲，MERGE的性能优于TEMPTABLE</li>
</ul>
<blockquote>
<p>无法使用MERGE的SQL</p>
</blockquote>
<ol>
<li>聚集函数</li>
<li>distinct</li>
<li>group by</li>
<li>hanving</li>
<li>union，union all</li>
<li>子查询</li>
</ol>
<blockquote>
<p>视图可以在不改变原有数据的情况下，创建虚拟表</p>
<p>尽量使用MERGE视图算法，尽量不使用无法使用MERGE的SQL语句</p>
</blockquote>
<h1 id="第四章：这么查询速度更快"><a href="#第四章：这么查询速度更快" class="headerlink" title="第四章：这么查询速度更快"></a>第四章：这么查询速度更快</h1><h2 id="1-where查询太慢怎么办"><a href="#1-where查询太慢怎么办" class="headerlink" title="1.where查询太慢怎么办"></a>1.where查询太慢怎么办</h2><h3 id="1-1-覆盖索引"><a href="#1-1-覆盖索引" class="headerlink" title="1.1.覆盖索引"></a>1.1.覆盖索引</h3><ul>
<li>查询语句从执行到返回结果均使用同一个索引</li>
<li>覆盖索引可以有效减少回表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> store_id,film_id <span class="keyword">from</span> sakila.inventory <span class="keyword">where</span> store_id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6t7j9.png" alt="image-20221111223455412"></p>
<h3 id="索引解释详情"><a href="#索引解释详情" class="headerlink" title="*索引解释详情"></a>*索引解释详情</h3><ul>
<li>Extra<ul>
<li>Using index：使用了覆盖索引</li>
</ul>
</li>
</ul>
<blockquote>
<p>覆盖索引通过取消回表操作，提升查询效率</p>
<p>如数据的查询不只使用了一个索引，则不是覆盖索引</p>
<p>可以通过优化SQL语句或优化联合索引，来使用覆盖索引</p>
</blockquote>
<h2 id="2-有更合适的索引不走，怎么办？"><a href="#2-有更合适的索引不走，怎么办？" class="headerlink" title="2.有更合适的索引不走，怎么办？"></a>2.有更合适的索引不走，怎么办？</h2><h3 id="2-1-如何确定用那条索引"><a href="#2-1-如何确定用那条索引" class="headerlink" title="2.1.如何确定用那条索引"></a>2.1.如何确定用那条索引</h3><ul>
<li>MySQL在选取索引时，会考虑索引的基数(Cardinality)<ul>
<li>查看各个索引的基数<ul>
<li>show index from city_1;</li>
</ul>
</li>
</ul>
</li>
<li>基数是MySQL估算的，反映这个字段有多少种取值</li>
<li>怎么估算的：选取几个页算出取值的平均值，再乘以页数，即为基数</li>
<li>当MySQL在选择索引的时候，会选择基数更大的那一条索引</li>
</ul>
<h3 id="2-2-强制使用索引"><a href="#2-2-强制使用索引" class="headerlink" title="2.2.强制使用索引"></a>2.2.强制使用索引</h3><ul>
<li><p>MySQL的基数估算是有可能出错的，这个时候我们可以强制指定要使用的索引</p>
</li>
<li><p>force index(索引名)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> my force index(word) <span class="keyword">where</span> my<span class="operator">=</span><span class="number">1</span> ;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-3-优化索引"><a href="#2-3-优化索引" class="headerlink" title="2.3.优化索引"></a>2.3.优化索引</h3><ul>
<li>当基数估计出错的时候，也不想使用强制索引，这个时候可以让MySQL重新估计基数</li>
<li>**analyze table 表名;**可以重新统计索引信息</li>
<li>重新统计索引信息时，会重新计算索引的基数</li>
</ul>
<blockquote>
<p>根据索引基数，可以判断索引性能的好坏</p>
<p>使用force index可以强制使用索引</p>
<p>analyze table可以重新统计索引信息，修复基数信息</p>
</blockquote>
<h2 id="3-Count这么慢，怎么办"><a href="#3-Count这么慢，怎么办" class="headerlink" title="3.Count这么慢，怎么办"></a>3.Count这么慢，怎么办</h2><p>MySQL count()函数用来统计结果集中不为null的数据个数</p>
<blockquote>
<p>Count步骤</p>
</blockquote>
<ul>
<li><p>首先存储引擎查询出结果集</p>
</li>
<li><p>server层逐个判断是否为null，不为null则加一</p>
</li>
</ul>
<p><strong>count(非索引字段)时</strong>，server层需要判断每个数据是否为null，而且查询本身无法使用覆盖索引，理论上最慢</p>
<p><strong>count(索引字段)时</strong>，可以使用覆盖索引，依然需要每次判断字段是否为null</p>
<p><strong>count(主键)时</strong>，同理</p>
<p><strong>count(1)时</strong>，count(1)只扫描了索引树，没有解析数据行的过程，理论更快。但server层依然每次需要判断<code>1是否为空</code></p>
<p>*<em>count(</em>)**，一般用来返回数据表行数</p>
<ul>
<li>MyISAM的count(*)直接返回数据库中记录的数据表行数</li>
<li>由于InnoDB支持事物，数据库中不记录数据表行数</li>
<li>MySQL专门优化了count(*)函数直接返回索引树中数据的个数</li>
</ul>
<blockquote>
<p>count(非索引字段)：无法使用覆盖索引，最慢</p>
<p>count(索引字段)：可以使用覆盖索引 但依然要去除数据判空</p>
<p>count(1)：不需要去除数据，但要判断1是否为空</p>
<p>count(*)：经过专门优化，不需要判空，理论最快</p>
</blockquote>
<h2 id="4-ORDER-BY这么慢，怎么办"><a href="#4-ORDER-BY这么慢，怎么办" class="headerlink" title="4.ORDER BY这么慢，怎么办"></a>4.ORDER BY这么慢，怎么办</h2><blockquote>
<p>ORDER BY步骤原理</p>
</blockquote>
<p>例如：SELECT * FROM FILM WHERE  FILM_ID&gt;80 ORDER BY TITLE;</p>
<ol>
<li><p>根据WHERE等条件查询</p>
</li>
<li><p>将查询结果放入sort_buffer(专门用于排序的缓存)</p>
</li>
<li><p>对中间结果集按照ORDER字段排序</p>
</li>
<li><p>回表生成完整结果集(若需要)</p>
</li>
</ol>
<blockquote>
<p>优化步骤</p>
</blockquote>
<ol>
<li>条件查询<ul>
<li>给查询字段加索引，改善条件查询速度</li>
</ul>
</li>
<li>中间结果集<ul>
<li>中间表比较小时，直接放在内存中</li>
<li>比较大与sort_buffer_size时，会放在硬盘中</li>
<li>若需要优化内存占用，减少sort_buffer_size</li>
<li>若需要优化排序查询时间，增加sort_buffer_size</li>
</ul>
</li>
<li>回表生成完整结果集  <ul>
<li>当行小于max_length_for_sort_data时，生成全字段结果集</li>
<li>当行大于max_length_for_sort_data时，只生成排序字段+主键中间表，需要回表</li>
<li>调大阈值并不一定改善效率，因为太大的结果集排序效率低</li>
</ul>
</li>
<li>最高效-索引覆盖<ul>
<li>索引覆盖可以跳过生成中间结果集，直接输出查询结果</li>
<li>ORDER字段需要有索引，或在联合索引左侧(和查询条件索引一致)</li>
<li>其他相关字段(条件、输出)均在上述的索引中</li>
<li><strong>满足以上条件即可使用索引覆盖</strong></li>
</ul>
</li>
</ol>
<blockquote>
<p>中间结果集是一个<strong>临时表</strong>，不存在任何索引。但是满足条件可以使用索引覆盖</p>
<p>MySQL一般需要生成中间结果集、排序、回表的过程</p>
<p>索引覆盖式最高效的处理排序的方式</p>
</blockquote>
<h2 id="5-随机选取这么慢，怎么办"><a href="#5-随机选取这么慢，怎么办" class="headerlink" title="5.随机选取这么慢，怎么办"></a>5.随机选取这么慢，怎么办</h2><ul>
<li>select RAND():输出一个0-1的随机值</li>
</ul>
<blockquote>
<p>ORDER BY RAND()原理</p>
</blockquote>
<p>例如：SELECT TITLE,DESCRIPTION FROM FILM ORDER BY RAND() LIMIT 1;</p>
<ol>
<li><p>创建一个临时表，临时表的字段为rand、title、description</p>
</li>
<li><p>从表中取出一行，调用RAND()将结果和数据放入临时表，依次类推</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6t2re.png" alt="image-20221112010820054"></p>
</li>
<li><p>针对临时表，将rand字段+行位置(主键)放入sort_buffer</p>
<ul>
<li>如果临时表为内存表，则有行位置</li>
<li>如果为磁盘表，则有主键(临时表)</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6t4oz.png" alt="image-20221112011100861"></p>
</li>
<li><p>对sort_buffer排序，取出第一个的行位置(主键)，查询临时表</p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6t79w.png" alt="image-20221112011446031"></p>
<blockquote>
<p>为什么会慢</p>
</blockquote>
<ul>
<li>SQl执行过程中出现了两次中间结果，都是全长度的</li>
<li>仅需要一个随机结果，却经历了不必要的排序(虽然优化过)</li>
<li>调用了很多次RAND()</li>
</ul>
<blockquote>
<p>优化</p>
</blockquote>
<ol>
<li><p>临时方案</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 设置film_id的最大值和最小值的变量</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(film_id),<span class="built_in">min</span>(film_id) <span class="keyword">into</span> <span class="variable">@M</span>,<span class="variable">@N</span> <span class="keyword">from</span> film;</span><br><span class="line"></span><br><span class="line"># 给最大值和最小值中间随机取出的数赋给变量</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@X</span><span class="operator">=</span><span class="built_in">floor</span>((<span class="variable">@M</span><span class="operator">-</span><span class="variable">@N</span><span class="operator">+</span><span class="number">1</span>)<span class="operator">*</span>rand()<span class="operator">+</span><span class="variable">@N</span>);</span><br><span class="line"></span><br><span class="line"># 在大于随机值中取出第一个，因为可能中间数据不连续</span><br><span class="line"><span class="keyword">select</span> title,description <span class="keyword">from</span> film <span class="keyword">where</span> film_id <span class="operator">&gt;=</span> <span class="variable">@X</span> limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务方案</p>
<ol>
<li><p>查询数据表总数total</p>
</li>
<li><p>total范围内，随机选取一个数字r</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="variable">@T</span> <span class="operator">=</span> <span class="built_in">floor</span>((<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> film) <span class="operator">*</span> rand());</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行一下SQL</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> title,description <span class="keyword">from</span> film limit r,<span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<blockquote>
<p>ORDER BY RAND() LIMIT 1是效率很低的随机查询方式</p>
<p>原因主要是，上述方法有两次中间结果，还有排序过程</p>
<p>可以通过修改SQL，选取随机主键方式，提升性能</p>
<p>最好还是在业务中处理，尽量减少复杂SQL</p>
</blockquote>
<h2 id="6-带头大哥丢了，怎么办"><a href="#6-带头大哥丢了，怎么办" class="headerlink" title="6.带头大哥丢了，怎么办"></a>6.带头大哥丢了，怎么办</h2><h3 id="6-1-索引下推"><a href="#6-1-索引下推" class="headerlink" title="6.1.索引下推"></a>6.1.索引下推</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 建表语句与插入语句</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `inventory_3` (</span><br><span class="line">  `inventory_id` mediumint unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `film_id` <span class="type">smallint</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `store_id` tinyint unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `last_update` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`inventory_id`),</span><br><span class="line">  KEY `idx_store_id_film_id` (`store_id`,`film_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">101</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> inventory_3 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sakila.inventory;</span><br><span class="line"></span><br><span class="line"># 查询语句</span><br><span class="line"># <span class="number">5.6</span>之前，需要先使用索引查询store_id <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>)再全部回表验证film_id<span class="operator">=</span><span class="number">3</span></span><br><span class="line"># 在<span class="number">5.6</span>之后，如果索引中可以判断，直接使用索引过滤</span><br><span class="line"># Extra：<span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> inventory_3 <span class="keyword">where</span> store_id <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">and</span> film_id<span class="operator">=</span><span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6t6t6.png" alt="image-20221112142155596"></p>
<h3 id="6-2-松散索引扫描"><a href="#6-2-松散索引扫描" class="headerlink" title="6.2.松散索引扫描"></a>6.2.松散索引扫描</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 查询语句</span><br><span class="line"># 丢失带头大哥，不能走联合索引</span><br><span class="line"><span class="keyword">select</span> film_id <span class="keyword">from</span> inventory_3 <span class="keyword">where</span> film_id<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 松散扫描</span><br><span class="line"># MySQL8<span class="number">.0</span>新特性</span><br><span class="line"># 在MySQL8<span class="number">.0</span>中，使用上述查询语句可以使用松散索引扫描，大大减少扫描行数</span><br><span class="line"># Extra:<span class="keyword">Using</span> index fro <span class="keyword">skip</span> scan:松散索引扫描</span><br><span class="line"># 在松散索引扫描中，也是走联合索引</span><br><span class="line"># 例如上述表中使用松散索引扫描，先在store_id确定，例如在store_id<span class="operator">=</span><span class="number">1</span>中，扫描film_id字段</span><br><span class="line"># 因为这两个字段是联合索引，所以只要带头大哥确认，film_id字段就能有序，更好查找，能有效减少扫描行数</span><br></pre></td></tr></table></figure>



<blockquote>
<p>联合索引可以加速一些特殊查询场景</p>
<p>索引下推可以大大减少回表次数</p>
<p>松散索引扫描可以打破<code>左侧原则</code>，解决带头大哥丢失问题(8.0)</p>
</blockquote>
<h2 id="7-明明有索引，就是不走，怎么办"><a href="#7-明明有索引，就是不走，怎么办" class="headerlink" title="7.明明有索引，就是不走，怎么办"></a>7.明明有索引，就是不走，怎么办</h2><blockquote>
<p>select * from film where film_id + 1 &#x3D;100</p>
</blockquote>
<ul>
<li>不会走索引，全表扫描</li>
<li>对函数字段做函数操作，优化器会放弃索引</li>
</ul>
<blockquote>
<p>select * from rental where month(rental_date)&#x3D;5</p>
</blockquote>
<ul>
<li>使用month()函数后，无法使用索引</li>
<li>如果需要查询时间，需要去掉month()</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> rental <span class="keyword">where</span> rental_date <span class="keyword">between</span> <span class="string">&#x27;2005-5-1&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2005-6-1&#x27;</span></span><br><span class="line"><span class="keyword">or</span> return_date <span class="keyword">between</span> <span class="string">&#x27;2006-5-1&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2006-6-1&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h3 id="7-1-字符串与数字比较"><a href="#7-1-字符串与数字比较" class="headerlink" title="7.1.字符串与数字比较"></a>7.1.字符串与数字比较</h3><blockquote>
<p>select * from t1 where f1&#x3D;6;</p>
</blockquote>
<ul>
<li><p>MySQL中若出现字符串与数字比较，会将字符串转换为数字</p>
</li>
<li><p>如果t1表中f1字段为varchar类型，则此SQL相当于</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> <span class="built_in">CAST</span>(f1 <span class="keyword">AS</span> signed <span class="type">int</span>)<span class="operator">=</span><span class="number">6</span></span><br><span class="line"># <span class="built_in">CAST</span>(f1 <span class="keyword">AS</span> signed <span class="type">int</span>):强制转换为<span class="type">int</span>类型</span><br><span class="line"># <span class="keyword">convert</span>(<span class="number">6</span> ,<span class="type">char</span>)：把数字强转为字符串</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案：把6换成’6’</p>
</li>
</ul>
<h3 id="7-2-隐式字符编码转换"><a href="#7-2-隐式字符编码转换" class="headerlink" title="7.2.隐式字符编码转换"></a>7.2.隐式字符编码转换</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 建t1表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(</span><br><span class="line">    f1 <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    f2 <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> ,</span><br><span class="line">    key idx_f1(f1),</span><br><span class="line">    key idx_f2(f2)</span><br><span class="line">)engine<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"># 建t2表，注意字符集不一样</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2(</span><br><span class="line">    f1 <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    f2 <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> ,</span><br><span class="line">    key idx_f1(f1),</span><br><span class="line">    key idx_f2(f2)</span><br><span class="line">)engine<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"># 插入相关数据，进行查询</span><br><span class="line">explain <span class="keyword">select</span> t2.<span class="operator">*</span> <span class="keyword">from</span> t1,t2 <span class="keyword">where</span> t1.f1<span class="operator">=</span>t2.f1 <span class="keyword">and</span> t1.f2<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"># 结果</span><br><span class="line"><span class="number">1</span>,SIMPLE,t1,,<span class="keyword">ref</span>,&quot;idx_f1,idx_f2&quot;,idx_f2,<span class="number">4</span>,const,<span class="number">1</span>,<span class="number">100</span>,</span><br><span class="line"><span class="number">1</span>,SIMPLE,t2,,<span class="keyword">ALL</span>,idx_f1,,,,<span class="number">3</span>,<span class="number">33.33</span>,<span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (hash <span class="keyword">join</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按说，确认t1表行数据后，再对t2表数据查询f1字段会进行索引查询，为什么会按照全表查询？</p>
</blockquote>
<ul>
<li><p>MySQL中，utf8与utf8mb4字段比较时，会把utf8转为utf8mb4</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select t2.* from t1,t2 where t1.f1=t2.f1 and t1.f2=3;</span><br><span class="line"></span><br><span class="line"># 相当于</span><br><span class="line"></span><br><span class="line">select t2.* from t1,t2 where t1.f1=convert(t2.f1 USING utf8mb4) and t1.f2=3;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案：将查询条件转换为索引字段的编码</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t2.<span class="operator">*</span> <span class="keyword">from</span> t1,t2 <span class="keyword">where</span> <span class="keyword">convert</span>(t1.f1 <span class="keyword">USING</span> utf8)<span class="operator">=</span>t2.f1 <span class="keyword">and</span> t1.f2<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"># 结果</span><br><span class="line"><span class="number">1</span>,SIMPLE,t1,,<span class="keyword">ref</span>,idx_f2,idx_f2,<span class="number">4</span>,const,<span class="number">1</span>,<span class="number">100</span>,</span><br><span class="line"><span class="number">1</span>,SIMPLE,t2,,<span class="keyword">ref</span>,idx_f1,idx_f1,<span class="number">98</span>,func,<span class="number">1</span>,<span class="number">100</span>,<span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>MySQL中，对索引字段做函数操作，优化器会放弃索引</p>
<p>这种情况可能包括：时间函数，字符串转数字，字符编码转换</p>
<p>解决方案：时间函数转区间、数字强转字符串、高级编码转低级</p>
</blockquote>
<h2 id="8-分页查询这么慢，这么办"><a href="#8-分页查询这么慢，这么办" class="headerlink" title="8.分页查询这么慢，这么办"></a>8.分页查询这么慢，这么办</h2><blockquote>
<p>偏移量大时，效率低</p>
</blockquote>
<p>例如：select film_id,title,description from film order by title limit 900,10;</p>
<ul>
<li>执行前面的语句，在执行limit操作</li>
<li>丢弃很多无用数据，效率低下</li>
</ul>
<blockquote>
<p>优化策略</p>
</blockquote>
<ul>
<li><p>先想办法走索引覆盖</p>
</li>
<li><p>得到所需数据的ID</p>
</li>
<li><p>根据所需数据的ID，得到最终结果集</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 优化SQL语句</span><br><span class="line"># 得到所需数据的主键</span><br><span class="line">select film_id from film order by title limit 900,10;</span><br><span class="line"></span><br><span class="line"># 原表与上面的结果链表，获取最终结果</span><br><span class="line">select f.film_id,f.title,f.description from file f</span><br><span class="line">inner join (select film_id from film order by title limit 900,10) m</span><br><span class="line">on f.film_id = m.film_id;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>排序偏移量大时，会丢弃大量无用数据，导致效率低下</p>
<p>当索引不可随便改动时，可以采用先索引覆盖，再用最终ID回表的方法，优化效率</p>
</blockquote>
<h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9.总结"></a>9.总结</h2><blockquote>
<p>慢查询的怀疑方向</p>
</blockquote>
<ol>
<li>索引设计有问题</li>
<li>SQL语句有问题</li>
<li>数据库选错索引</li>
</ol>
<h1 id="第五章：如何处理数据更新"><a href="#第五章：如何处理数据更新" class="headerlink" title="第五章：如何处理数据更新"></a>第五章：如何处理数据更新</h1><h2 id="1-数据库”动起来”之后，会发生什么"><a href="#1-数据库”动起来”之后，会发生什么" class="headerlink" title="1. 数据库”动起来”之后，会发生什么"></a>1. 数据库”动起来”之后，会发生什么</h2><blockquote>
<p>产生日志数据</p>
</blockquote>
<ul>
<li>数据库在更新时，会产生binlog、redo log、undo log</li>
<li>binlog：server层产生的逻辑日志</li>
<li>redo log：InnoDB产生的物理日志。保证持久化</li>
<li>undo log：InnoDB产生的逻辑日志，保证隔离性、原子性</li>
</ul>
<blockquote>
<p>客户端之间因为锁而相互影响</p>
</blockquote>
<ul>
<li>客户端执行SQL时，会产生各种行锁、表锁、原数据锁</li>
<li>一个客户端产生的锁，会干扰其他客户端SQL的执行</li>
<li>两个客户端之间可能产生死锁</li>
</ul>
<blockquote>
<p>事务造成查询到的数据与磁盘上不一致</p>
</blockquote>
<ul>
<li>客户顿可能暂时看不到已经更新的数据</li>
<li>事务可能产生隐式锁，造成性能问题</li>
</ul>
<blockquote>
<p> 数据库”动起来”之后，会产生一系列性能问题</p>
<p>需要理解日志、锁、事务的底层原理，才能应对问题</p>
</blockquote>
<h2 id="2-什么日志不是给人看的"><a href="#2-什么日志不是给人看的" class="headerlink" title="2.什么日志不是给人看的"></a>2.什么日志不是给人看的</h2><blockquote>
<p>MySQL日志体系</p>
</blockquote>
<ul>
<li>MySQL为了满足主从复制、事务等，有复杂的日志体系</li>
<li>Server层产生binlog，用来进行数据复制</li>
<li>InnoDB产生undo log、redo log，用来实现事务ACID</li>
</ul>
<h3 id="2-1-binlog-归档日志"><a href="#2-1-binlog-归档日志" class="headerlink" title="2.1.binlog 归档日志"></a>2.1.binlog 归档日志</h3><ul>
<li><p>binlog是server层产生的<strong>逻辑日志</strong></p>
</li>
<li><p>用来进行数据复制和数据传送</p>
</li>
<li><p>binlog完整记录了数据库每次的数据操作，可作为<code>数据闪回</code>手段</p>
</li>
</ul>
<h3 id="2-2-undo-log-回滚日志"><a href="#2-2-undo-log-回滚日志" class="headerlink" title="2.2.undo log 回滚日志"></a>2.2.undo log 回滚日志</h3><ul>
<li>InnoDB自身产生的<strong>逻辑日志</strong>，用于事务回滚和展示旧版本</li>
<li>对任何数据(缓存)的更新，都先写undo log</li>
<li>undo log位于表空间的undo segment中</li>
<li>SQL：UPDATE name&#x3D;’b’—-&gt;undo：UPDATE name&#x3D;’a’(记录相反的数据变化情况)</li>
</ul>
<h3 id="2-3-redo-log-重做日志"><a href="#2-3-redo-log-重做日志" class="headerlink" title="2.3.redo log 重做日志"></a>2.3.redo log 重做日志</h3><ul>
<li>InnoDB自身产生的<strong>物理日志</strong>，记录数据页的变化</li>
<li>InnoDB”<code>日志优先于数据</code>“，记录redo log视为数据已经更新</li>
<li>内存中的数据更新后写redo log，数据被写入硬盘后删除</li>
<li>redo log存储在4个1GB文件中，并且循环写入</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6t7gr.png" alt="image-20221112213140645"></p>
<h2 id="3-数据更新流程"><a href="#3-数据更新流程" class="headerlink" title="3.数据更新流程"></a>3.数据更新流程</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6t4qe.png" alt="image-20221112213538274"></p>
<h3 id="3-1-redo-log-刷盘"><a href="#3-1-redo-log-刷盘" class="headerlink" title="3.1.redo log 刷盘"></a>3.1.redo log 刷盘</h3><ul>
<li><p>innodb_flush_log_at_trx_commit参数控制redo log刷盘</p>
<ul>
<li>0：异步每秒刷盘</li>
<li>1：每一个事务刷盘</li>
<li>N：没N个事务刷盘</li>
</ul>
</li>
<li><p><code>建议设置为1，保证数据安全</code></p>
</li>
</ul>
<h3 id="3-2-binlog-刷盘"><a href="#3-2-binlog-刷盘" class="headerlink" title="3.2.binlog 刷盘"></a>3.2.binlog 刷盘</h3><ul>
<li><p>sync_binlog参数控制刷盘</p>
<ul>
<li><p>0：异步每秒刷盘</p>
</li>
<li><p>1：每一个事务刷盘</p>
</li>
<li><p>N：没N个事务刷盘</p>
</li>
</ul>
</li>
<li><p><code>建议设置为1，保证数据安全</code></p>
</li>
</ul>
<h3 id="3-3-持久化分析"><a href="#3-3-持久化分析" class="headerlink" title="3.3.持久化分析"></a>3.3.持久化分析</h3><ul>
<li><p>redo log刷盘前系统崩溃</p>
<ul>
<li>数据丢失</li>
</ul>
</li>
<li><p>redo log刷盘后系统崩溃</p>
<ul>
<li>重启时会对redo log进行重写、重写内存中数据页、重写binlog</li>
</ul>
</li>
<li><p>为什么redo log在binlog之前</p>
<ul>
<li>redo log是系统关键节点，相当于”决断点”</li>
<li>binlog一旦写入无法撤回，因为可能已经被传送至备库</li>
</ul>
</li>
</ul>
<blockquote>
<p>MySQL日志主要由binlog、undo log、redo log</p>
<p>MySQL实行日志优先(WAL)的策略，日志刷盘，数据就不会丢失</p>
</blockquote>
<h2 id="4-锁：怎样平衡功能与性能"><a href="#4-锁：怎样平衡功能与性能" class="headerlink" title="4.锁：怎样平衡功能与性能"></a>4.锁：怎样平衡功能与性能</h2><blockquote>
<p>MySQL锁的种类</p>
</blockquote>
<ul>
<li>按照粒度，MySQL锁可以分为全局锁、表级锁、行锁</li>
<li>全局锁会锁住整个库，整个库无法修改</li>
<li>表级锁分为表锁(数据锁)和元数据锁</li>
<li>行锁会锁住数据行，分为共享锁和独占锁</li>
</ul>
<blockquote>
<p>全局锁</p>
</blockquote>
<ul>
<li>FTWRL(Flush tables with read lock)</li>
<li>此命令使整个库处于只读状态</li>
<li>主要用途是保证备份的一致性</li>
<li>不要随意使用，杀伤性极大，要在备库中使用</li>
</ul>
<blockquote>
<p>表级锁(数据锁)</p>
</blockquote>
<ul>
<li>命令 ：lock tables 表名 read&#x2F;write</li>
<li>表锁是非常重的表，在InnoDB中使用很少</li>
</ul>
<blockquote>
<p>元数据锁(matadata lock)</p>
</blockquote>
<ul>
<li>元数据指的是表的结构、字段、数据类型、索引等</li>
<li>事务访问数据时，会自动给表加MDL读锁</li>
<li>事务修改元数据时，会自动给表加MDL写锁，修改完会自动释放</li>
</ul>
<blockquote>
<p>行锁</p>
</blockquote>
<ul>
<li>行锁也有两种类型，有很多其他叫法：<ul>
<li>读锁&#x2F;写锁</li>
<li>共享锁&#x2F;排它锁</li>
<li>共享锁&#x2F;独占锁</li>
<li>S锁&#x2F;X锁</li>
</ul>
</li>
<li>S锁不是不让读，而是自己要读，不让别人写</li>
<li>X锁不只是不让写，而是自己要写，不让别人读写</li>
<li>只有S锁和S锁之间可以兼容，其他均不兼容</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tg1t.png" alt="image-20221112225420195"></p>
<blockquote>
<p>锁是MySQL高效率执行事务的必备基础</p>
<p>锁会引发很多的性能问题，可能造成等待和死锁</p>
<p>锁还会引发很多的功能问题，如脏读和不可重复读等</p>
</blockquote>
<h2 id="5-事务：InnoDB的杀手锏"><a href="#5-事务：InnoDB的杀手锏" class="headerlink" title="5.事务：InnoDB的杀手锏"></a>5.事务：InnoDB的杀手锏</h2><blockquote>
<p>事务的特性</p>
</blockquote>
<ul>
<li><p>原子性(Atomicity)</p>
</li>
<li><p>一致性(Consistency)</p>
</li>
<li><p>隔离性(Isolation)</p>
</li>
<li><p>持久性(Durability)</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tacm.png"></p>
<blockquote>
<p>原子性(Atomicity)</p>
</blockquote>
<ul>
<li>事务要么全部成功，要么全部失败</li>
<li>MySQL的两阶段提交保证了事务的原子性</li>
<li>undo log用来回滚事务的更改</li>
</ul>
<blockquote>
<p>一致性(Consistency)</p>
</blockquote>
<ul>
<li>事务必须使数据库从一个一致性状态变换到另一个一致性状态 </li>
<li>锁和两阶段提交保证了一致性</li>
</ul>
<blockquote>
<p>隔离性(Isolation)</p>
</blockquote>
<ul>
<li><p>事务不能被其他事物的操作数据所干扰</p>
</li>
<li><p>多个并发事务之间要相互隔离</p>
</li>
<li><p>锁和undo log实现了MySQL事务的隔离性</p>
</li>
</ul>
<blockquote>
<p>持久性(Durability)</p>
</blockquote>
<ul>
<li>一个事物一旦被提交，它对数据库中数据的改变就是永久的</li>
<li>redo log实现了MySQL事务的持久性</li>
</ul>
<h2 id="6-隔离级别"><a href="#6-隔离级别" class="headerlink" title="6.隔离级别"></a>6.隔离级别</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 查看隔离级别</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"></span><br><span class="line"># 设置全局的隔离级别</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level 隔离级别名称;</span><br><span class="line"></span><br><span class="line"># 设置会话级别隔离 </span><br><span class="line"><span class="keyword">set</span> session transaction isolation level 隔离级别</span><br><span class="line"></span><br><span class="line"># 设置一次操作的级别</span><br><span class="line"><span class="keyword">set</span> transaction isolation level 隔离级别</span><br></pre></td></tr></table></figure>

<blockquote>
<p>隔离级别</p>
</blockquote>
<ul>
<li>读未提交(READ UNCOMMITTED)</li>
<li>读提交(READ COMMITED)</li>
<li>可重复度(REPEATABLE READ)</li>
<li>串行化(SERIALIZABLE)</li>
</ul>
<blockquote>
<p>读未提交(READ UNCOMMITTED)</p>
</blockquote>
<ul>
<li>读、写都不加锁，不隔离</li>
<li>每次查询都查询到数据的最新版本</li>
<li>性能最好，但是等于没有事务，很少采用</li>
</ul>
<blockquote>
<p>读提交(READ COMMITED)</p>
</blockquote>
<ul>
<li>一般读取时，读取此时已经提交的数据</li>
<li>写数据时，加X锁，提交时释放</li>
<li>Oracle默认隔离级别</li>
</ul>
<blockquote>
<p>可重复度(REPEATABLE READ)</p>
</blockquote>
<ul>
<li>一般读取时，读取本事务开始时的数据状态</li>
<li>写数据时，加X锁，提交时释放</li>
<li>MySQL默认的隔离级别</li>
</ul>
<blockquote>
<p>串行化(SERIALIZABLE)</p>
</blockquote>
<ul>
<li>读加S锁，写加X锁，提交时释放</li>
<li>对于一条数据，同时只能有一个事物进行写操作</li>
<li>事物隔离性最高，性能太差，很少采用</li>
</ul>
<blockquote>
<p>事物是InnoDB最核心的功能点</p>
<p>事物也是引发性能问题最多的点</p>
<p>读提交和可重复读是如何查询到历史版本的，需要提交</p>
</blockquote>
<h2 id="7-MVCC是怎样做到千人千面的"><a href="#7-MVCC是怎样做到千人千面的" class="headerlink" title="7.MVCC是怎样做到千人千面的"></a>7.MVCC是怎样做到千人千面的</h2><p>MVCC是多版本并发控制（Multi-Version Concurrency Control）的缩写。它是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问。</p>
<blockquote>
<p>行记录的版本控制</p>
</blockquote>
<ul>
<li>由于undo log的存在，可以从最新版本推算之前版本</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6taij.png" alt="image-20221113131523484"></p>
<h3 id="7-1-快照读-一致性非锁定读"><a href="#7-1-快照读-一致性非锁定读" class="headerlink" title="7.1.快照读(一致性非锁定读)"></a>7.1.快照读(一致性非锁定读)</h3><ul>
<li>不锁定数据的情况下，读取数据的特定历史版本</li>
<li>版本由事务的具体需求确定：<ul>
<li>读已提交：根据每次SELECT时，其他事物的提交情况</li>
<li>可持续读：根据事务开始时，其他事物的提交情况</li>
</ul>
</li>
</ul>
<h3 id="7-2-当前读-一致性锁定读"><a href="#7-2-当前读-一致性锁定读" class="headerlink" title="7.2.当前读(一致性锁定读)"></a>7.2.当前读(一致性锁定读)</h3><ul>
<li><p>读取数据的当前版本，并加锁</p>
</li>
<li><p>串行化(SERIALIZABLE)都是当前读</p>
</li>
<li><p>若当前版本已经被加锁且不兼容，则阻塞等待</p>
</li>
<li><p>X锁：UPDATE、DELETE、SELECT FOR UPDATE</p>
</li>
<li><p>S锁：SELECT LOCK IN SHARE MOOD</p>
</li>
</ul>
<h2 id="8-隔离问题"><a href="#8-隔离问题" class="headerlink" title="8.隔离问题"></a>8.隔离问题</h2><ul>
<li>脏读：读到了其他事物未提交的数据</li>
<li>不可重复读：同样的查询读到的数据内容不一样</li>
<li>幻读：同样的查询读到了更多的数据</li>
</ul>
<blockquote>
<p>MySQL不同隔离级别的问题</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tbq8.png" alt="image-20221113133854567"></p>
<h3 id="8-1-如何解决幻读问题"><a href="#8-1-如何解决幻读问题" class="headerlink" title="8.1.如何解决幻读问题"></a>8.1.如何解决幻读问题</h3><ul>
<li>MySQL在可重复读级别时，通过Next-Key锁解决了幻读问题</li>
<li>Next-Key锁是行锁+间隙锁</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tbnf.png" alt="image-20221113135155709"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tbjm.png" alt="image-20221113135211468"></p>
<ul>
<li><p>间隙锁的功能与行锁相同，只是针对间隙加锁 </p>
</li>
<li><p>间隙锁不分读写，也可以认为是读锁，不允许在间隙插入</p>
</li>
<li><p>可重复读加锁时，将同时锁住数据及其左右间隙</p>
</li>
</ul>
<blockquote>
<p>InnoDB使用undo log实现了行记录历史查询</p>
<p>快照读不需加锁，属于乐观锁的一种思路</p>
<p>当前读需加行锁，为了并发控制</p>
<p>Next-Key锁解决了可重复读下的幻读问题</p>
</blockquote>
<h2 id="9-间隙锁把全表都锁住了，怎么办"><a href="#9-间隙锁把全表都锁住了，怎么办" class="headerlink" title="9.间隙锁把全表都锁住了，怎么办"></a>9.间隙锁把全表都锁住了，怎么办</h2><blockquote>
<p>Next-Key Lock的加锁逻辑</p>
</blockquote>
<ol>
<li>加锁时以Next-Key为基本单位</li>
<li>查找过程中扫描过的范围才加锁</li>
<li>唯一索引等值查询，没有间隙锁，只加行锁  </li>
<li>索引等值查询最右一个扫描到的不满足条件值不加行锁</li>
<li>索引覆盖且只加S锁时，不锁主键索引</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tag6.png" alt="image-20221113141412997"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tjuq.png" alt="image-20221113142401849"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tir5.png" alt="image-20221113143315723"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tnza.png" alt="image-20221113143417399"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tkry.png" alt="image-20221113143816191"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w6tkk4.png" alt="image-20221113143934688"></p>
<blockquote>
<p>目的：在可重复读的隔离级别下部分预防幻读</p>
<p>手段：Next-Key Lock(行锁+间隙锁)</p>
<p>特点：规则复杂</p>
<p>注意：当前读时，不要查询没有索引的项目</p>
</blockquote>
<h2 id="10-MySQL也有”垃圾回收”嘛"><a href="#10-MySQL也有”垃圾回收”嘛" class="headerlink" title="10.MySQL也有”垃圾回收”嘛"></a>10.MySQL也有”垃圾回收”嘛</h2><blockquote>
<p>MySQL的”垃圾回收”</p>
</blockquote>
<ul>
<li><strong>MySQL并没有所谓的垃圾回收</strong></li>
<li>但是会发现数据卡几秒，磁盘IO很高</li>
<li>此时MySQL正在<code>&quot;刷脏页&quot;</code></li>
</ul>
<h3 id="10-1-脏页"><a href="#10-1-脏页" class="headerlink" title="10.1.脏页"></a>10.1.脏页</h3><ul>
<li>更新数据时，只更新了内存中的数据页，没有更新磁盘</li>
<li>内存中数据页与磁盘中数据页不一致，称为脏页</li>
</ul>
<blockquote>
<p>什么是刷脏</p>
</blockquote>
<ul>
<li>将内存中数据页保存至磁盘</li>
<li>同时删除与此页相关的redo log，推进check point</li>
</ul>
<blockquote>
<p>为什么要刷脏</p>
</blockquote>
<ol>
<li><p>内存中的脏页太多，内存不足</p>
</li>
<li><p>redo log文件写满，需要推进check point</p>
</li>
<li><p>系统空闲，提前刷脏，预防上述情况</p>
</li>
<li><p>MySQL关闭前，保存数据</p>
</li>
<li><p>前两种会产生性能问题，导致MySQL卡住</p>
</li>
</ol>
<blockquote>
<p>如何避免被迫刷脏</p>
</blockquote>
<ol>
<li>正确告知InnoDB，服务器的硬盘性能</li>
<li>配置合理的脏页比例上限</li>
<li>控制”顺便刷脏”策略</li>
</ol>
<blockquote>
<p>服务器Io配置</p>
</blockquote>
<ul>
<li>配置项：innodb_io_capacity</li>
<li>用来告知服务器的硬盘性能</li>
<li>linux可以使用fio工具测试服务器磁盘性能</li>
<li>常见IOPS(每秒IO)：<ul>
<li>7200rpm SATA，70 IOPS</li>
<li>10000rpm FC，125IOPS</li>
<li>SSD SATA，300-40000 IOPS</li>
</ul>
</li>
</ul>
<blockquote>
<p>配置合理的脏页比例上限</p>
</blockquote>
<ul>
<li>配置：innodb_max_dirty_pages_pct</li>
<li>脏页与磁盘中数据的比例</li>
<li>当脏页比例接近此值，会加速刷脏页</li>
<li>最好为75%</li>
</ul>
<blockquote>
<p>控制”顺便刷脏”策略</p>
</blockquote>
<ul>
<li><p>配置：innodb_flush_neighbors</p>
</li>
<li><p>传统的磁盘连续写性能最好，尽量刷连续的页</p>
</li>
<li><p>SSD建议设为0</p>
</li>
</ul>
<blockquote>
<p>刷脏可能会导致MySQL卡住，造成性能问题</p>
<p>通过告知服务器IO性能，可以控制合理刷脏IO</p>
<p>合理的脏页比例上限，建议保存默认</p>
<p>“顺便刷脏”功能需在SSD下关闭</p>
</blockquote>
<h2 id="11-长事务有哪些危害"><a href="#11-长事务有哪些危害" class="headerlink" title="11.长事务有哪些危害"></a>11.长事务有哪些危害</h2><blockquote>
<p>主要危害：锁无法释放</p>
</blockquote>
<ul>
<li>行级锁长时间无法释放，导致其他事物等待</li>
<li>容易产生死锁</li>
<li>MDL锁hold住大量事务，造成MySQL崩溃</li>
</ul>
<blockquote>
<p>行级锁长时间无法释放</p>
</blockquote>
<ul>
<li>当前读会对数据加锁，事务提交前无法释放</li>
<li>其他事物更新相同数据时会等待锁，造成更新性能差</li>
</ul>
<blockquote>
<p>解决方案</p>
</blockquote>
<ul>
<li>调整innodb_lock_wait_timeout参数</li>
<li>默认为50，即等待50秒还未获取锁，当前语句报错</li>
<li>如果等待时间过长，可以适当缩短此参数</li>
</ul>
<blockquote>
<p>容易产生死锁</p>
</blockquote>
<ul>
<li><p>长事务的锁长时间不释放，任意与其他事物产生死锁</p>
</li>
<li><p>死锁指的是两个事务都依赖对方的锁释放</p>
</li>
</ul>
<blockquote>
<p>解决方案</p>
</blockquote>
<ul>
<li>主动死锁检测：innodb_deadlock_detect</li>
<li>发现死锁时会回滚代价较小的事物</li>
<li>默认开启</li>
</ul>
<blockquote>
<p>MDL锁</p>
</blockquote>
<ul>
<li><p>事务访问数据时，会自动给表加MDL锁</p>
</li>
<li><p>事务修改元数据时，会自动给表加MDL写锁</p>
</li>
<li><p>遇到锁不兼容时，申请MDL锁的事物形成一个队列</p>
</li>
</ul>
<blockquote>
<p>解决方案</p>
</blockquote>
<ul>
<li>alter table之前，查看是否有长事务还未提交</li>
<li>查看长事务：information_schema库innodb_trx表</li>
</ul>
<blockquote>
<p>如何查看影响性能的锁</p>
</blockquote>
<ul>
<li><p>查看长事务：information_schema库innodb_trx表</p>
</li>
<li><p>查看锁：information_schema库INNODB_LOCKS表</p>
</li>
<li><p>查看阻塞上的事务：information_schema库INNODB_LOCK_WAITS表</p>
</li>
<li><p>查看锁(8.0)：performance_schema.data_locks</p>
</li>
<li><p>查看锁等待：performance_schema.data_lock_waits</p>
</li>
<li><p>查看MDL锁：performance_schema.metadata_locks</p>
</li>
</ul>
<blockquote>
<p>业务建议</p>
</blockquote>
<ul>
<li>控制长事务，没有必要的情况下不开启事务</li>
<li>数据修改(当前读)尽量放在事务后部，降低锁时间</li>
</ul>
<blockquote>
<p>长事务可能会造成行锁(死锁)、MDL锁等待</p>
<p>可以通过参数调整，减低锁影响</p>
<p>可以通过系统表识别长事务和锁</p>
<p>业务上尽量将加锁的操作后移，降低锁时间</p>
</blockquote>
<h1 id="第六章：ORM框架原理"><a href="#第六章：ORM框架原理" class="headerlink" title="第六章：ORM框架原理"></a>第六章：ORM框架原理</h1><h2 id="1-ORM基础"><a href="#1-ORM基础" class="headerlink" title="1.ORM基础"></a>1.ORM基础</h2><blockquote>
<p>什么是ORM</p>
</blockquote>
<ul>
<li>对象(Object)</li>
<li>关系(Relational)</li>
<li>映射(Mapping)</li>
<li>对象与关系型数据库的映射关系</li>
</ul>
<blockquote>
<p>著名的ORM框架</p>
</blockquote>
<ul>
<li><p>Java：Mybatis，Hibernate</p>
</li>
<li><p>Python：Django，SQLAlchemy</p>
</li>
<li><p>GO：GORM</p>
</li>
</ul>
<blockquote>
<p>ORM框架的意义</p>
</blockquote>
<ul>
<li>将数据库操作与程序员编码解耦，提高开发效率</li>
<li>自动拼装生成SQL语句，避免SQL注入风险</li>
<li>自动管理数据库连接、自动重试、自动回滚等操作</li>
<li>自动管理事务</li>
</ul>
<h2 id="2-ORM框架是怎么设计的"><a href="#2-ORM框架是怎么设计的" class="headerlink" title="2.ORM框架是怎么设计的"></a>2.ORM框架是怎么设计的</h2><blockquote>
<p>ORM框架-架构层次</p>
</blockquote>
<ul>
<li>接口层：向上支持程序调用</li>
<li>处理层：参数映射—&gt;SQL生成—&gt;SQL执行—&gt;结果处理</li>
<li>支撑层：事务管理、连接池隔离</li>
<li>连接层：数据库连接驱动</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7gnku.png" alt="image-20230101105924718"></p>
<h2 id="3-ORM框架有哪些常见问题"><a href="#3-ORM框架有哪些常见问题" class="headerlink" title="3.ORM框架有哪些常见问题"></a>3.ORM框架有哪些常见问题</h2><blockquote>
<p>ORM与DAO是什么关系</p>
</blockquote>
<ul>
<li>DAO这个概念在Java中比较常见，一般是ORM生成的</li>
<li>DAO(Data Access Object)是ORM框架的接口层</li>
</ul>
<blockquote>
<p>如何定位出问题的SQL</p>
</blockquote>
<ul>
<li>业务应用：根据代码推断、查看相关日志</li>
<li>数据库：查看慢日志</li>
<li>网络：监听数据库端口，解析TCP报文</li>
</ul>
<h1 id="第七章：怎么给数据上保险"><a href="#第七章：怎么给数据上保险" class="headerlink" title="第七章：怎么给数据上保险"></a>第七章：怎么给数据上保险</h1><h2 id="1-数据库有哪些种类的备份？"><a href="#1-数据库有哪些种类的备份？" class="headerlink" title="1.数据库有哪些种类的备份？"></a>1.数据库有哪些种类的备份？</h2><blockquote>
<p>备份的分类纬度</p>
</blockquote>
<ol>
<li>备份时数据库的状态</li>
<li>备份文件的格式</li>
<li>备份的内容</li>
</ol>
<blockquote>
<p>备份时数据库的状态</p>
</blockquote>
<ul>
<li>Hot Backup(热备)：正常运行中直接备份</li>
<li>Cold Backup(冷备)：完全停止后备份</li>
<li>Warm Backup(温备)：数据库只读</li>
</ul>
<blockquote>
<p>备份文件的格式</p>
</blockquote>
<ul>
<li>逻辑备份：输出文本或SQL语句</li>
<li>物理备份(裸文件)：备份数据库底层文件</li>
</ul>
<blockquote>
<p>备份的内容</p>
</blockquote>
<ul>
<li>完全备份：备份完全数据</li>
<li>增量备份：备份数据差异</li>
<li>日志备份：备份binlog</li>
</ul>
<blockquote>
<p>备份工具</p>
</blockquote>
<ul>
<li>mysqldump：逻辑、热、全量备份</li>
<li>xtrabackup：物理、热、全量+增量备份</li>
</ul>
<h2 id="2-使用OUTFILE命令备份"><a href="#2-使用OUTFILE命令备份" class="headerlink" title="2.使用OUTFILE命令备份"></a>2.使用OUTFILE命令备份</h2><blockquote>
<p>OUTFILE</p>
</blockquote>
<ul>
<li>MySQL原生的SQL指令</li>
<li>最原始的逻辑备份方式</li>
<li>备份的功能和效果却绝育如何写SQL语句</li>
</ul>
<blockquote>
<p>OUTFILE的使用方式</p>
</blockquote>
<ul>
<li><p>首先查找MySQL的导出路径</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show variables like &#x27;%secure%&#x27;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用into outfile指令将查询结果导出至文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * into outfile &#x27;/file&#x27; from z;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>OUTFILE的注意事项</p>
</blockquote>
<ul>
<li>在InnoDB事务下，可以做到一致性视图</li>
<li>修改分隔符：fields terminated by</li>
<li>修改换行符：lines terminated by</li>
</ul>
<blockquote>
<p>OUTFILE缺陷</p>
</blockquote>
<ul>
<li>输出的文本比较简略</li>
<li>很难进行还原，现在往往用来简单导出数据</li>
</ul>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>OUTFILE时最简单且原生的数据备份工具</li>
<li>使用简单、灵活性高</li>
<li>不适合数据还原场景，基本用来导出数据</li>
</ul>
<h2 id="3-使用mysqldump进行备份"><a href="#3-使用mysqldump进行备份" class="headerlink" title="3.使用mysqldump进行备份"></a>3.使用mysqldump进行备份</h2><blockquote>
<p>OUTFILE如何改进</p>
</blockquote>
<ul>
<li>自动发SELECT语句，不需要手动发送</li>
<li>自动开始事务</li>
<li>输出INSERT语句，可以直接用于还原</li>
</ul>
<blockquote>
<p>mysqldump</p>
</blockquote>
<ul>
<li>非常常用的MySQL逻辑备份工具</li>
<li>MySQL Server自带</li>
<li>输出的备份内容为SQL语句，平衡了阅读和还原</li>
<li>SQL语句占空间较小</li>
</ul>
<blockquote>
<p>mysqldump原理</p>
</blockquote>
<ul>
<li><p>mysqldump使用以下语句对数据进行备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select SQL_NOCACHE from &#x27;t&#x27;;</span><br><span class="line"># SQL_NOCACHE查询出的数据不会进入SQL缓存</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>mysqldump使用方法</p>
</blockquote>
<ul>
<li><p>mysqldump使用以下语句对数据进行备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqldump -uroot -proot --databases d1 --single-transaction &gt; test.sql</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接执行导出的sql文件即可进行还原</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source test.sql</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>mysqldump注意事项</p>
</blockquote>
<ul>
<li>–single-transaction：在RR级别下进行(InnoDB)</li>
<li>–lock-all-tables：使用FTWRL锁所有表(MyISAM)</li>
<li>–lock-tables：使用READ LOCAL锁当前库的表(MyISAM)</li>
<li>–all-databases：备份所有库</li>
</ul>
<blockquote>
<p>mysqldump缺点</p>
</blockquote>
<ul>
<li>导出逻辑数据，备份较慢</li>
<li>还原需要执行sql，速度也比较慢</li>
</ul>
<h2 id="4-如何使用mysqldump增量备份"><a href="#4-如何使用mysqldump增量备份" class="headerlink" title="4.如何使用mysqldump增量备份"></a>4.如何使用mysqldump增量备份</h2><blockquote>
<p>mysqldump增量备份思路</p>
</blockquote>
<ul>
<li>binlog忠实记录了MySQL数据的变化</li>
<li>mysqldump全量备份后，可以用binlog作为增量</li>
<li>mysqldump全量备份时，切换新的binlog文件</li>
<li>从零还原时，采用全量+binlog还原</li>
</ul>
<blockquote>
<p>mysqldump增量备份</p>
</blockquote>
<ul>
<li><p>使用以下语句对数据进行全量备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqldump -uroot -proot --databases d1 --single-transaction --flush-logs --master-data=2 &gt; test.sql</span><br><span class="line"># --flush-logs:备份后切换binlog文件</span><br><span class="line"># --master-data=2：记录切换后的binlog文件名</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要增量备份时，切换binlog文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqldump -uroot -proot flush-logs;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将所有新增的binlog文件备份</p>
</li>
</ul>
<blockquote>
<p>还原</p>
</blockquote>
<ul>
<li><p>首先恢复旧的全量备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">source test.sql;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后将binlog增量还原至数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqlbinlog MySQL-bin.000002...|mysql -uroot -proot</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-使用XtraBackup物理备份"><a href="#5-使用XtraBackup物理备份" class="headerlink" title="5.使用XtraBackup物理备份"></a>5.使用XtraBackup物理备份</h2><blockquote>
<p>为什么需要物理备份</p>
</blockquote>
<ul>
<li>直接备份InnoDB底层数据文件</li>
<li>导出不需要转换，速度快</li>
<li>工作时对数据库的压力较小</li>
<li>更容易实现增量备份</li>
</ul>
<blockquote>
<p>直接裸拷贝可行嘛</p>
</blockquote>
<ul>
<li>理论上可行，但有很多问题</li>
<li>要同时备份frm文件、ibd文件、binlog文件、redo log文件等</li>
<li>在不同版本的数据库和操作系统上还原可能有兼容问题</li>
<li>必须冷备份，影响业务</li>
</ul>
<blockquote>
<p>如何实现 物理+热+全量备份？</p>
</blockquote>
<ul>
<li>思路：利用redo log，备份ibd文件+备份期间的redo log</li>
</ul>
<ol>
<li>启动redo log监听线程，开始收集redo log</li>
<li>拷贝ibd数据文件</li>
<li>停止收集redo log</li>
<li>加FTWRL锁拷贝元数据frm</li>
</ol>
<blockquote>
<p>如何实现 物理+热+增量备份？</p>
</blockquote>
<ul>
<li><p>思路：与全量级别相同</p>
</li>
<li><p>如何确认增量：根据每个页的LSN号，确认变化的页</p>
</li>
</ul>
<blockquote>
<p>如何实现物理还原</p>
</blockquote>
<ul>
<li>思路：mysqld  crash奔溃恢复流程相似</li>
<li>还原ibd文件，重放redo log</li>
</ul>
<h2 id="6-ibbackup与XtraBackup"><a href="#6-ibbackup与XtraBackup" class="headerlink" title="6.ibbackup与XtraBackup"></a>6.ibbackup与XtraBackup</h2><blockquote>
<p>ibbackup</p>
</blockquote>
<ul>
<li>现名MySQL Enterprise Backup，InnoDB官方出品</li>
<li>实现了上述的功能，性能优秀</li>
</ul>
<blockquote>
<p>XtraBackup</p>
</blockquote>
<ul>
<li><p>Percona公司开发的开源版本，实现ibbackup所有功能</p>
</li>
<li><p>XtraBackup 8.0—&gt;MySQL 8.0</p>
</li>
<li><p>XtraBackup 2.4—&gt;MySQL 5.1，5.5，5.7</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参数</span></span><br><span class="line">--apply-log-only：prepare备份的时候只执行redo阶段，用于增量备份。</span><br><span class="line">--backup：创建备份并且放入--target-dir目录中</span><br><span class="line">--close-files：不保持文件打开状态，xtrabackup打开表空间的时候通常不会关闭文件句柄，目的是为了正确处理DDL操作。如果表空间数量非常巨大并且不适合任何限制，一旦文件不在被访问的时候这个选项可以关闭文件句柄.打开这个选项会产生不一致的备份。</span><br><span class="line">--compact：创建一份没有辅助索引的紧凑备份</span><br><span class="line">--compress：压缩所有输出数据，包括事务日志文件和元数据文件，通过指定的压缩算法，目前唯一支持的算法是quicklz.结果文件是qpress归档格式，每个xtrabackup创建的*.qp文件都可以通过qpress程序提取或者解压缩</span><br><span class="line">--compress-chunk-size=<span class="comment">#：压缩线程工作buffer的字节大小，默认是64K</span></span><br><span class="line">--compress-threads=<span class="comment">#：xtrabackup进行并行数据压缩时的worker线程的数量，该选项默认值是1，并行压缩（&#x27;compress-threads&#x27;）可以和并行文件拷贝(&#x27;parallel&#x27;)一起使用。例如:&#x27;--parallel=4 --compress --compress-threads=2&#x27;会创建4个IO线程读取数据并通过管道传送给2个压缩线程。</span></span><br><span class="line">--create-ib-logfile：这个选项目前还没有实现，目前创建Innodb事务日志，你还是需要prepare两次。</span><br><span class="line">--datadir=DIRECTORY：backup的源目录，mysql实例的数据目录。从my.cnf中读取，或者命令行指定。</span><br><span class="line">--defaults-extra-file=[MY.CNF]：在global files文件之后读取，必须在命令行的第一选项位置指定。</span><br><span class="line">--defaults-file=[MY.CNF]：唯一从给定文件读取默认选项，必须是个真实文件，必须在命令行第一个选项位置指定。</span><br><span class="line">--defaults-group=GROUP-NAME：从配置文件读取的组，innobakcupex多个实例部署时使用。</span><br><span class="line">--<span class="built_in">export</span>：为导出的表创建必要的文件</span><br><span class="line">--extra-lsndir=DIRECTORY：(<span class="keyword">for</span> --bakcup):在指定目录创建一份xtrabakcup_checkpoints文件的额外的备份。</span><br><span class="line">--incremental-basedir=DIRECTORY：创建一份增量备份时，这个目录是增量别分的一份包含了full bakcup的Base数据集。</span><br><span class="line">--incremental-dir=DIRECTORY：prepare增量备份的时候，增量备份在DIRECTORY结合full backup创建出一份新的full backup。</span><br><span class="line">--incremental-force-scan：创建一份增量备份时，强制扫描所有增在备份中的数据页即使完全改变的page bitmap数据可用。</span><br><span class="line">--incremetal-lsn=LSN：创建增量备份的时候指定lsn。</span><br><span class="line">--innodb-log-arch-dir：指定包含归档日志的目录。只能和xtrabackup --prepare选项一起使用。</span><br><span class="line">--innodb-miscellaneous：从My.cnf文件读取的一组Innodb选项。以便xtrabackup以同样的配置启动内置的Innodb。通常不需要显示指定。</span><br><span class="line">--log-copy-interval=<span class="comment">#：这个选项指定了log拷贝线程check的时间间隔（默认1秒）。</span></span><br><span class="line">--log-stream：xtrabakcup不拷贝数据文件，将事务日志内容重定向到标准输出直到--suspend-at-end文件被删除。这个选项自动开启--suspend-at-end。</span><br><span class="line">--no-defaults：不从任何选项文件中读取任何默认选项,必须在命令行第一个选项。</span><br><span class="line">--databases=<span class="comment">#：指定了需要备份的数据库和表。</span></span><br><span class="line">--database-file=<span class="comment">#：指定包含数据库和表的文件格式为databasename1.tablename1为一个元素，一个元素一行。</span></span><br><span class="line">--parallel=<span class="comment">#：指定备份时拷贝多个数据文件并发的进程数，默认值为1。</span></span><br><span class="line">--prepare：xtrabackup在一份通过--backup生成的备份执行还原操作，以便准备使用。</span><br><span class="line">--print-default：打印程序参数列表并退出，必须放在命令行首位。</span><br><span class="line">--print-param：使xtrabackup打印参数用来将数据文件拷贝到datadir并还原它们。</span><br><span class="line">--rebuild_indexes：在apply事务日志之后重建innodb辅助索引，只有和--prepare一起才生效。</span><br><span class="line">--rebuild_threads=<span class="comment">#：在紧凑备份重建辅助索引的线程数，只有和--prepare和rebuild-index一起才生效。</span></span><br><span class="line">--stats：xtrabakcup扫描指定数据文件并打印出索引统计。</span><br><span class="line">--stream=name：将所有备份文件以指定格式流向标准输出，目前支持的格式有xbstream和tar。</span><br><span class="line">--suspend-at-end：使xtrabackup在--target-dir目录中生成xtrabakcup_suspended文件。在拷贝数据文件之后xtrabackup不是退出而是继续拷贝日志文件并且等待知道xtrabakcup_suspended文件被删除。这项可以使xtrabackup和其他程序协同工作。</span><br><span class="line">--tables=name：正则表达式匹配database.tablename。备份匹配的表。</span><br><span class="line">--tables-file=name：指定文件，一个表名一行。</span><br><span class="line">--target-dir=DIRECTORY：指定backup的目的地，如果目录不存在，xtrabakcup会创建。如果目录存在且为空则成功。不会覆盖已存在的文件。</span><br><span class="line">--throttle=<span class="comment">#：指定每秒操作读写对的数量。</span></span><br><span class="line">--tmpdir=name：当使用--print-param指定的时候打印出正确的tmpdir参数。</span><br><span class="line">--to-archived-lsn=LSN：指定prepare备份时apply事务日志的LSN，只能和xtarbackup --prepare选项一起用。</span><br><span class="line">--user-memory = <span class="comment">#：通过--prepare prepare备份时候分配多大内存，目的像innodb_buffer_pool_size。默认值100M如果你有足够大的内存。1-2G是推荐值，支持各种单位(1MB,1M,1GB,1G)。</span></span><br><span class="line">--version：打印xtrabackup版本并退出。</span><br><span class="line">--xbstream：支持同时压缩和流式化。需要客服传统归档tar,cpio和其他不允许动态streaming生成的文件的限制，例如动态压缩文件，xbstream超越其他传统流式/归档格式的的优点是，并发stream多个文件并且更紧凑的数据存储（所以可以和--parallel选项选项一起使用xbstream格式进行streaming）。</span><br></pre></td></tr></table></figure>



<blockquote>
<p>XtraBackup全量使用方法</p>
</blockquote>
<ul>
<li><p>备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">innobackupex --user=root --password=root bakdir/</span><br><span class="line">xtrabackup --backup --user=root --password=123456  --target-dir=/data/backups/base</span><br></pre></td></tr></table></figure>
</li>
<li><p>还原(停掉mysqld)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">innobackupex --copy-back bakdir/xxxxx/</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xtrabackup --prepare --target-dir=/data/backups/</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>XtraBackup增量使用方法</p>
</blockquote>
<ul>
<li><p>增量备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">innobackupex --user=root --password=root --incremental bakdir/ --incremenral-basedir=&#x27;/bakdir/xxxxx/&#x27;</span><br><span class="line"></span><br><span class="line">xtrabackup --backup --target-dir=/data/backups/inc1 --incremental-basedir=/data/backups/base</span><br></pre></td></tr></table></figure>
</li>
<li><p>增量备份合并至全量备份</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">innobackupex --apply-log bakdir/xxxx/ --incremental-dir=bakdir/YYYY/</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>使用场景</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#备份：</span><br><span class="line">1：指定--defaults-file</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/my.cnf --user=root --password=123  --backup --target-dir=/home/zhoujy/xtrabackup/</span><br><span class="line"></span><br><span class="line">2：用--datadir取代--defaults-file</span><br><span class="line">xtrabackup --user=root --password=123  --backup --datadir=/var/lib/mysql/ --target-dir=/home/zhoujy/xtrabackup/</span><br><span class="line"></span><br><span class="line">#还原：</span><br><span class="line">1：(关闭mysql)先prepare</span><br><span class="line">xtrabackup --prepare --target-dir=/home/zhoujy/xtrabackup/</span><br><span class="line"></span><br><span class="line">2：再copy</span><br><span class="line">rsync -avrP /home/zhoujy/xtrabackup/* /var/lib/mysql/</span><br><span class="line"></span><br><span class="line">3：改权限、启动</span><br><span class="line">chown -R mysql.mysql *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#备份，这里指定几个库和表，也可以是所有库</span><br><span class="line">1：库全量备份</span><br><span class="line">xtrabackup --user=root --password=123 --datadir=/var/lib/mysql/ --backup --parallel=3 --databases=&quot;xtra_test dba_test&quot; --target-dir=/home/zhoujy/xtrabackup/</span><br><span class="line"></span><br><span class="line">2：增量备份</span><br><span class="line">xtrabackup --user=root --password=123 --datadir=/var/lib/mysql/ --backup --parallel=3 --databases=&quot;xtra_test dba_test&quot; --target-dir=/home/zhoujy/xtrabackup1/ --incremental-basedir=/home/zhoujy/xtrabackup/</span><br><span class="line"></span><br><span class="line">注意：要是有多个增量备份，第2个增量需要指定第一个增量的目录。和innobackupex一样。</span><br><span class="line"></span><br><span class="line">3：还原</span><br><span class="line">#先prepare全备</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=/home/zhoujy/xtrabackup/</span><br><span class="line">#再prepare增量备份</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=/home/zhoujy/xtrabackup/ --incremental-dir=/home/zhoujy/xtrabackup1/</span><br><span class="line"></span><br><span class="line">4：最后prepare 全备</span><br><span class="line">xtrabackup --prepare --target-dir=/home/zhoujy/xtrabackup/</span><br><span class="line"></span><br><span class="line">5：最后copy、改权限。另外说一个指定表的备份：和innobackupex一样，用--databases=dbname.tablename和--tables-file，也可以用--tables（--include），支持正则。如备份t开头的数据库下的所有表：xtrabackup --user=root --password=123 --datadir=/var/lib/mysql/ --backup --parallel=3 --tables=&quot;^t[.]*.*&quot; --target-dir=/home/zhoujy/xtrabackup/</span><br></pre></td></tr></table></figure>



<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>物理备份是一种高效的备份方式</li>
<li>XtraBackup采用了备份ibd+备份期间redo log方式</li>
<li>XtraBackup时醉常用的MySQL物理备份工具</li>
<li>物理备份的缺点是备份文件无法直接阅读</li>
</ul>
<h2 id="7-MySQL备份工具如何指导我们的创新"><a href="#7-MySQL备份工具如何指导我们的创新" class="headerlink" title="7.MySQL备份工具如何指导我们的创新"></a>7.MySQL备份工具如何指导我们的创新</h2><blockquote>
<p>mylvmbackup</p>
</blockquote>
<ul>
<li>物理、温备</li>
<li>利用LVM逻辑卷管理器</li>
<li>直接备份磁盘数据</li>
</ul>
<blockquote>
<p>mydumper</p>
</blockquote>
<ul>
<li><p>跟mysqldump类似的工具</p>
</li>
<li><p>实现了多线程并发的备份还原</p>
</li>
<li><p>速度更快</p>
</li>
</ul>
<blockquote>
<p>Zmanda Recovery Manager</p>
</blockquote>
<ul>
<li>功能强大的备份恢复管理工具</li>
<li>集成了多种备份工具</li>
<li>集成binlog分析功能</li>
</ul>
<h2 id="8-如何防患于未然"><a href="#8-如何防患于未然" class="headerlink" title="8.如何防患于未然"></a>8.如何防患于未然</h2><ol>
<li><p>权限隔离</p>
<ul>
<li>给业务应用分配的账户只给DML权限</li>
<li>开发只使用只读账号</li>
<li>DBA破事使用时使用只读账号，特殊操作时切换账号</li>
</ul>
</li>
<li><p>SQL审计</p>
<ul>
<li>DBA在开发环境审计即将上线的SQL语句</li>
<li>开发修改在线数据，提交给DBA执行</li>
<li>Inception自动审核工具</li>
</ul>
</li>
<li><p>伪删表</p>
<ul>
<li>删表之前将表改名，观察业务是否受影响</li>
<li>不直接删表，给表名加特殊后缀，用脚本删除</li>
</ul>
</li>
<li><p>完备流程</p>
<ul>
<li>上线之前备份数据</li>
<li>准备生产环境事故预案</li>
</ul>
</li>
</ol>
<h1 id="第八章：”三高框架”基础"><a href="#第八章：”三高框架”基础" class="headerlink" title="第八章：”三高框架”基础"></a>第八章：”三高框架”基础</h1><blockquote>
<p>什么是三高？</p>
</blockquote>
<ul>
<li>高并发：同时处理的事物数高</li>
<li>高性能：事物&#x2F;SQL的执行速度快</li>
<li>高可用：系统可用时间高</li>
</ul>
<blockquote>
<p>为什么不直接讲”三高”？</p>
</blockquote>
<ul>
<li>“三高”只是目的，并不是手段，手段有：</li>
<li>复制<ul>
<li>目的：数据冗余</li>
<li>手段：binlog传送</li>
<li>收获：并发量提升、可用性提升</li>
<li>问题：占用更多硬件资源</li>
</ul>
</li>
<li>扩展<ul>
<li>目的：扩展数据库容量</li>
<li>手段：数据库分片分库、分表</li>
<li>收获：性能、并发量的提升</li>
<li>问题：可能减低可用性</li>
</ul>
</li>
<li>切换<ul>
<li>目的：提高可用性</li>
<li>手段：主从身份切换</li>
<li>收获：并发量的提升</li>
<li>问题：丢失切换时期数据</li>
</ul>
</li>
</ul>
<blockquote>
<p>“三高”的实现</p>
</blockquote>
<ul>
<li>高并发：通过复制和扩展，将数据分散至多节点</li>
<li>高性能：复制提升速度，扩展提升容量</li>
<li>高可用：节点间身份切换保证随时可用</li>
</ul>
<h2 id="1-复制有哪些类型？"><a href="#1-复制有哪些类型？" class="headerlink" title="1.复制有哪些类型？"></a>1.复制有哪些类型？</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7gq76.png" alt="image-20230108151258119"></p>
<ul>
<li>根据复制同步的类型，可以分为：<ul>
<li>异步复制(Asynchronous Replication)</li>
<li>半同步复制(Semisynchronous Replication)</li>
<li>组复制(Group Replication)</li>
</ul>
</li>
</ul>
<blockquote>
<p>异步复制(Asynchronous Replication)</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7gnyq.png" alt="image-20230108152008471"></p>
<ul>
<li><p>原理简单</p>
</li>
<li><p>对网络延迟要求较小 </p>
</li>
<li><p>不能保证日志被传送到了备库，可能丢失数据</p>
</li>
</ul>
<blockquote>
<p><strong>半同步复制</strong>(Semisynchronous Replication)</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7gth5.png" alt="image-20230108152321890"></p>
<ul>
<li>原理简单</li>
<li>对网络延迟有一定要求，最好在同一机房</li>
<li>可以保证日志被传送到了备库，不易丢失数据</li>
<li>rpl_semi_sync_master_timeout参数可以调整脱扣时间，默认为10s</li>
</ul>
<blockquote>
<p>组复制(Group Replication)</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7gtpm.png" alt="image-20230108152629120"></p>
<ul>
<li>原理比较复杂</li>
<li>需要依赖共识算法</li>
<li>实际应用较少</li>
<li>时数据库走向原生分布式的示范</li>
</ul>
<h2 id="2-主从复制"><a href="#2-主从复制" class="headerlink" title="2.主从复制"></a>2.主从复制</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入mysql配置文件 /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin  <span class="comment"># binlog日志所在目录</span></span><br><span class="line">server-id=123456  				  <span class="comment"># 在同一个集群中不一样即可</span></span><br><span class="line">plugin-load=<span class="string">&quot;rel_semi_sync_master=semisync_master.so;rel_semi_sync_slave=semisync_slave.so&quot;</span>                              <span class="comment"># 配置半同步插件</span></span><br><span class="line">read_only=1;                      <span class="comment"># slave配置只读</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在配置slave时，要先给master上全局锁备份数据给slave</span></span><br><span class="line"><span class="comment"># 使用show master status;查看master binlog执行情况</span></span><br><span class="line"><span class="comment"># 配置slave</span></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">    -&gt; MASTER_HOST=<span class="string">&#x27;192.168.19.199&#x27;</span>,</span><br><span class="line">    -&gt; MASTER_USER=<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    -&gt; MASTER_PASSWORD=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    -&gt; MATER_LOG_FILE=<span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">    -&gt; MASTER_LOG_POS=154;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置完成</span></span><br><span class="line">start slave;       <span class="comment"># 开启slave</span></span><br><span class="line">show slave status; <span class="comment"># 查看slave状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若不想设置MATER_LOG_FILE，MASTER_LOG_POS，就要给每个事务配一个唯一ID</span></span><br><span class="line">[mysqld]</span><br><span class="line">gtid_mode=on  <span class="comment"># 开启gtid功能   </span></span><br><span class="line">enforce_gtid_consistency=on  <span class="comment"># 增强gtid的一致性</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置slave</span></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">    -&gt; MASTER_HOST=<span class="string">&#x27;192.168.19.199&#x27;</span>,</span><br><span class="line">    -&gt; MASTER_USER=<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    -&gt; MASTER_PASSWORD=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">	-&gt; MASTER_AUTO_POSITION=1;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>GTID</p>
</blockquote>
<ul>
<li><p>mysql5.6版本引入了GTID</p>
</li>
<li><p>GTID &#x3D; server_uuid:gno</p>
</li>
<li><p>server_uuid:节点的UUID</p>
</li>
<li><p>gno事务流水号(回滚会收回)</p>
</li>
<li><p>GTID可以给事务分配全局唯一ID</p>
</li>
<li><p>GTID方便了主从复制的配置，推荐打开</p>
</li>
<li><p>GTID对主从切换、故障恢复也有很大意义</p>
</li>
</ul>
<h2 id="3-为什么binlog格式会影响复制？"><a href="#3-为什么binlog格式会影响复制？" class="headerlink" title="3.为什么binlog格式会影响复制？"></a>3.为什么binlog格式会影响复制？</h2><blockquote>
<p>binlog格式</p>
</blockquote>
<ul>
<li>statement格式<ul>
<li>5.0之前的MySQL默认使用的格式</li>
<li>binlog记录的是SQL语句原文</li>
<li>由于主备库对于SQL的执行不一致，可能有数据安全风险</li>
</ul>
</li>
<li>row格式<ul>
<li>不记录SQL语句原文</li>
<li>记录数据行的变化</li>
<li>不是物理日志，还是逻辑日志</li>
<li>占用空间较大</li>
</ul>
</li>
<li>mixed格式<ul>
<li>两种格式混合使用</li>
<li>有数据风险的语句使用ROW</li>
<li>无风险的使用statement’</li>
</ul>
</li>
</ul>
<blockquote>
<p>基于语句的复制&#x3D;statement</p>
<p>基于行的复制&#x3D;row</p>
<p><strong>推荐使用row格式</strong></p>
</blockquote>
<h2 id="4-备库延迟太大，怎么办？"><a href="#4-备库延迟太大，怎么办？" class="headerlink" title="4.备库延迟太大，怎么办？"></a>4.备库延迟太大，怎么办？</h2><blockquote>
<p>备库延迟的原因</p>
</blockquote>
<ul>
<li>log传送开销较小，主要是消费relay log耗时</li>
<li>备库性能不如主库</li>
<li>备库承担了很多分析SQL</li>
<li>主库长事务未提交</li>
</ul>
<blockquote>
<p>处理方法</p>
</blockquote>
<ul>
<li>主备使用相同配置的机器</li>
<li>备库关闭log实时刷盘</li>
<li>增加从库数量，应对分析SQL</li>
<li>binlog传送至大数据库系统，供分析</li>
<li>大事务一分多</li>
</ul>
<blockquote>
<p>依然存在的问题</p>
</blockquote>
<ul>
<li>备库对硬件资源利用天然不如主库</li>
<li><strong>备库单线程执行</strong></li>
<li><strong>主库多线程执行</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7gnnp.png" alt="image-20230108173018156"></p>
<ul>
<li>并行复制的思路<ul>
<li>按表分发</li>
<li>按行分发</li>
</ul>
</li>
<li>MySQL5.6并行复制<ul>
<li>按库并行策略</li>
<li>优点：分发快，支持各种log格式</li>
<li>缺点：库粒度太大，很难负载平衡</li>
<li>配置：slave-parallel-type &#x3D; DATABASE</li>
</ul>
</li>
<li><strong>MySQL 5.7 按事务组并行策略</strong><ul>
<li>binlog刷盘其实是两步动作<ul>
<li>先把binlog从binlog cache中写道内存的binlog文件</li>
<li>调用fsync持久化至磁盘</li>
</ul>
</li>
<li>设置事务组<ul>
<li>binlog_group_commit_sync_delay:延迟多少微秒后才调用fsync</li>
<li>binlog_group_commit_sync_no_delay_count:积累多少次以后才调用fsync</li>
<li>两个参数是或的关系</li>
<li>配置：slave-parallel-type &#x3D; LOGICAL_CLOCK</li>
</ul>
</li>
<li>同时处于prepare状态的事物，在备库执行时是可以并行的</li>
<li>推荐使用</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7gztk.png" alt="image-20230108173730540"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h40r.png" alt="image-20230108173913633"></p>
<ul>
<li>5.7.22并行复制<ul>
<li>binlog-transaction-dependency-tracking参数<ul>
<li>COMMIT_ORDER:按事务组并行</li>
<li>WRITESET:没有修改相同行的事物可以并行</li>
<li>WRITESET_SESSION:同一个线程先后执行的两个事务不能并行</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="5-如何在备库读到最新数据"><a href="#5-如何在备库读到最新数据" class="headerlink" title="5.如何在备库读到最新数据"></a>5.如何在备库读到最新数据</h2><blockquote>
<p>如何判断备库已经追上</p>
</blockquote>
<ul>
<li>强制延时</li>
<li>当seconds_behind_master为0时</li>
<li>对比binlog执行位点</li>
<li>对比GTID执行情况</li>
</ul>
<blockquote>
<p>备库延迟理论上无法消灭</p>
</blockquote>
<ul>
<li>binlog传送、中继日志重放需要时间</li>
<li>理论上，备库延迟只能减小，无法消灭</li>
<li>在备库读取数据时永远面临数据延迟问题</li>
</ul>
<blockquote>
<p>判断具体事务是否已经重放</p>
</blockquote>
<ul>
<li>等待binlog位点<ul>
<li>select master_pos_wait(file,pos[,timeout]);</li>
<li>如果已经重放到位点了，就会返回值</li>
</ul>
</li>
<li>等待GTID(5.7.6之后可以返回每次的GTID)<ul>
<li>select wait_for_executed_gtid_set(gtid_set,1);</li>
<li>拿返回的GTID执行命令，从库会阻塞到GTID执行</li>
</ul>
</li>
</ul>
<h2 id="6-怎样实现最简单的高可用架构"><a href="#6-怎样实现最简单的高可用架构" class="headerlink" title="6.怎样实现最简单的高可用架构"></a>6.怎样实现最简单的高可用架构</h2><blockquote>
<p>主-主复制架构</p>
</blockquote>
<ul>
<li><p>两个结点均为Master</p>
</li>
<li><p>两个结点互为Slave</p>
</li>
<li><p>一个结点出现故障时，无需身份切换</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h2ma.png" alt="image-20230108181100032"></p>
<blockquote>
<p>主-主架构问题</p>
</blockquote>
<ul>
<li><p>数据冲突问题</p>
<ul>
<li>两边插入相同ID时，可能出现冲突</li>
<li>两边约定好插入不同ID</li>
<li>只写一个主，另一个只读</li>
<li>有切换过快的数据丢失问题</li>
</ul>
</li>
<li><p>客户端切换</p>
<ul>
<li>应用自己切换比较麻烦</li>
<li>使用keepalived等手段可以完成自动切换</li>
</ul>
</li>
<li><p>循环复制</p>
<ul>
<li>未开GTID：使用serverID过滤</li>
<li>GTID：天然避免</li>
</ul>
</li>
</ul>
<h1 id="第九章：如何解决容量不够的问题"><a href="#第九章：如何解决容量不够的问题" class="headerlink" title="第九章：如何解决容量不够的问题"></a>第九章：如何解决容量不够的问题</h1><h2 id="1-怎样最简单的扩展容量？"><a href="#1-怎样最简单的扩展容量？" class="headerlink" title="1.怎样最简单的扩展容量？"></a>1.怎样最简单的扩展容量？</h2><blockquote>
<p>什么是分区表</p>
</blockquote>
<ul>
<li><p>将InnoDB的一个表分为多个表</p>
</li>
<li><p>server层依然看做一个表</p>
</li>
<li><p>分区表可以优化单节点容量、增强分区之间隔离</p>
</li>
<li><p>可以通过存储在不同的磁盘上提高容量</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h8qc.png" alt="image-20230109095217778"></p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h7q9.png" alt="image-20230109095200059"></p>
<ul>
<li><p>分区方式</p>
<ul>
<li>范围分区</li>
<li>Hash分区</li>
<li>List分区</li>
</ul>
</li>
<li><p>分区表的优势</p>
<ul>
<li>减低B+树的层级，搜索加速</li>
<li>将一个数据表物理上分为多个文件，方便处理</li>
</ul>
</li>
<li><p>分区表的缺陷</p>
<ul>
<li><p>第一次需要访问所有分区，可能达到上限</p>
</li>
<li><p>共用MDL锁</p>
</li>
<li><p>分区之后，所有的分区依然位于同一节点</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-为什么要分库分表？"><a href="#2-为什么要分库分表？" class="headerlink" title="2.为什么要分库分表？"></a>2.为什么要分库分表？</h2><blockquote>
<p>分表</p>
</blockquote>
<ul>
<li>垂直：按照字段分表，一般分为冷热</li>
<li>水平：按照行分表，常用范围、Hash切分</li>
<li>水平分表类似于分区表，但Server层也分了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h2k9.png" alt="image-20230109152210524"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h91p.png" alt="image-20230109152248734"></p>
<blockquote>
<p>分库</p>
</blockquote>
<ul>
<li>垂直：将数据表分散在多个数据库或者多个节点中</li>
<li>水平：将所有表水平拆分，每个数据库结构相同</li>
</ul>
<blockquote>
<p>分库分表的优缺点</p>
</blockquote>
<ul>
<li>优点<ul>
<li>增加隔离性</li>
<li>提升容量与并发性能</li>
</ul>
</li>
<li>缺点<ul>
<li>部分失效可能性成倍增加</li>
<li>无法使用单点事务</li>
<li>垂直切分后无法JOIN</li>
<li>范围查询困难</li>
</ul>
</li>
</ul>
<blockquote>
<p>分库分表后的使用方式</p>
</blockquote>
<ul>
<li>业务特殊处理</li>
<li>业务应用使用中间层</li>
<li><strong>使用分库分表中间件</strong></li>
</ul>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>分库分表可以提升数据库性能</li>
<li>分库分表使得数据的使用方法更加复杂、数据丢失的可能性增加</li>
<li>使用分库分表中间件可以最大程度方便客户端的使用</li>
</ul>
<h2 id="3-dble比MyCat强在哪？"><a href="#3-dble比MyCat强在哪？" class="headerlink" title="3.dble比MyCat强在哪？"></a>3.dble比MyCat强在哪？</h2><blockquote>
<p>分库分表中间件的原理</p>
</blockquote>
<ul>
<li>分析SQL语句</li>
<li>根据SQL语义，将SQL拆分成多个，发送至数据节点</li>
<li>将多个数据节点的结果聚集，返回客户端</li>
</ul>
<blockquote>
<p>dble</p>
</blockquote>
<ul>
<li>高性能、高可用的MySQL分库分表中间件</li>
<li>完全开源</li>
<li>基于开源项目MyCat</li>
<li>dble在功能上以水平分表为主</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h2ct.png" alt="image-20230109153805653"></p>
<blockquote>
<p>dble的基础概念</p>
</blockquote>
<ul>
<li>schema：虚拟数据库(不同于传统的schema)</li>
<li>shardingTable：虚拟表(被拆分的表)</li>
<li>shardingNode：虚拟节点</li>
<li>dbGroup：实际的MySQL集群</li>
<li>database：实际的database</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7h3ku.png" alt="image-20230109154552851"></p>
<blockquote>
<p>dble表的类型</p>
</blockquote>
<ul>
<li>全局表：每个节点上有保存表的完整数据</li>
<li>拆分表：被拆分的表，存入不同节点</li>
<li>非拆分表：不拆分的表，存在单一节点</li>
</ul>
<h2 id="4-安装使用dble"><a href="#4-安装使用dble" class="headerlink" title="4.安装使用dble"></a>4.安装使用dble</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7htvg.png" alt="image-20230109154917802"></p>
<blockquote>
<p>安装解压dble</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先在linux上安装java</span></span><br><span class="line">yum install java</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置java home变量</span></span><br><span class="line">vim ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.352.b08-2.el7_9.x86_64/jre</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 安装dble</span></span><br><span class="line">wget https://github.com/actiontech/dble/releases/download/3.22.07.0%2Ftag/dble-3.22.07.0-20220915063524-java1.8.0_151-linux.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压dble</span></span><br><span class="line">tar -xvf 压缩包名字 -C <span class="string">&#x27;/var/lib/&#x27;</span></span><br></pre></td></tr></table></figure>





<blockquote>
<p>dble配置</p>
</blockquote>
<ul>
<li><p>启动配置文件需全部去除_template</p>
</li>
<li><p>cluster_template.cnf：dble集群配置文件</p>
</li>
<li><p>bootstrap_template.cnf：JVM启动参数</p>
</li>
<li><p>user_template.xml：连接dble用户配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置管理员，用于管理元数据</span></span><br><span class="line">&lt;managerUser name=<span class="string">&quot;user&quot;</span> usingDecrypt=<span class="string">&quot;true&quot;</span> whiteIPs=<span class="string">&quot;127.0.0.1,0:0:0:0:0:0:0:1&quot;</span> readOnly=<span class="string">&quot;true&quot;</span></span><br><span class="line">                 password=<span class="string">&quot;AqEkFEuIFAX6g2TJQnp4cJ2r7Yc0Z4/KBsZqKhT8qSz18Aj91e8lxO49BKQElC6OFfW4c38pCYa8QGFTub7pnw==&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置用户，用于管理数据</span></span><br><span class="line">&lt;shardingUser name=<span class="string">&quot;root&quot;</span> password=<span class="string">&quot;123456&quot;</span> schemas=<span class="string">&quot;testdb&quot;</span> readOnly=<span class="string">&quot;false&quot;</span> blacklist=<span class="string">&quot;blacklist1&quot;</span> maxCon=<span class="string">&quot;20&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sharding_template.xml：设置数据分片</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">  ~ Copyright (C) 2016-2022 ActionTech.</span><br><span class="line">  ~ License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher.</span><br><span class="line">  --&gt;</span><br><span class="line"></span><br><span class="line">&lt;dble:sharding xmlns:dble=<span class="string">&quot;http://dble.cloud/&quot;</span> version=<span class="string">&quot;4.0&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;schema name=<span class="string">&quot;testdb&quot;</span>  sqlMaxLimit=<span class="string">&quot;100&quot;</span>&gt;</span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_enum_sharding&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> sqlMaxLimit=<span class="string">&quot;200&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_enum&quot;</span> shardingColumn=<span class="string">&quot;code&quot;</span>/&gt;</span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_range_sharding&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_range&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span>/&gt;</span><br><span class="line">        &lt;!--er tables--&gt;</span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_hash_sharding&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_common_hash&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span>/&gt;</span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_hash_sharding_er1&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_common_hash&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span>/&gt;</span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_hash_sharding_er2&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_common_hash&quot;</span> shardingColumn=<span class="string">&quot;id2&quot;</span>/&gt;</span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_hash_sharding_er3&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_common_hash&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span> incrementColumn=<span class="string">&quot;id2&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_uneven_hash&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_uneven_hash&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_mod&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2,dn3,dn4&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_mod&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span> sqlRequiredSharding=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_jump_hash&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_jumpHash&quot;</span> shardingColumn=<span class="string">&quot;code&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_hash_string&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2,dn3,dn4&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_hashString&quot;</span> shardingColumn=<span class="string">&quot;code&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_date&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2,dn3,dn4&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_date&quot;</span> shardingColumn=<span class="string">&quot;create_date&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_pattern&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_pattern&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span>/&gt;</span><br><span class="line">        &lt;!--global  tables--&gt;</span><br><span class="line">        &lt;globalTable name=<span class="string">&quot;tb_global1&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> sqlMaxLimit=<span class="string">&quot;103&quot;</span> /&gt;</span><br><span class="line">        &lt;globalTable name=<span class="string">&quot;tb_global2&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2,dn3,dn4&quot;</span> cron=<span class="string">&quot;0 0 0 * * ?&quot;</span> checkClass=<span class="string">&quot;CHECKSUM&quot;</span>/&gt;</span><br><span class="line">        &lt;!--single node table--&gt;</span><br><span class="line">        &lt;singleTable name=<span class="string">&quot;tb_single&quot;</span> shardingNode=<span class="string">&quot;dn6&quot;</span> sqlMaxLimit=<span class="string">&quot;105&quot;</span>/&gt;</span><br><span class="line">        &lt;!--er tables--&gt;</span><br><span class="line">        &lt;shardingTable name=<span class="string">&quot;tb_parent&quot;</span> shardingNode=<span class="string">&quot;dn1,dn2&quot;</span> <span class="keyword">function</span>=<span class="string">&quot;func_common_hash&quot;</span> shardingColumn=<span class="string">&quot;id&quot;</span>&gt;</span><br><span class="line">            &lt;childTable name=<span class="string">&quot;tb_child1&quot;</span> joinColumn=<span class="string">&quot;child1_id&quot;</span> parentColumn=<span class="string">&quot;id&quot;</span> sqlMaxLimit=<span class="string">&quot;201&quot;</span>&gt;</span><br><span class="line">                &lt;childTable name=<span class="string">&quot;tb_grandson1&quot;</span> joinColumn=<span class="string">&quot;grandson1_id&quot;</span> parentColumn=<span class="string">&quot;child1_id&quot;</span>/&gt;</span><br><span class="line">                &lt;childTable name=<span class="string">&quot;tb_grandson2&quot;</span> joinColumn=<span class="string">&quot;grandson2_id&quot;</span> parentColumn=<span class="string">&quot;child1_id2&quot;</span>/&gt;</span><br><span class="line">            &lt;/childTable&gt;</span><br><span class="line">            &lt;childTable name=<span class="string">&quot;tb_child2&quot;</span> joinColumn=<span class="string">&quot;child2_id&quot;</span> parentColumn=<span class="string">&quot;id&quot;</span>/&gt;</span><br><span class="line">            &lt;childTable name=<span class="string">&quot;tb_child3&quot;</span> joinColumn=<span class="string">&quot;child3_id&quot;</span> parentColumn=<span class="string">&quot;id2&quot;</span>/&gt;</span><br><span class="line">        &lt;/shardingTable&gt;</span><br><span class="line">    &lt;/schema&gt;</span><br><span class="line">    &lt;!-- sharding testdb2 route to database named dn5 <span class="keyword">in</span> localhost2  --&gt;</span><br><span class="line">    &lt;schema name=<span class="string">&quot;testdb2&quot;</span> shardingNode=<span class="string">&quot;dn5&quot;</span>/&gt;</span><br><span class="line">    &lt;shardingNode name=<span class="string">&quot;dn1&quot;</span> dbGroup=<span class="string">&quot;dbGroup1&quot;</span> database=<span class="string">&quot;db_1&quot;</span>/&gt;</span><br><span class="line">    &lt;shardingNode name=<span class="string">&quot;dn2&quot;</span> dbGroup=<span class="string">&quot;dbGroup2&quot;</span> database=<span class="string">&quot;db_2&quot;</span>/&gt;</span><br><span class="line">    &lt;shardingNode name=<span class="string">&quot;dn3&quot;</span> dbGroup=<span class="string">&quot;dbGroup1&quot;</span> database=<span class="string">&quot;db_3&quot;</span>/&gt;</span><br><span class="line">    &lt;shardingNode name=<span class="string">&quot;dn4&quot;</span> dbGroup=<span class="string">&quot;dbGroup2&quot;</span> database=<span class="string">&quot;db_4&quot;</span>/&gt;</span><br><span class="line">    &lt;shardingNode name=<span class="string">&quot;dn5&quot;</span> dbGroup=<span class="string">&quot;dbGroup1&quot;</span> database=<span class="string">&quot;db_5&quot;</span>/&gt;</span><br><span class="line">    &lt;shardingNode name=<span class="string">&quot;dn6&quot;</span> dbGroup=<span class="string">&quot;dbGroup2&quot;</span> database=<span class="string">&quot;db_6&quot;</span>/&gt;</span><br><span class="line">    &lt;!-- enum partition --&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span> name=<span class="string">&quot;func_enum&quot;</span> class=<span class="string">&quot;Enum&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;mapFile&quot;</span>&gt;partition-enum.txt&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;defaultNode&quot;</span>&gt;0&lt;/property&gt;&lt;!--the default is -1,means unexpected value will report error--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;type&quot;</span>&gt;0&lt;/property&gt;&lt;!--0 means key is a number, 1 means key is a string--&gt;</span><br><span class="line">    &lt;/function&gt;</span><br><span class="line">    &lt;!-- number range partition --&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span> name=<span class="string">&quot;func_range&quot;</span> class=<span class="string">&quot;NumberRange&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;mapFile&quot;</span>&gt;partition-number-range.txt&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;defaultNode&quot;</span>&gt;0&lt;/property&gt;&lt;!--he default is -1,means unexpected value will report error--&gt;</span><br><span class="line">    &lt;/function&gt;</span><br><span class="line">    &lt;!-- Hash partition,when partitionLength=1, it is a mod partition, MAX(<span class="built_in">sum</span>(count*length[i]) must not more <span class="keyword">then</span> 2880--&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span> name=<span class="string">&quot;func_common_hash&quot;</span> class=<span class="string">&quot;Hash&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionCount&quot;</span>&gt;2&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionLength&quot;</span>&gt;512&lt;/property&gt;</span><br><span class="line">    &lt;/function&gt;</span><br><span class="line">    &lt;!-- Hash partition,when partitionLength=1, it is a mod partition, MAX(<span class="built_in">sum</span>(count*length[i]) must not more <span class="keyword">then</span> 2880--&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span> name=<span class="string">&quot;func_uneven_hash&quot;</span> class=<span class="string">&quot;Hash&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionCount&quot;</span>&gt;2,1&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionLength&quot;</span>&gt;256,512&lt;/property&gt;</span><br><span class="line">    &lt;/function&gt;</span><br><span class="line">    &lt;!-- eg:  mod 4 --&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span> name=<span class="string">&quot;func_mod&quot;</span> class=<span class="string">&quot;Hash&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionCount&quot;</span>&gt;4&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionLength&quot;</span>&gt;1&lt;/property&gt;</span><br><span class="line">    &lt;/function&gt;</span><br><span class="line">    &lt;!-- jumpStringHash partition <span class="keyword">for</span> string--&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span> name=<span class="string">&quot;func_jumpHash&quot;</span> class=<span class="string">&quot;jumpStringHash&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionCount&quot;</span>&gt;2&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;hashSlice&quot;</span>&gt;0:2&lt;/property&gt;</span><br><span class="line">    &lt;/function&gt;</span><br><span class="line">    &lt;!-- Hash partition <span class="keyword">for</span> string--&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span> name=<span class="string">&quot;func_hashString&quot;</span> class=<span class="string">&quot;StringHash&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionCount&quot;</span>&gt;4&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;partitionLength&quot;</span>&gt;256&lt;/property&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;hashSlice&quot;</span>&gt;0:2&lt;/property&gt;</span><br><span class="line">        &lt;!--&lt;property name=<span class="string">&quot;hashSlice&quot;</span>&gt;-4:0&lt;/property&gt; --&gt;</span><br><span class="line">    &lt;/function&gt;</span><br><span class="line">    &lt;!-- <span class="built_in">date</span> partition  4 <span class="keyword">case</span>:</span><br><span class="line">    1.<span class="built_in">set</span> sEndDate and defaultNode: input &lt;sBeginDate ,router to defaultNode; input&gt;sEndDate ,mod the period</span><br><span class="line">    2.<span class="built_in">set</span> sEndDate, but no defaultNode:input &lt;sBeginDate report error; input&gt;sEndDate ,mod the period</span><br><span class="line">    3.<span class="built_in">set</span> defaultNode without sEndDate: input &lt;sBeginDate router to defaultNode;input&gt;sBeginDate + (node size)*sPartionDay-1 will report error(expected is defaultNode,but can<span class="string">&#x27;t control now)</span></span><br><span class="line"><span class="string">    4.sEndDate and defaultNode are all not set: input &lt;sBeginDate report error;input&gt;sBeginDate + (node size)*sPartionDay-1 will report error</span></span><br><span class="line"><span class="string">     --&gt;</span></span><br><span class="line"><span class="string">    &lt;function name=&quot;func_date&quot; class=&quot;Date&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;dateFormat&quot;&gt;yyyy-MM-dd&lt;/property&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;sBeginDate&quot;&gt;2015-01-01&lt;/property&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;sEndDate&quot;&gt;2015-01-31&lt;/property&gt; &lt;!--if not set sEndDate,then in fact ,the sEn dDate = sBeginDate+ (node size)*sPartionDay-1 --&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;sPartionDay&quot;&gt;10&lt;/property&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;defaultNode&quot;&gt;0&lt;/property&gt;&lt;!--the default is -1--&gt;</span></span><br><span class="line"><span class="string">    &lt;/function&gt;</span></span><br><span class="line"><span class="string">    &lt;!-- pattern partition : mapFile must contains all value of 0~patternValue-1,key and value must be Continuous increase--&gt;</span></span><br><span class="line"><span class="string">    &lt;function name=&quot;func_pattern&quot; class=&quot;PatternRange&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;mapFile&quot;&gt;partition-pattern.txt&lt;/property&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;patternValue&quot;&gt;1024&lt;/property&gt;</span></span><br><span class="line"><span class="string">        &lt;property name=&quot;defaultNode&quot;&gt;0&lt;/property&gt;&lt;!--contains string which is not number,router to default node--&gt;</span></span><br><span class="line"><span class="string">    &lt;/function&gt;</span></span><br><span class="line"><span class="string">&lt;/dble:sharding&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>db_template.xml：配置实际处理数据分片的地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">  ~ Copyright (C) 2016-2022 ActionTech.</span><br><span class="line">  ~ License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher.</span><br><span class="line">  --&gt;</span><br><span class="line"></span><br><span class="line">&lt;dble:db xmlns:dble=<span class="string">&quot;http://dble.cloud/&quot;</span> version=<span class="string">&quot;4.0&quot;</span>&gt;</span><br><span class="line">	<span class="comment"># 设置一个数据分片</span></span><br><span class="line">    &lt;dbGroup name=<span class="string">&quot;dbGroup1&quot;</span> rwSplitMode=<span class="string">&quot;2&quot;</span> delayThreshold=<span class="string">&quot;100&quot;</span>&gt;</span><br><span class="line">        &lt;heartbeat&gt;show slave status&lt;/heartbeat&gt;</span><br><span class="line">        <span class="comment"># 设置一个用于分片的database</span></span><br><span class="line">        &lt;dbInstance name=<span class="string">&quot;instanceM1&quot;</span> url=<span class="string">&quot;ip1:3306&quot;</span> user=<span class="string">&quot;your_user&quot;</span> password=<span class="string">&quot;your_psw&quot;</span> maxCon=<span class="string">&quot;1000&quot;</span> minCon=<span class="string">&quot;10&quot;</span></span><br><span class="line">                    primary=<span class="string">&quot;true&quot;</span> readWeight=<span class="string">&quot;1&quot;</span> <span class="built_in">id</span>=<span class="string">&quot;xx1&quot;</span>&gt; </span><br><span class="line">            &lt;property name=<span class="string">&quot;testOnCreate&quot;</span>&gt;<span class="literal">true</span>&lt;/property&gt;</span><br><span class="line">        &lt;/dbInstance&gt;</span><br><span class="line">        <span class="comment"># 如果有从节点，可以设置从节点</span></span><br><span class="line">        &lt;!--&lt;dbInstance name=<span class="string">&quot;instanceS1&quot;</span> url=<span class="string">&quot;ip3:3306&quot;</span> user=<span class="string">&quot;your_user&quot;</span> password=<span class="string">&quot;your_psw&quot;</span> maxCon=<span class="string">&quot;1000&quot;</span> minCon=<span class="string">&quot;10&quot;</span>  readWeight=<span class="string">&quot;2&quot;</span> disabled=<span class="string">&quot;true&quot;</span>&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;property name=<span class="string">&quot;testOnCreate&quot;</span>&gt;<span class="literal">false</span>&lt;/property&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;/dbInstance&gt;--&gt;</span><br><span class="line">    &lt;/dbGroup&gt;  </span><br><span class="line"></span><br><span class="line">    &lt;dbGroup name=<span class="string">&quot;dbGroup2&quot;</span> rwSplitMode=<span class="string">&quot;0&quot;</span> delayThreshold=<span class="string">&quot;100&quot;</span> disableHA=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">        &lt;heartbeat errorRetryCount=<span class="string">&quot;1&quot;</span> <span class="built_in">timeout</span>=<span class="string">&quot;10&quot;</span> keepAlive=<span class="string">&quot;60&quot;</span>&gt;show slave status&lt;/heartbeat&gt;</span><br><span class="line">        &lt;dbInstance name=<span class="string">&quot;instanceM2&quot;</span> url=<span class="string">&quot;ip2:3306&quot;</span> user=<span class="string">&quot;your_user&quot;</span> password=<span class="string">&quot;your_psw&quot;</span> maxCon=<span class="string">&quot;1000&quot;</span> minCon=<span class="string">&quot;10&quot;</span></span><br><span class="line">                    primary=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">            &lt;property name=<span class="string">&quot;testOnCreate&quot;</span>&gt;<span class="literal">true</span>&lt;/property&gt;</span><br><span class="line">        &lt;/dbInstance&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- can have multi <span class="built_in">read</span> instances --&gt;</span><br><span class="line">        &lt;!--&lt;dbInstance name=<span class="string">&quot;instanceS2&quot;</span> url=<span class="string">&quot;ip4:3306&quot;</span> user=<span class="string">&quot;your_user&quot;</span> password=<span class="string">&quot;your_psw&quot;</span> maxCon=<span class="string">&quot;1000&quot;</span> minCon=<span class="string">&quot;10&quot;</span> usingDecrypt=<span class="string">&quot;true&quot;</span>&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;property name=<span class="string">&quot;testOnCreate&quot;</span>&gt;<span class="literal">true</span>&lt;/property&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;/dbInstance&gt;--&gt;</span><br><span class="line">    &lt;/dbGroup&gt;</span><br><span class="line">    &lt;!--<span class="keyword">for</span> clickhouse--&gt;</span><br><span class="line">    &lt;dbGroup name=<span class="string">&quot;dbGroup3&quot;</span> rwSplitMode=<span class="string">&quot;0&quot;</span> delayThreshold=<span class="string">&quot;100&quot;</span> disableHA=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">        &lt;heartbeat errorRetryCount=<span class="string">&quot;1&quot;</span> <span class="built_in">timeout</span>=<span class="string">&quot;10&quot;</span> keepAlive=<span class="string">&quot;60&quot;</span>&gt;show databases&lt;/heartbeat&gt;</span><br><span class="line">        &lt;dbInstance name=<span class="string">&quot;instanceM2&quot;</span> url=<span class="string">&quot;ip2:9004&quot;</span> user=<span class="string">&quot;your_user&quot;</span> password=<span class="string">&quot;your_psw&quot;</span> maxCon=<span class="string">&quot;1000&quot;</span> minCon=<span class="string">&quot;10&quot;</span> databaseType=<span class="string">&quot;clickhouse&quot;</span></span><br><span class="line">                    primary=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">            &lt;property name=<span class="string">&quot;testOnCreate&quot;</span>&gt;<span class="literal">true</span>&lt;/property&gt;</span><br><span class="line">        &lt;/dbInstance&gt;</span><br><span class="line">        &lt;!-- can have multi <span class="built_in">read</span> instances --&gt;</span><br><span class="line">        &lt;!--&lt;dbInstance name=<span class="string">&quot;instanceS2&quot;</span> url=<span class="string">&quot;ip4:9004&quot;</span> user=<span class="string">&quot;your_user&quot;</span> password=<span class="string">&quot;your_psw&quot;</span> maxCon=<span class="string">&quot;1000&quot;</span> minCon=<span class="string">&quot;10&quot;</span> usingDecrypt=<span class="string">&quot;true&quot;</span> databaseType=<span class="string">&quot;clickhouse&quot;</span>&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;property name=<span class="string">&quot;testOnCreate&quot;</span>&gt;<span class="literal">true</span>&lt;/property&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;/dbInstance&gt;--&gt;</span><br><span class="line">    &lt;/dbGroup&gt;</span><br><span class="line">&lt;/dble:db&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>dble的使用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /var/lib/dble 开启dble</span></span><br><span class="line">bin/dble start </span><br><span class="line"></span><br><span class="line"><span class="comment"># 用mysql连接dble,若成功连接则dble正常启动</span></span><br><span class="line">mysql -h<span class="string">&#x27;127.0.0.1&#x27;</span> -uman1 -p123123 -P9066</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建虚拟数据库</span></span><br><span class="line">create database @@shardingnode=<span class="string">&#x27;dn$1-6&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h2 id="5-怎样提高分库分表架构的可靠性"><a href="#5-怎样提高分库分表架构的可靠性" class="headerlink" title="5.怎样提高分库分表架构的可靠性"></a>5.怎样提高分库分表架构的可靠性</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7ip7w.png" alt="image-20230110162232113"></p>
<blockquote>
<p>使用dble进行读写分离</p>
</blockquote>
<ul>
<li>dble分析SQL语义</li>
<li>将写语句发送给主节点</li>
<li>将读语句发送给从节点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 读写分离参数，在db.xml中配置</span></span><br><span class="line">rwSplitMode=0：直接分发到主实例</span><br><span class="line">rwSplitMode=1：读操作必须在所有从实例中均衡</span><br><span class="line">rwSplitMode=2：读操作在所有实例中均衡</span><br><span class="line">rwSplitMode=3：读操作尽量在所有从实例中均衡</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从节点中的disabled参数改成false，意思为从节点不废弃</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在mysql中设置日志</span></span><br><span class="line"><span class="keyword">select</span> * from mysql.general_log Order by event_time DESC;</span><br></pre></td></tr></table></figure>



<h2 id="6-分库分表之后性能反而下降，怎么办？"><a href="#6-分库分表之后性能反而下降，怎么办？" class="headerlink" title="6.分库分表之后性能反而下降，怎么办？"></a>6.分库分表之后性能反而下降，怎么办？</h2><blockquote>
<p>查询语句中尽可能带有拆分字段</p>
</blockquote>
<ul>
<li>dble根据拆分字段，判断数据在哪个节点</li>
<li>若无法判断数据节点，只能遍历全部节点数据</li>
</ul>
<blockquote>
<p>插入语句必须带有拆分字段</p>
</blockquote>
<ul>
<li>新数据若无拆分字段，无法插入</li>
</ul>
<blockquote>
<p>拆分字段尽量等值</p>
</blockquote>
<ul>
<li>范围拆分字段会扫描过多节点</li>
<li>若使用IN字句，缩减IN字句值的数量</li>
</ul>
<blockquote>
<p>减少表的搜索遍历</p>
</blockquote>
<ul>
<li>不带拆分字段时，DISTINCT、GROUP BY、ORDER BY，尽量少出现，不要大于一种</li>
</ul>
<blockquote>
<p>减少结果集</p>
</blockquote>
<ul>
<li>分布式系统中，节点间有大量的数据交互</li>
<li>数据交互会影响查询性能</li>
<li>过大的结果集会增大数据汇集的网络交互量</li>
</ul>
<blockquote>
<p>跨节点连表</p>
</blockquote>
<ul>
<li>经常join的表使用相同的拆分规则</li>
<li>使用拆分字段作为join条件</li>
<li>尽量对驱动表添加更多的过滤条件</li>
<li>尽量少使用跨节点排序、分页等功能</li>
<li>复杂语句拆分成多条语句</li>
</ul>
<h1 id="第十章：如何解决数据库经常宕机问题"><a href="#第十章：如何解决数据库经常宕机问题" class="headerlink" title="第十章：如何解决数据库经常宕机问题"></a>第十章：如何解决数据库经常宕机问题</h1><h2 id="1-切换：保业务还是保数据"><a href="#1-切换：保业务还是保数据" class="headerlink" title="1.切换：保业务还是保数据"></a>1.切换：保业务还是保数据</h2><blockquote>
<p>如何进行身份切换</p>
</blockquote>
<ul>
<li>停止备库同步</li>
<li>配置主库复制从库</li>
</ul>
<blockquote>
<p>可靠性优先策略</p>
</blockquote>
<ul>
<li>检查B库seconds_behind_master，不能过大</li>
<li>A库只读readonly&#x3D;true</li>
<li>检查seconds_behind_master&#x3D;0</li>
<li>B库关只读</li>
<li>B库停止复制A库，A库开始复制B库</li>
</ul>
<blockquote>
<ul>
<li>数据无丢失</li>
<li>有几秒的世界两个数据库均不可写</li>
<li>若一开始未检查seconds_behind_master，那么不可用时间无法控制</li>
</ul>
</blockquote>
<blockquote>
<p>可用性优先策略</p>
</blockquote>
<ul>
<li>取消等待数据一致的过程</li>
<li>A库只读，B库关只读</li>
<li>B库停止复制A库，A库开始复制B库</li>
</ul>
<blockquote>
<ul>
<li>系统没有不可写的时间</li>
<li>若切换时还有未重放的relay log</li>
<li>可能造成数据不一致</li>
</ul>
</blockquote>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>普通业务执行时，尽量用可靠性优先策略</li>
<li>日志、流水等不太需要数据可靠性的，用可用性优先策略</li>
</ul>
<h2 id="2-数据库切换了，业务怎么办？"><a href="#2-数据库切换了，业务怎么办？" class="headerlink" title="2.数据库切换了，业务怎么办？"></a>2.数据库切换了，业务怎么办？</h2><blockquote>
<p>业务切换至新地址</p>
</blockquote>
<ul>
<li>业务预留接口，通知新的数据库地址</li>
<li>使用微服务框架通知业务</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7hznk.png" alt="image-20230109165757677"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7i2pl.png" alt="image-20230109170250039"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7i33q.png" alt="image-20230109170156262"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7i9gr.png" alt="image-20230109170527613"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7i8x8.png" alt="image-20230109170631305"></p>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>业务切换至新地址：不影响性能，业务可能不支持</li>
<li>使用内部DNS：方便，需要多余的硬件资源</li>
<li>VIP漂移：自动漂移，需要多余的IP资源</li>
<li>使用代理：自动更新，需要多余的资源</li>
<li>dble：客户端无感知，需要被动通知</li>
</ul>
<h2 id="3-如何实现自动主从切换？"><a href="#3-如何实现自动主从切换？" class="headerlink" title="3.如何实现自动主从切换？"></a>3.如何实现自动主从切换？</h2><blockquote>
<p>keepalived</p>
</blockquote>
<ul>
<li>常见的高可用组件</li>
<li>可以检测节点状态</li>
<li>自动执行切换脚本</li>
<li>还有VIP漂移功能</li>
</ul>
<blockquote>
<p>MHA(Master high Availability)</p>
</blockquote>
<ul>
<li>常用的MySQLl高可用组件</li>
<li>支持GTID</li>
<li>binlog来不及传送时会尝试登录A库传送binlog</li>
<li>不能自动漂移VIP</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7iaj3.png" alt="image-20230109171938860"></p>
<ul>
<li>从宕机奔溃的master抢救未传送的binlog</li>
<li>等待Slave执行中继日志，追赶Master</li>
<li>在Slave执行从Master抢救除的binlog</li>
<li>提升一个Slave为Master</li>
<li>使用其他的Slave连接新的Master进行连接</li>
</ul>
<blockquote>
<p>自研高可用组件</p>
</blockquote>
<ul>
<li>完全自主控制</li>
<li>研发代价高</li>
</ul>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>Keepalived可以自动切换身份，但是并不完善</li>
<li>MHA是较为完善的MySQL自动身份切换工具</li>
<li>若有更高级的MySQL管理需求，可以二次开发MHA或者自己开发高可用中间件</li>
</ul>
<h2 id="4-MHA自动主从切换实战"><a href="#4-MHA自动主从切换实战" class="headerlink" title="4.MHA自动主从切换实战"></a>4.MHA自动主从切换实战</h2><ul>
<li>下载</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在github下载mha4mysql-manager-0.58-0.el7.centos.noarch.rpm，mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span></span><br><span class="line"><span class="comment"># 全部装node，从节点装manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 先安装依赖，之后就可以安装mha了</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line">yum install perl-DBD-MySQL</span><br><span class="line">yum install perl-Config-Tiny</span><br><span class="line">yum install perl-Log-Dispatch</span><br><span class="line">yum install perl-Parallel-ForkManager</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置免密</span></span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span>  <span class="comment"># 配置可以使用秘钥登录</span></span><br><span class="line">PermitRootLogin <span class="built_in">yes</span>       <span class="comment"># 允许root账户在远程登录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在/root/.ssh目录下，执行ssh-keygen后，生成了两个文件：id_rsa.pub(公钥) 和 id_rsa(私 钥)</span></span><br><span class="line">ssh-keygen  <span class="comment"># 生成秘钥</span></span><br><span class="line">chomd 600 ~/.ssh/know_hosts</span><br><span class="line">scp -r .ssh 从节点ip   <span class="comment"># 发送秘钥给其他主机</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写配置文件</span></span><br><span class="line">vim mda.cnf  <span class="comment"># 随便写</span></span><br><span class="line"><span class="comment">############ 文件内容 #############</span></span><br><span class="line">[server default]</span><br><span class="line">user=root</span><br><span class="line">password=123456</span><br><span class="line">manager_log=/var/log/masterha/app1/app1.<span class="built_in">log</span></span><br><span class="line">remote_workdir=/var/log/masterha/app1</span><br><span class="line"></span><br><span class="line"><span class="comment"># master主机</span></span><br><span class="line">[server1]</span><br><span class="line">hostname=192.168.19.199</span><br><span class="line"><span class="comment">#########################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查免密登录</span></span><br><span class="line">masterha_check_ssh --conf /etc/mda.cnf</span><br><span class="line"><span class="comment"># 检查主从复制</span></span><br><span class="line">masterha_check_repl --conf /etc/mda.cnf</span><br><span class="line"><span class="comment"># 检查mda运行状态</span></span><br><span class="line">masterha_check_status --conf /etc/mda.cnf</span><br><span class="line"><span class="comment"># 开启mda</span></span><br><span class="line">masterha_manager  --conf /etc/mda.cnf &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li>从dble官方下载联动脚本配置到MHA manager上即可</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7il7a.png" alt="image-20230110180546772"></p>
<h2 id="5-高可用了，集群为什么还会挂？"><a href="#5-高可用了，集群为什么还会挂？" class="headerlink" title="5.高可用了，集群为什么还会挂？"></a>5.高可用了，集群为什么还会挂？</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7iy62.png" alt="image-20230110182006138"></p>
<h1 id="第十一章：未来的数据库怎么样"><a href="#第十一章：未来的数据库怎么样" class="headerlink" title="第十一章：未来的数据库怎么样"></a>第十一章：未来的数据库怎么样</h1><h2 id="1-MySQL-8-0体验什么新特性？"><a href="#1-MySQL-8-0体验什么新特性？" class="headerlink" title="1.MySQL 8.0体验什么新特性？"></a>1.MySQL 8.0体验什么新特性？</h2><blockquote>
<p>窗口函数(Window Function)</p>
</blockquote>
<ul>
<li><p>以某个列为分隔，分为多个”窗口”</p>
</li>
<li><p>在窗口内执行特定函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7i8oq.png" alt="image-20230110091621562"></p>
</li>
</ul>
<blockquote>
<p>隐藏索引</p>
</blockquote>
<ul>
<li>暂时隐藏某个索引</li>
<li>可以通过隐藏和显示索引，来测试索引的作用</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7i5ly.png" alt="image-20230110091745302"></p>
<blockquote>
<p>降序排序</p>
</blockquote>
<ul>
<li><p>8.0之前只有升序索引</p>
</li>
<li><p>对于很多本来能走索引覆盖的语句，升序索引无法覆盖</p>
</li>
<li><p>降序索引解决了此问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7i6av.png" alt="image-20230110091946800"></p>
</li>
</ul>
<blockquote>
<p>通用表表达式(Common Table Expressions)</p>
</blockquote>
<ul>
<li><p>使用CTE表达式预先定义可以复杂语句中反复使用的中间结果</p>
</li>
<li><p>CTE可以认为是一个临时视图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7id07.png" alt="image-20230110092245790"></p>
</li>
</ul>
<blockquote>
<p>UTF-8编码</p>
</blockquote>
<ul>
<li>utf8mb4作为MySQL的默认字符集</li>
</ul>
<blockquote>
<p>DDL事务</p>
</blockquote>
<ul>
<li>8.0支持DDL事务，元数据操作可以回滚</li>
</ul>
<h2 id="2-数据库有哪些分类"><a href="#2-数据库有哪些分类" class="headerlink" title="2.数据库有哪些分类"></a>2.数据库有哪些分类</h2><blockquote>
<p>按用途分</p>
</blockquote>
<ul>
<li>OLTP(Online Transaction Processing)<ul>
<li>在线事务处理处理</li>
<li>SQL语句不复杂，大都处于事务中</li>
<li>并发量大，对可用性要求高</li>
<li>MySQL&#x2F;PostgreSQL</li>
</ul>
</li>
<li>OLAP(Online Analytical Processing)<ul>
<li>在线分析处理系统</li>
<li>SQL语句复杂、数据量大</li>
<li>一般以单个事务为单位</li>
<li>Hive&#x2F;SparkSQL&#x2F;GreenPlum</li>
</ul>
</li>
<li>HTAP(Hybrid Transaction&#x2F;Analytical Processing)<ul>
<li>混合事务&#x2F;分析处理</li>
<li>混合了两种数据库的特点。实现一种架构多功能</li>
</ul>
</li>
</ul>
<blockquote>
<p>按存储形式分类</p>
</blockquote>
<ul>
<li>行存</li>
<li>列存</li>
<li>KV</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7ih0z.png" alt="image-20230110094428979"></p>
<blockquote>
<p>按架构分类</p>
</blockquote>
<ul>
<li><p>Shared-Everything</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7igzi.png" alt="image-20230110094605451" style="zoom:50%;" />
</li>
<li><p>Shared-Memory</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7ih05.png" alt="image-20230110094641207" style="zoom:50%;" />
</li>
<li><p>Shared-Disk</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7ifrj.png" alt="image-20230110094828635" style="zoom:50%;" />
</li>
<li><p>Shared-Noting</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7id2v.png" alt="image-20230110094940723" style="zoom:50%;" /></li>
</ul>
<h2 id="3-谁是单体数据库之王？"><a href="#3-谁是单体数据库之王？" class="headerlink" title="3.谁是单体数据库之王？"></a>3.谁是单体数据库之王？</h2><blockquote>
<p>PostgreSQL</p>
</blockquote>
<ul>
<li>与MySQL类似的功能</li>
<li>性能更好、更稳定</li>
<li>代码质量更高</li>
<li>有超赶MySQL的趋势</li>
<li>自带分库分表中间件</li>
</ul>
<blockquote>
<p>PostGres-XL(OLTP)</p>
</blockquote>
<ul>
<li>GTM管理每个事务的执行</li>
<li>Coordinator解析SQL，制定执行计划，然后分发</li>
<li>DataNode返回执行结果到Coordinator</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7ie5h.png" alt="image-20230110095444606"></p>
<blockquote>
<p>GreenPlum(OLAP)</p>
</blockquote>
<ul>
<li>高性能SQL优化器:GPORCA</li>
<li>Slice执行模式</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7igzp.png" alt="image-20230110095657520"></p>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>PostgreSQL是一个开源完全代替MySQL的高性能数据库</li>
<li>Postgres-XL时基于Postgres的分布式事务集群</li>
<li>GreenPlum时基于Postgres的分布式分析集群</li>
</ul>
<h2 id="4-MySQL能魔改成什么样？"><a href="#4-MySQL能魔改成什么样？" class="headerlink" title="4.MySQL能魔改成什么样？"></a>4.MySQL能魔改成什么样？</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7ipnx.png" alt="image-20230110100254609"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7im55.png" alt="image-20230110100714890"></p>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>PloarDB对MySQL进行了魔改</li>
<li>采用了共享存储的架构</li>
<li>将三种log简化为redo log一种</li>
</ul>
<h2 id="5-国产数据库"><a href="#5-国产数据库" class="headerlink" title="5.国产数据库"></a>5.国产数据库</h2><blockquote>
<p>TiDB</p>
</blockquote>
<ul>
<li>一键水平扩容或者缩容</li>
<li>金融级高可用</li>
<li>实时HTAP</li>
<li>云原生的分布式数据库</li>
<li>兼容MySQL5.7协议和MySQL生态</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/AYO-Al/images/image/w7iqkv.png" alt="image-20230110102635180"></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">AYO</div><div class="post-copyright__author_desc">天行健，君子以自强不息</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://ayo-al.github.io/2022/11/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E4%B8%89%E9%AB%98%E6%95%B0%E6%8D%AE%E5%BA%93/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://ayo-al.github.io/2022/11/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E4%B8%89%E9%AB%98%E6%95%B0%E6%8D%AE%E5%BA%93/')">三高MySQL</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://ayo-al.github.io/2022/11/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E4%B8%89%E9%AB%98%E6%95%B0%E6%8D%AE%E5%BA%93/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=三高MySQL&amp;url=https://ayo-al.github.io/2022/11/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E4%B8%89%E9%AB%98%E6%95%B0%E6%8D%AE%E5%BA%93/&amp;pic=https://th.bing.com/th/id/OIP.IV7LvR2MoBb3y-EKG9uAJAHaEK?rs=1&amp;pid=ImgDetMain&amp;_r_=f928203e-103d-7086-6e45-a5d8e527fe19" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://AYO-Al.github.io" target="_blank">AYO</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Database/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Database<span class="tagsPageCount">8</span></a><a class="post-meta__box__tags" href="/tags/MySQL/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>MySQL<span class="tagsPageCount">6</span></a><a class="post-meta__box__tags" href="/tags/%E4%B8%89%E9%AB%98MySQL/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>三高MySQL<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://pic1.zhimg.com/v2-37d1dd62d373427b8035891e9fe1653e_r.jpg?source=1940ef5c&amp;_r_=473713bd-ddc1-d78f-f280-fb1932b1cb7b" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/09/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://th.bing.com/th/id/R.d8dfd08893b58d08d74b38ad8870a48d?rik=9KBqff6Rai035Q&amp;riu=http%3A%2F%2Fstatic.cntonan.com%2Fuploadfile%2F2019%2F0214%2F20190214104244pwm1xxsdikh.jpg&amp;ehk=MOxI2n5nY44gO%2FKsNYWAuEBvcRwSmkRVNb4dTS6Gk%2BY%3D&amp;risl=&amp;pid=ImgRaw&amp;r=0&amp;_r_=bb5cc2c0-7306-1b54-3050-4d9c89f3dc9b" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL基础</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/(%E8%BD%AC)mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-37d1dd62d373427b8035891e9fe1653e_r.jpg?source=1940ef5c&amp;_r_=521d6811-116a-db7c-bf41-927a170ea615" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL主从复制</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2022/12/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/(%E8%BD%AC)mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/" title="MySQL主从复制"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-37d1dd62d373427b8035891e9fe1653e_r.jpg?source=1940ef5c&_r_=521d6811-116a-db7c-bf41-927a170ea615" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-12-23</div><div class="title">MySQL主从复制</div></div></a></div><div><a href="/2022/09/23/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql/" title="MySQL基础"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://th.bing.com/th/id/R.d8dfd08893b58d08d74b38ad8870a48d?rik=9KBqff6Rai035Q&riu=http%3A%2F%2Fstatic.cntonan.com%2Fuploadfile%2F2019%2F0214%2F20190214104244pwm1xxsdikh.jpg&ehk=MOxI2n5nY44gO%2FKsNYWAuEBvcRwSmkRVNb4dTS6Gk%2BY%3D&risl=&pid=ImgRaw&r=0&_r_=bb5cc2c0-7306-1b54-3050-4d9c89f3dc9b" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-09-23</div><div class="title">MySQL基础</div></div></a></div><div><a href="/2023/01/17/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MySQL8.0/" title="MySQL"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic4.zhimg.com/v2-c2b3eb3319d52218753d0ce20bc7c100_r.jpg?_r_=d4f88b00-3875-cc60-9032-7da1117066a4" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-01-17</div><div class="title">MySQL</div></div></a></div><div><a href="/2023/04/11/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E9%9A%8F%E7%AC%94/MySQL%E4%B8%AD%E5%85%B3%E4%BA%8E%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4%E8%BF%87%E7%A8%8B%E6%A0%87%E5%BF%97%E4%BD%8D%E5%8F%98%E5%8C%96/" title="MySQL自动提交"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.zhimg.com/v2-264805954c1f033af43e006cb826ab60_r.jpg?source=1940ef5c&_r_=0e28cbbf-e4bb-060b-7561-58f145d19fa2" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-11</div><div class="title">MySQL自动提交</div></div></a></div><div><a href="/2024/06/20/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Linux/ELK%E6%97%A5%E5%BF%97%E5%B9%B3%E5%8F%B0/" title="ELK"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-37d1dd62d373427b8035891e9fe1653e_r.jpg?source=1940ef5c&_r_=473713bd-ddc1-d78f-f280-fb1932b1cb7b" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-20</div><div class="title">ELK</div></div></a></div><div><a href="/2022/08/20/MarkDown/%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis-trib.rb/" title="Redis-trib"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-0cc45f5fda6e8ff79350ec1303835629_r.jpg?source=1940ef5c&_r_=a06c3f86-bde0-8983-3a4a-fdf7f9b02a92" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-08-20</div><div class="title">Redis-trib</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);"><b style="color:#fff">AYO的知识输出基地，</b><b style="color:#fff">以输出倒逼输入，以输出巩固知识！</b></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">AYO</h1><div class="author-info__desc">天行健，君子以自强不息</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/AYO-Al" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://juejin.cn/user/3708003152300183" target="_blank" title="JueJin"><i class="anzhiyufont anzhiyu-icon-book"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0%EF%BC%9A%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">第一章：介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1.概述</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9ASQL%E8%AF%AD%E5%8F%A5%E6%98%AF%E8%BF%99%E6%A0%B7%E6%89%A7%E8%A1%8C%E7%9A%84"><span class="toc-number">2.</span> <span class="toc-text">第二章：SQL语句是这样执行的</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%BD%AF%E4%BB%B6%E7%BB%8F%E5%85%B8%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">1.软件经典架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-MYSQL%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">2.2.</span> <span class="toc-text">2.MYSQL软件架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8Emysql%E7%9A%84%E8%BF%9E%E6%8E%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">3.客户端与mysql的连接方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%B8%80%E4%B8%AASQL%E8%AF%AD%E5%8F%A5%E6%97%B6%E6%80%8E%E4%B9%88%E6%89%A7%E8%A1%8C%E7%9A%84"><span class="toc-number">2.4.</span> <span class="toc-text">4.一个SQL语句时怎么执行的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-MYSQL%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">2.5.</span> <span class="toc-text">5.MYSQL存储引擎</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E5%A6%82%E4%BD%95%E5%BB%BA%E8%A1%A8%E6%9B%B4%E7%AC%A6%E5%90%88%E4%B8%9A%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">第三章：如何建表更符合业务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%B4%A2%E5%BC%95%E7%BB%84%E7%BB%87%E8%A1%A8"><span class="toc-number">3.1.</span> <span class="toc-text">1.索引组织表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%B4%A2%E5%BC%95%E6%89%80%E4%BD%BF%E7%94%A8%E7%9A%84%E7%9A%84%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">2.索引所使用的的算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-InnoDB%E7%B4%A2%E5%BC%95"><span class="toc-number">3.3.</span> <span class="toc-text">3.InnoDB索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-InnoDB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">3.4.</span> <span class="toc-text">4.InnoDB数据存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-InnoDB%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A1%8C"><span class="toc-number">3.5.</span> <span class="toc-text">5.InnoDB的数据行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-InnoDB%E8%A1%8C%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.6.</span> <span class="toc-text">6.InnoDB行记录格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%B4%A2%E5%BC%95%E6%9C%89%E5%93%AA%E4%BA%9B%E2%80%9C%E5%B7%A6%E4%BE%A7%E7%94%A8%E6%B3%95%E2%80%9D"><span class="toc-number">3.7.</span> <span class="toc-text">7.索引有哪些“左侧用法”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%A6%82%E4%BD%95%E7%BA%A6%E6%9D%9F%E6%95%B0%E6%8D%AE"><span class="toc-number">3.8.</span> <span class="toc-text">8.如何约束数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">3.9.</span> <span class="toc-text">9.如何使用不存在的数据表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E8%BF%99%E4%B9%88%E6%9F%A5%E8%AF%A2%E9%80%9F%E5%BA%A6%E6%9B%B4%E5%BF%AB"><span class="toc-number">4.</span> <span class="toc-text">第四章：这么查询速度更快</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-where%E6%9F%A5%E8%AF%A2%E5%A4%AA%E6%85%A2%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">4.1.</span> <span class="toc-text">1.where查询太慢怎么办</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">1.1.覆盖索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E8%A7%A3%E9%87%8A%E8%AF%A6%E6%83%85"><span class="toc-number">4.1.2.</span> <span class="toc-text">*索引解释详情</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%89%E6%9B%B4%E5%90%88%E9%80%82%E7%9A%84%E7%B4%A2%E5%BC%95%E4%B8%8D%E8%B5%B0%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">4.2.</span> <span class="toc-text">2.有更合适的索引不走，怎么办？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E7%94%A8%E9%82%A3%E6%9D%A1%E7%B4%A2%E5%BC%95"><span class="toc-number">4.2.1.</span> <span class="toc-text">2.1.如何确定用那条索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%BC%BA%E5%88%B6%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.2.强制使用索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%BC%98%E5%8C%96%E7%B4%A2%E5%BC%95"><span class="toc-number">4.2.3.</span> <span class="toc-text">2.3.优化索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Count%E8%BF%99%E4%B9%88%E6%85%A2%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">4.3.</span> <span class="toc-text">3.Count这么慢，怎么办</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-ORDER-BY%E8%BF%99%E4%B9%88%E6%85%A2%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">4.4.</span> <span class="toc-text">4.ORDER BY这么慢，怎么办</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%9A%8F%E6%9C%BA%E9%80%89%E5%8F%96%E8%BF%99%E4%B9%88%E6%85%A2%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">4.5.</span> <span class="toc-text">5.随机选取这么慢，怎么办</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%B8%A6%E5%A4%B4%E5%A4%A7%E5%93%A5%E4%B8%A2%E4%BA%86%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">4.6.</span> <span class="toc-text">6.带头大哥丢了，怎么办</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8"><span class="toc-number">4.6.1.</span> <span class="toc-text">6.1.索引下推</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%9D%BE%E6%95%A3%E7%B4%A2%E5%BC%95%E6%89%AB%E6%8F%8F"><span class="toc-number">4.6.2.</span> <span class="toc-text">6.2.松散索引扫描</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%98%8E%E6%98%8E%E6%9C%89%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%B8%8D%E8%B5%B0%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">4.7.</span> <span class="toc-text">7.明明有索引，就是不走，怎么办</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E%E6%95%B0%E5%AD%97%E6%AF%94%E8%BE%83"><span class="toc-number">4.7.1.</span> <span class="toc-text">7.1.字符串与数字比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E9%9A%90%E5%BC%8F%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">4.7.2.</span> <span class="toc-text">7.2.隐式字符编码转换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E8%BF%99%E4%B9%88%E6%85%A2%EF%BC%8C%E8%BF%99%E4%B9%88%E5%8A%9E"><span class="toc-number">4.8.</span> <span class="toc-text">8.分页查询这么慢，这么办</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%80%BB%E7%BB%93"><span class="toc-number">4.9.</span> <span class="toc-text">9.总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0"><span class="toc-number">5.</span> <span class="toc-text">第五章：如何处理数据更新</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E2%80%9D%E5%8A%A8%E8%B5%B7%E6%9D%A5%E2%80%9D%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88"><span class="toc-number">5.1.</span> <span class="toc-text">1. 数据库”动起来”之后，会发生什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BB%80%E4%B9%88%E6%97%A5%E5%BF%97%E4%B8%8D%E6%98%AF%E7%BB%99%E4%BA%BA%E7%9C%8B%E7%9A%84"><span class="toc-number">5.2.</span> <span class="toc-text">2.什么日志不是给人看的</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-binlog-%E5%BD%92%E6%A1%A3%E6%97%A5%E5%BF%97"><span class="toc-number">5.2.1.</span> <span class="toc-text">2.1.binlog 归档日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-undo-log-%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97"><span class="toc-number">5.2.2.</span> <span class="toc-text">2.2.undo log 回滚日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-redo-log-%E9%87%8D%E5%81%9A%E6%97%A5%E5%BF%97"><span class="toc-number">5.2.3.</span> <span class="toc-text">2.3.redo log 重做日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">5.3.</span> <span class="toc-text">3.数据更新流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-redo-log-%E5%88%B7%E7%9B%98"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.1.redo log 刷盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-binlog-%E5%88%B7%E7%9B%98"><span class="toc-number">5.3.2.</span> <span class="toc-text">3.2.binlog 刷盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-number">5.3.3.</span> <span class="toc-text">3.3.持久化分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%94%81%EF%BC%9A%E6%80%8E%E6%A0%B7%E5%B9%B3%E8%A1%A1%E5%8A%9F%E8%83%BD%E4%B8%8E%E6%80%A7%E8%83%BD"><span class="toc-number">5.4.</span> <span class="toc-text">4.锁：怎样平衡功能与性能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%BA%8B%E5%8A%A1%EF%BC%9AInnoDB%E7%9A%84%E6%9D%80%E6%89%8B%E9%94%8F"><span class="toc-number">5.5.</span> <span class="toc-text">5.事务：InnoDB的杀手锏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">5.6.</span> <span class="toc-text">6.隔离级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-MVCC%E6%98%AF%E6%80%8E%E6%A0%B7%E5%81%9A%E5%88%B0%E5%8D%83%E4%BA%BA%E5%8D%83%E9%9D%A2%E7%9A%84"><span class="toc-number">5.7.</span> <span class="toc-text">7.MVCC是怎样做到千人千面的</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%BF%AB%E7%85%A7%E8%AF%BB-%E4%B8%80%E8%87%B4%E6%80%A7%E9%9D%9E%E9%94%81%E5%AE%9A%E8%AF%BB"><span class="toc-number">5.7.1.</span> <span class="toc-text">7.1.快照读(一致性非锁定读)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%BD%93%E5%89%8D%E8%AF%BB-%E4%B8%80%E8%87%B4%E6%80%A7%E9%94%81%E5%AE%9A%E8%AF%BB"><span class="toc-number">5.7.2.</span> <span class="toc-text">7.2.当前读(一致性锁定读)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%9A%94%E7%A6%BB%E9%97%AE%E9%A2%98"><span class="toc-number">5.8.</span> <span class="toc-text">8.隔离问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%B9%BB%E8%AF%BB%E9%97%AE%E9%A2%98"><span class="toc-number">5.8.1.</span> <span class="toc-text">8.1.如何解决幻读问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E9%97%B4%E9%9A%99%E9%94%81%E6%8A%8A%E5%85%A8%E8%A1%A8%E9%83%BD%E9%94%81%E4%BD%8F%E4%BA%86%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">5.9.</span> <span class="toc-text">9.间隙锁把全表都锁住了，怎么办</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-MySQL%E4%B9%9F%E6%9C%89%E2%80%9D%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E2%80%9D%E5%98%9B"><span class="toc-number">5.10.</span> <span class="toc-text">10.MySQL也有”垃圾回收”嘛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-%E8%84%8F%E9%A1%B5"><span class="toc-number">5.10.1.</span> <span class="toc-text">10.1.脏页</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E9%95%BF%E4%BA%8B%E5%8A%A1%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8D%B1%E5%AE%B3"><span class="toc-number">5.11.</span> <span class="toc-text">11.长事务有哪些危害</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9AORM%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">第六章：ORM框架原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ORM%E5%9F%BA%E7%A1%80"><span class="toc-number">6.1.</span> <span class="toc-text">1.ORM基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ORM%E6%A1%86%E6%9E%B6%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%BE%E8%AE%A1%E7%9A%84"><span class="toc-number">6.2.</span> <span class="toc-text">2.ORM框架是怎么设计的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ORM%E6%A1%86%E6%9E%B6%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">6.3.</span> <span class="toc-text">3.ORM框架有哪些常见问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E6%80%8E%E4%B9%88%E7%BB%99%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BF%9D%E9%99%A9"><span class="toc-number">7.</span> <span class="toc-text">第七章：怎么给数据上保险</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%89%E5%93%AA%E4%BA%9B%E7%A7%8D%E7%B1%BB%E7%9A%84%E5%A4%87%E4%BB%BD%EF%BC%9F"><span class="toc-number">7.1.</span> <span class="toc-text">1.数据库有哪些种类的备份？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8OUTFILE%E5%91%BD%E4%BB%A4%E5%A4%87%E4%BB%BD"><span class="toc-number">7.2.</span> <span class="toc-text">2.使用OUTFILE命令备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8mysqldump%E8%BF%9B%E8%A1%8C%E5%A4%87%E4%BB%BD"><span class="toc-number">7.3.</span> <span class="toc-text">3.使用mysqldump进行备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8mysqldump%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD"><span class="toc-number">7.4.</span> <span class="toc-text">4.如何使用mysqldump增量备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8XtraBackup%E7%89%A9%E7%90%86%E5%A4%87%E4%BB%BD"><span class="toc-number">7.5.</span> <span class="toc-text">5.使用XtraBackup物理备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-ibbackup%E4%B8%8EXtraBackup"><span class="toc-number">7.6.</span> <span class="toc-text">6.ibbackup与XtraBackup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-MySQL%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7%E5%A6%82%E4%BD%95%E6%8C%87%E5%AF%BC%E6%88%91%E4%BB%AC%E7%9A%84%E5%88%9B%E6%96%B0"><span class="toc-number">7.7.</span> <span class="toc-text">7.MySQL备份工具如何指导我们的创新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%A6%82%E4%BD%95%E9%98%B2%E6%82%A3%E4%BA%8E%E6%9C%AA%E7%84%B6"><span class="toc-number">7.8.</span> <span class="toc-text">8.如何防患于未然</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0%EF%BC%9A%E2%80%9D%E4%B8%89%E9%AB%98%E6%A1%86%E6%9E%B6%E2%80%9D%E5%9F%BA%E7%A1%80"><span class="toc-number">8.</span> <span class="toc-text">第八章：”三高框架”基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%A4%8D%E5%88%B6%E6%9C%89%E5%93%AA%E4%BA%9B%E7%B1%BB%E5%9E%8B%EF%BC%9F"><span class="toc-number">8.1.</span> <span class="toc-text">1.复制有哪些类型？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">8.2.</span> <span class="toc-text">2.主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88binlog%E6%A0%BC%E5%BC%8F%E4%BC%9A%E5%BD%B1%E5%93%8D%E5%A4%8D%E5%88%B6%EF%BC%9F"><span class="toc-number">8.3.</span> <span class="toc-text">3.为什么binlog格式会影响复制？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%A4%87%E5%BA%93%E5%BB%B6%E8%BF%9F%E5%A4%AA%E5%A4%A7%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">8.4.</span> <span class="toc-text">4.备库延迟太大，怎么办？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%A6%82%E4%BD%95%E5%9C%A8%E5%A4%87%E5%BA%93%E8%AF%BB%E5%88%B0%E6%9C%80%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="toc-number">8.5.</span> <span class="toc-text">5.如何在备库读到最新数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%8E%E6%A0%B7%E5%AE%9E%E7%8E%B0%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">8.6.</span> <span class="toc-text">6.怎样实现最简单的高可用架构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%AE%B9%E9%87%8F%E4%B8%8D%E5%A4%9F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text">第九章：如何解决容量不够的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%80%8E%E6%A0%B7%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%89%A9%E5%B1%95%E5%AE%B9%E9%87%8F%EF%BC%9F"><span class="toc-number">9.1.</span> <span class="toc-text">1.怎样最简单的扩展容量？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%EF%BC%9F"><span class="toc-number">9.2.</span> <span class="toc-text">2.为什么要分库分表？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-dble%E6%AF%94MyCat%E5%BC%BA%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="toc-number">9.3.</span> <span class="toc-text">3.dble比MyCat强在哪？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8dble"><span class="toc-number">9.4.</span> <span class="toc-text">4.安装使用dble</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%8E%E6%A0%B7%E6%8F%90%E9%AB%98%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">9.5.</span> <span class="toc-text">5.怎样提高分库分表架构的可靠性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8B%E5%90%8E%E6%80%A7%E8%83%BD%E5%8F%8D%E8%80%8C%E4%B8%8B%E9%99%8D%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">9.6.</span> <span class="toc-text">6.分库分表之后性能反而下降，怎么办？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%8F%E5%B8%B8%E5%AE%95%E6%9C%BA%E9%97%AE%E9%A2%98"><span class="toc-number">10.</span> <span class="toc-text">第十章：如何解决数据库经常宕机问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%88%87%E6%8D%A2%EF%BC%9A%E4%BF%9D%E4%B8%9A%E5%8A%A1%E8%BF%98%E6%98%AF%E4%BF%9D%E6%95%B0%E6%8D%AE"><span class="toc-number">10.1.</span> <span class="toc-text">1.切换：保业务还是保数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%87%E6%8D%A2%E4%BA%86%EF%BC%8C%E4%B8%9A%E5%8A%A1%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">10.2.</span> <span class="toc-text">2.数据库切换了，业务怎么办？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2%EF%BC%9F"><span class="toc-number">10.3.</span> <span class="toc-text">3.如何实现自动主从切换？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-MHA%E8%87%AA%E5%8A%A8%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2%E5%AE%9E%E6%88%98"><span class="toc-number">10.4.</span> <span class="toc-text">4.MHA自动主从切换实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%AB%98%E5%8F%AF%E7%94%A8%E4%BA%86%EF%BC%8C%E9%9B%86%E7%BE%A4%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%98%E4%BC%9A%E6%8C%82%EF%BC%9F"><span class="toc-number">10.5.</span> <span class="toc-text">5.高可用了，集群为什么还会挂？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%EF%BC%9A%E6%9C%AA%E6%9D%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%8E%E4%B9%88%E6%A0%B7"><span class="toc-number">11.</span> <span class="toc-text">第十一章：未来的数据库怎么样</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MySQL-8-0%E4%BD%93%E9%AA%8C%E4%BB%80%E4%B9%88%E6%96%B0%E7%89%B9%E6%80%A7%EF%BC%9F"><span class="toc-number">11.1.</span> <span class="toc-text">1.MySQL 8.0体验什么新特性？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%89%E5%93%AA%E4%BA%9B%E5%88%86%E7%B1%BB"><span class="toc-number">11.2.</span> <span class="toc-text">2.数据库有哪些分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%B0%81%E6%98%AF%E5%8D%95%E4%BD%93%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E7%8E%8B%EF%BC%9F"><span class="toc-number">11.3.</span> <span class="toc-text">3.谁是单体数据库之王？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-MySQL%E8%83%BD%E9%AD%94%E6%94%B9%E6%88%90%E4%BB%80%E4%B9%88%E6%A0%B7%EF%BC%9F"><span class="toc-number">11.4.</span> <span class="toc-text">4.MySQL能魔改成什么样？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%9B%BD%E4%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">11.5.</span> <span class="toc-text">5.国产数据库</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/20/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Linux/ELK%E6%97%A5%E5%BF%97%E5%B9%B3%E5%8F%B0/" title="ELK"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-37d1dd62d373427b8035891e9fe1653e_r.jpg?source=1940ef5c&amp;_r_=473713bd-ddc1-d78f-f280-fb1932b1cb7b" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ELK"/></a><div class="content"><a class="title" href="/2024/06/20/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Linux/ELK%E6%97%A5%E5%BF%97%E5%B9%B3%E5%8F%B0/" title="ELK">ELK</a><time datetime="2024-06-19T16:00:00.000Z" title="发表于 2024-06-20 00:00:00">2024-06-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/01/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Nginx/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" title="Nginx反向代理配置"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic4.zhimg.com/v2-c2b3eb3319d52218753d0ce20bc7c100_r.jpg?_r_=59c67eb3-1e66-10f2-4c1c-74807c3426bc" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx反向代理配置"/></a><div class="content"><a class="title" href="/2024/06/01/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Nginx/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" title="Nginx反向代理配置">Nginx反向代理配置</a><time datetime="2024-05-31T16:00:00.000Z" title="发表于 2024-06-01 00:00:00">2024-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/27/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Nginx/Nginx-all/" title="Nginx模块"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-0cc45f5fda6e8ff79350ec1303835629_r.jpg?source=1940ef5c&amp;_r_=880d57ed-f1bf-075b-e231-b85fc3bec85b" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx模块"/></a><div class="content"><a class="title" href="/2024/05/27/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Nginx/Nginx-all/" title="Nginx模块">Nginx模块</a><time datetime="2024-05-26T16:00:00.000Z" title="发表于 2024-05-27 00:00:00">2024-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/22/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Linux/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%A3%81%E7%9B%98/" title="Linux文件系统与磁盘"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-0cc45f5fda6e8ff79350ec1303835629_r.jpg?source=1940ef5c&amp;_r_=a98579fb-4af2-5190-eaf8-83fef0b162d6" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux文件系统与磁盘"/></a><div class="content"><a class="title" href="/2024/05/22/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Linux/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%A3%81%E7%9B%98/" title="Linux文件系统与磁盘">Linux文件系统与磁盘</a><time datetime="2024-05-21T16:00:00.000Z" title="发表于 2024-05-22 00:00:00">2024-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/11/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Linux/%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://th.bing.com/th/id/R.4cb70989991c1861426358cb196b6d01?rik=83OmAlSQSFM51Q&amp;riu=http%3A%2F%2Fpic.bizhi360.com%2Fbpic%2F88%2F9588_8.jpg&amp;ehk=Vc5LFstc1coz3liGA9YtX3SOl%2BcMJTlRfHNhk%2F4%2FA0w%3D&amp;risl=&amp;pid=ImgRaw&amp;r=0&amp;_r_=5ba5c960-eb8b-fc3b-39aa-2d0500c9eb21" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux防火墙"/></a><div class="content"><a class="title" href="/2024/05/11/MarkDown/%E4%BA%91%E8%AE%A1%E7%AE%97/Linux/%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙">Linux防火墙</a><time datetime="2024-05-10T16:00:00.000Z" title="发表于 2024-05-11 00:00:00">2024-05-11</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="/2609320892@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://regexlearn.com/zh-cn" title="Regex 101"><i class="anzhiyufont anzhiyu-icon-font"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://regexcrossword.com/" title="Regexcrossword"><i class="anzhiyufont anzhiyu-icon-bolt"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/AYO-Al" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://learngitbranching.js.org/?demo=&amp;locale=zh_CN" title="Learn Git"><i class="anzhiyufont anzhiyu-icon-pencil"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://www.drawio.com/" title="draw.io"><i class="anzhiyufont anzhiyu-icon-instagram"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="algolia" target="_blank" rel="noopener" href="https://www.algolia.com/">algolia</a><a class="footer-item" title="twikoo" target="_blank" rel="noopener" href="https://twikoo.js.org/">twikoo</a><a class="footer-item" title="vercel" target="_blank" rel="noopener" href="https://vercel.com/">vercel</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" target="_blank" rel="noopener" href="https://docs.anheyu.com/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a><a class="footer-item" title="更新日志" target="_blank" rel="noopener" href="https://blog.anheyu.com/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v7.0.0" title="博客框架为Hexo_v7.0.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v7.0.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2021 - 2024 By <a class="footer-bar-link" href="/" title="AYO" target="_blank">AYO</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["生活明朗&#44; 万物可爱&#44; 人间值得&#44; 未来可期."]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.0.15/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/AYO-Al/AYO-Al.github.io" title="博客">博客</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/AYO-Al" title="本站项目由GitHub托管">本站项目由GitHub托管</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">8</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://git.yuki.love/" title="AYO网站"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="AYO网站"/><span class="back-menu-item-text">AYO网站</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3708003152300183" title="AYO博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="AYO博客"/><span class="back-menu-item-text">AYO博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/AYO-Al" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Ansible/" style="font-size: 0.88rem;">Ansible<sup>1</sup></a><a href="/tags/CDN/" style="font-size: 0.88rem;">CDN<sup>1</sup></a><a href="/tags/DNS/" style="font-size: 0.88rem;">DNS<sup>1</sup></a><a href="/tags/Database/" style="font-size: 0.88rem;">Database<sup>8</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>1</sup></a><a href="/tags/ELK/" style="font-size: 0.88rem;">ELK<sup>1</sup></a><a href="/tags/Flask/" style="font-size: 0.88rem;">Flask<sup>1</sup></a><a href="/tags/Httpd/" style="font-size: 0.88rem;">Httpd<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 0.88rem;">JavaScript<sup>1</sup></a><a href="/tags/Keepalived/" style="font-size: 0.88rem;">Keepalived<sup>1</sup></a><a href="/tags/LVS/" style="font-size: 0.88rem;">LVS<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>22</sup></a><a href="/tags/MLinux/" style="font-size: 0.88rem;">MLinux<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>6</sup></a><a href="/tags/Nginx/" style="font-size: 0.88rem;">Nginx<sup>3</sup></a><a href="/tags/Prometheus/" style="font-size: 0.88rem;">Prometheus<sup>1</sup></a><a href="/tags/Python/" style="font-size: 0.88rem;">Python<sup>8</sup></a><a href="/tags/Rabbit/" style="font-size: 0.88rem;">Rabbit<sup>1</sup></a><a href="/tags/Shell/" style="font-size: 0.88rem;">Shell<sup>3</sup></a><a href="/tags/Web/" style="font-size: 0.88rem;">Web<sup>2</sup></a><a href="/tags/Zabbix/" style="font-size: 0.88rem;">Zabbix<sup>2</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">中间件<sup>1</sup></a><a href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" style="font-size: 0.88rem;">主从复制<sup>1</sup></a><a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" style="font-size: 0.88rem;">云计算<sup>7</sup></a><a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 0.88rem;">反向代理<sup>1</sup></a><a href="/tags/%E5%9B%9B%E5%A4%A7%E4%BB%B6/" style="font-size: 0.88rem;">四大件<sup>2</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">开发<sup>7</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/" style="font-size: 0.88rem;">文件共享服务<sup>1</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">文件系统<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">日志管理<sup>1</sup></a><a href="/tags/%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/" style="font-size: 0.88rem;">时间同步<sup>1</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">服务管理<sup>1</sup></a><a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 0.88rem;">爬虫<sup>4</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 0.88rem;">监控<sup>3</sup></a><a href="/tags/%E7%A3%81%E7%9B%98/" style="font-size: 0.88rem;">磁盘<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">网络架构<sup>1</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/" style="font-size: 0.88rem;">自动化运维<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">软件管理<sup>1</sup></a><a href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 0.88rem;">防火墙<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"><a class="tag-list" href="/tags/Linux" title="Linux">Linux</a><a class="tag-list" href="/tags/Database" title="Database">Database</a><a class="tag-list" href="/tags/Kubernetes" title="Kubernetes">Kubernetes</a></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2021 By 安知鱼 V1.6.10",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 AYO 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.56.5/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.yuki.love',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.yuki.love',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: '',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.css')
      await getScript('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.js')
      initWaline()
    }
  }

  if ('Twikoo' === 'Waline' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.yuki.love',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "visitor@anheyu.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>